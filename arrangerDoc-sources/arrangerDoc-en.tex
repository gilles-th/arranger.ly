%%%%%% English Documentation of arranger.ly. Version YYYY/MM/DD = 2020/05/22 %%%%%%
%% To compile with : ConTeXt (LuaTex)
%% https://wiki.contextgarden.net/Main_Page



%\setupsynctex[state=start,method=min] : Don't work anymore !!!
\setuplayout[header=1cm, topspace=0.5cm, margin=0.5cm,  height=middle, width=middle]
%\showframe
%\showlayout
%\showsetups

\language[en] % english
\definebodyfontenvironment[default][em=italic]
\setupbodyfont[11pt]

\setuppagenumbering[location={footer}, left={-},right={-}]
\setuphead[title][align=center,style=bold, 
                  incrementnumber=yes,  % keep track of the number
                  number=no]
\setuphead[subject][textstyle={\bold},after=\nowhitespace, %
                            incrementnumber=yes,  % keep track of the number
                            number=no]
%\setuphead[section][after=\nowhitespace,before=\nowhitespace]  
\setuphead[subsection][before={\blank[-3.5em]}] %  \nowhitespace is not enough
                          
\setupitemize[before=\nowhitespace]

\setuplist[title][align=center,style=bold, alternative=a, pagenumber=no, before={\blank[0.9cm]}, after={\blank[0.3cm]}]
\setuplist[subject,chapter,subject,subsubject,section,subsection][alternative=c]
\setuplist[subsection][margin=1.5em]
%\setuplist[title][align=center,style=bold, alternative=a]
%\setupheadtext[content=Sommaire]
\setupcombinedlist[content][list={title,chapter,subject,subsubject,section,subsection}]


\def\lilyspace{0.7cm}
\definehspace[lilyindent][0.7cm]
\definehspace[threelilyindent][2.1cm]
\definetyping[lily][margin=\lilyspace, page=yes, escape={&,&}]
\definetyping[mylily][margin=\lilyspace, space=fixed, before=\nowhitespace, after=\nowhitespace, escape={&,&}]

\def\myindent{\hphantom{0}\hspace[lilyindent]}

\defineframed[noframed][frame=no]

%% URL
\useURL[chord][http://gillesth.free.fr/Lilypond/chordsAndVoices/]
\useURL[changePitch][http://gillesth.free.fr/Lilypond/changePitch/]
\useURL[copyArticulations][http://gillesth.free.fr/Lilypond/copyArticulations/]
\useURL[addAt][http://gillesth.free.fr/Lilypond/addAt/]
\useURL[extractMusic][http://gillesth.free.fr/Lilypond/extractMusic/]
\useURL[checkPitch][http://gillesth.free.fr/Lilypond/checkPitch/]
\useURL[copyArticulations-LSR][http://lsr.di.unimi.it/LSR/Item?id=769]
\setupinteraction[state=start,color=black,contrastcolor=black, style=\tf]

\setupexternalfigures[directory={exemples}]   % images (sub)directory

%%%%% function \syntax
\define[2]\syntax
{% display => syntax : #1 #2
\blank
\hbox{\hspace[lilyindent]{\em {\small $\triangleright$} syntax }{: }% 
\doifemptyelse{#2}%
{\inframed{\type{#1}}}%
{\vcenter\framed[location=middle, width=fit, height=fit]{%% \inframed doesn't center vertically :-(
\vtop{{\hbox{\type{#1}}}%
      {\hbox {\hspace[threelilyindent] {\ttsl \#:optional} \type{#2}}}}}}%
}%
\blank
}

%%%%% function \func
\define[1]\func
{ % display => The function #1
 %% \index{#1}   % <- #1 can end with character + which will not be displayed in index ! :-(
 %% (bad) workaround :
 \ctxlua{context.index((string.gsub("#1","+", "†")))}  %%  replace in index, any + character by †
                           %% Note the double parenthesis to force a single return value  of gsub
 \startsubsection[number=no,list=#1,reference=#1]{}
 %\startsubsubject[list=#1,reference=#1]{}   % don't work !
 {\switchtobodyfont[20pt] \checkmark} 
 {\sca the function \cap{\bf #1}}
 %\stopsubsubject
 \stopsubsection
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Start of document %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\starttext

%%%%%% Title page
\startstandardmakeup
\midaligned{\tfd\sc Arranger.ly}
\blank[2cm]
\midaligned{\tfd ---}
\stopstandardmakeup

\midaligned{\bf \underbar Contents}
\placecontent[criterium=all]
\title[generalites]{OVERVIEW}
\subject[objectifs]{Basic goals}
{\em arranger.ly provides an environment facilitating musical arrangement.} \footnote{To arrange
herein means to re-orchestrate an original instrumentation.} A set of functions enables quick
re-orchestration of a piece of music, using a minimal and reusable music encoding.
\blank[0.7em]
One of the main aspects of {\em arranger.ly} concerns the locating system of musical positions, which is  now based on {\em bar numbers}\footnote {Lilypond use a system based on {\em moment}s : \type{(ly:make-moment 5/4)} for example.}.The arranger's workflow is made more flexible : rather than entering music expressions instrument by instrument in a linear fashion, it becomes possible to work as the ideas go by -- first deal with the melody, then accompaniment,
then the bass, etc.
\blank[0.7em]
The user typically first declares a list of instruments. {\em arranger.ly} takes care of initializing
each instrument with empty measures. Then, in a single command, the user can insert a music fragment
in several instruments and positions, as well as \quotation{copy-paste} entire music sections in one
line of code.

Functions allow for octave transposing and octave doubling, specifying patterns for repeated rhythms or articulations, distributing the notes to various instruments in
a succession of chords, inverting chords,~\dots, so as never to repeat information.

All these functions can be directly used from Scheme, which makes for lighter syntax (no backslash before
variable names) and easier editing of instrument lists.

Once the arrangement is finished, it can be exported to usual LilyPond source:
\blank[0.3em]
\startmylily
flute = {…}
clar = {…}
…
\stopmylily
\godown[-0.3em]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subject{Software dependencies}
\startitemize[2,joinedup,intro]
\item You need LilyPond 2.19 or higher.
\item The file {\em arranger.ly} requires the following \type{include} files:
  \starttabulate[|l|l|,before={\blank[1mm]},after={\blank[1mm]}, indenting=yes]
    \NC {\textbullet \hspace[1] \em chordsAndVoices.ly} \NC\small {(\from[chord])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em changePitch.ly} \NC\small{ (\from[changePitch])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em copyArticulations.ly} \NC\small{(\from[copyArticulations])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em addAt.ly} \NC\small{(\from[addAt])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em extractMusic.ly} \NC\small{ (\from[extractMusic])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em checkPitch.ly} \NC\small{ (\from[checkPitch])} \NC
    \NR
  \stoptabulate 
\stopitemize

It is easiest to put these 6 files in the same folder alongside with {\em arranger.ly},
and call LilyPond with option \type{--include=myfolder}. Only the following line should then
be added at the top of one's \type{.ly} file:\\
\myindent\type{\include } \type{"arranger.ly"} % pbs d'espace avec \type{\include "arranger.ly"}
\godown[-0.3em] %\blank[-0.6cm]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subject{Two prerequisites to using the functions}
\startitemize[n]
\item Have all meter changes in a \type{\global} variable, e.g.:
\startmylily global = { \time 4/4 s1*2 \time 5/8 s8*5*2 \time 3/4 s2.*2 } \stopmylily
This enables {\em arranger.ly} to convert all measure numbers to LilyPond moments.
\item Use the \goto{\type{init}}[init] command described at \at{page}[init] to declare
instrument names to the parser. This needs to be placed before any call to the functions
described below.
\stopitemize
\page 
%%%%%%%%%%%%%%%%%

\subject{Conventions and reminders}
In this document, we shall call {\em instrument} any Scheme symbol referencing
a LilyPond music expression. The music an instrument points to has the same length
as \type{\global} and begins at the same time (by default, this is measure 1, with an
optional upbeat). However, in the following text, {\em music} more generally refers to
a fragment with indeterminate position, which can be inserted at any measure in the piece.

Being a symbol, an instrument is denoted in Scheme using a leading \hbox{single vertical
quote \type{'}}\\
\myindent ex : \type{'flute}\\
In running LilyPond input, it additionally needs to be prefixed with a hash sign \type{#} in order to be recognized as a Scheme expression.\\
\myindent ex : \type+#'flute+\\
The bare name \type{flute} in Scheme is equivalent to \type{\flute} in LilyPond.

In Scheme code, a list of instruments can be written as either

\startmylily '(flute oboe clarinet)\stopmylily

or

\startmylily(list 'flute 'oboe 'clarinet)\stopmylily

A list of music expressions is written as

\startmylily(list flute oboe clarinet)\stopmylily

or using a so-called \quotation{quasiquote}:

\startmylily 
`(,flute ,hautbois ,clarinette) ;&\em{& note the use of `( instead of '( &}&
\stopmylily
These lists can be manipulated with ease thanks to {\em arranger.ly}'s utility functions
(see \type{lst}, \type{flat-lst} and \type{zip}).
\blank[-0.6cm]                 
%%%%%%%%%%%%%%%%%%

\reference[init]{}
\index[init-info]{init}                   
\subject{Initialization}
- The \type{init} function must be called \emph{after} declaring \type{\global} and
\emph{before} any call to the other functions. It is passed a list of instruments and
an optional integer.

\syntax {(init instru-list}{measure1-number)}

Each instrument in the list is declared to LilyPond and filled in with multi-measure rests.

If \type{\global} was defined using:
\startlily
global = { s1*20 \time 5/8 s8*5*10 \bar "|."}
\stoplily
the following code:
\startlily
all = #'(flute clar sax tptte cor tbne basse)
#(init all)
\stoplily
is equivalent to
\startlily
flute = { R1*20 R8*5*10 } 
clar = { R1*20 R8*5*10 } 
sax = { R1*20 R8*5*10 } 
tptte = { R1*20 R8*5*10 } 
cor = { R1*20 R8*5*10 } 
tbne = { R1*20 R8*5*10 } 
basse = { R1*20 R8*5*10 }
\stoplily
\blank[0.8em]

- \type{instru-list} may be empty: \type{(init '())}. A noteworthy use case
is direct editing of the \type{\global} variable, as shown in \goto{addendum I}[addendum1]
at page \at{page}[addendum1].

Once all music events influencing the meter are declared in \type{\global}, \type{init}
can be called a second time with a non-empty instrument list.
\page
- To count measures, \type{init} takes into account manual overrides applied to properties
of the \type{Score} context and the \type{Timing} object, such as \type{measurePosition},
\type{measureLength}, \type{currentBarNumber}, as well a the \type{\partial}, \type{\cadenzaOn}
and \type{\cadenzaOff} command. If \type{\partial} is placed at the very beginning of the piece,
\type{init} even adds a rest with same duration as the pickup to all the instruments.

\setupcaptions[location=none]
\startfiguretext[right][exemple1]{}
{\vbox{\blank[-0.6em]\externalfigure[exemple01.pdf][wfactor=180, align=flushright]}}
\underbar{\sc\Words example 1}
\startlily[bodyfont=10pt]
global = { 
  \partial 4 s4
  s1*2
  %&\em{& measure &}&3&\em{& : only &}&2&\em{& beats&}&
  s4 \set Timing.measurePosition =
                  #(ly:make-moment 3/4)
     s4
  s1                    %&\em{& measure &}&4
  \set Score.currentBarNumber = #50
  %&\em{& \set Timing.currentBarNumber = #&}&50
  s1                    %&\em{& measure &}&50&\em{& !&}&
  \bar "|."  }
all = #'(flute clar sax tptte cor tbne basse)
#(init all)

\stoplily
\stopfiguretext

\index{measure-number->moment}
The internal function \type{measure-number->moment} may be used to ensure that
{\em arranger.ly} and {\em LilyPond} stay in sync. For example,
\startmylily
#(display (map measure-number->moment '(1 2 3 4 50)))
\stopmylily
prints the number of quarter notes elapsed from music start for measures 1, 2, 3, 4 and 50:
\startmylily
(#<Mom 1/4> #<Mom 5/4> #<Mom 9/4> #<Mom 11/4> #<Mom 15/4>)
\stopmylily
\blank[1em]  % crlf 
- The optional parameter \type{measure1-number}\crlf
\type{init} accepts an integer as optional last argument, indicating  the
numbering of the first measure. It defaults to 1. This is useful to add, say
3 measures of intro to the arrangement.
\startmylily 
(init all -2) 
\stopmylily
This automatically shifts all previously entered measure positions. In this case,
it is relevant while arranging to add
\startmylily
\set Score.currentBarNumber = #-2
\stopmylily
at the beginning of \type{\global}, and let \type{measure1-number} default to 1.
Then, once the arrangement is finished, this line can be removed while \type{measure1-number}
is set to -2.

From a general point of view, the following settings are useful while working:
\blank[1em]
\startmylily
tempSettings = { 
  \override Score.BarNumber.break-visibility = ##(#f #t #t)
  \override Score.BarNumber.font-size = #+2
  \set Score.barNumberVisibility = #all-bar-numbers-visible 
}
\stopmylily

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                     
\reference[rm-info]{}           
\subject{The basic function: \type{rm}}
%\label{rm}%
\type{rm} means \quotation{\underbar{r}eplace \underbar{m}usic}.
This function typically redefines an {\em instrument}, replacing part of
its existing music with the music fragment given as an argument.\crlf
\type{rm} is actually an extension of \type{\replaceMusic} from {\em extractMusic.ly}.
Optional reading is chapter~8 from this file's documentation at~:\crlf
\hbox{\hspace[lilyindent]\from[extractMusic]}
\page %%%%%%%%%%%%%%%%%%%%%%%%
Below is the syntax of \type{rm} :

\syntax{(rm obj where-pos repla}{repla-extra-pos obj-start-pos)}

- \type{obj} is $\left\{
\vcenter{%
\mbox{an {\em instrument}, e.g. \type{'flute }}
\mbox{a list of {\em instrument}s : \type{'(clar tpt sax)}}
\mbox{but may also be a {\em music} : \type{music or #{…#}} }
\mbox{or a list of {\em music}s : \type{(list musicA musicB musicC) }}
}
\right.$
\blank[medium]
- \type{where-pos} indicates the bar where replacement is performed. More precisely,
it is a  \startnarrower[left] {\em music position} as defined in the next paragraph (\at{page}[positions_musicales]).\stopnarrower

- \type{repla} is a {\em music} or a list of {\em music}s, but syntax with \type{quote '} is valid~:
\startnarrower[left] \type{'(musicA musicB musicC…)}.\stopnarrower

- \type{repla-extra-pos }and\type{ obj-start-pos } are {\em music positions} too  (read on).
\blank
{\hbox{\hspace[lilyindent]{\em {\small $\triangleright$} return }{: }}}
\blank
- If \type{obj} is an {\em instrument} or a {\em music}, \type{rm} returns the music
obtained after performing the \startnarrower[left] replacement. In the case of an {\em instrument}, this new value is automatically reassigned to the symbol representing it.\stopnarrower

- If \type{obj} is a list of {\em instrument}s or {\em music}s, \type{rm} returns the list of the obtained {\em music}s.
\blank[0.7cm]
\startfiguretext[right][exemple2]{}
{\vbox{\blank[-1.1em]\externalfigure[exemple02-en.pdf][wfactor=175, align=flushright]}}
\underbar{\sc\Words exemple 2}
\blank[0.7cm]
\startlily
global = { s1*4 \bar "|." } 
all = #'(fl cl sax tpt horn tbn bass) 
#(init all)

musA = \relative c' { e2 d c1 }
musB = { f1 e1 } 
musC = { g,1 c1 }

#(begin 
  (rm 'fl 1 #{ c'''1 #})
  (rm '(cl sax tpt) 2 #{ c''1 #}) 
  (rm '(horn tbn bass) 3 
                  '(musA musB musC)))
\stoplily %\blank[2.1cm]%
\stopfiguretext
\blank[0.7cm]
By default, the \type{rm} function accounts for the entire music given in \type{repla}.
It is however possible to take only a part of it by specifying the optional
parameter \type{repla-extra-pos}.\crlf
The principle is as follows:
\hairline
\type{repla} is positioned at the lowest position between \type{where-pos} and \type{repla-extra-pos} :
\definesymbol[5][$\rightarrow$]
\startitemize[5, joinedup, intro][margin=\lilyspace]
\item if \type{repla-extra-pos} is before \type{where-pos},
the part {[}\type{repla-extra-pos}, \type{where-pos}{[}
is {\em not} replaced. The beginning of \type{repla} is ignored.
\item If \type{where-pos} is before \type{repla-extra-pos},
only {[}\type{where-pos}, \type{repla-extra-pos}{[}
from the instrument is replaced, and the end of \type{repla} is ignored.
\stopitemize
\hairline

\blank[0.7cm]
Examples are most intuitive:
\page
\underbar{\sc\Words exemple 3}
\startfiguretext[right][exemple3]{}
{\vbox{\blank[0.15em]\externalfigure[exemple03.pdf][wfactor=220, align=flushright]}}
\startlily
mus = \relative c' {
  f1 c' f a f' }    %&\em{& cl mes &}&4
  
#(begin
  (rm 'fl 7 mus 4)
  (rm 'cl 4 mus #f) ;&\em{& (rm 'cl &}&4&\em{& mus)&}&
  (rm 'bs 4 mus 6))
\stoplily
\stopfiguretext

- Optional parameter \type{obj-start-pos} may precise where \type{obj} begins
(\type{repla-extra-pos}, above, related to \type{repla}). Typically here, \type{obj} is a
{\em music} rather than an {\em instrument} and the return value of \type{rm} is used.

In \in{example}[exemple3], we change now the F note at bar 6 into an E flat, assigning the
result to another instrument, a sax.

\defineparagraphs[mypar][n=3,before={\blank}, after={\blank}, distance=1em]
\setupparagraphs[mypar][1][width=0.42\textwidth, style=type]
\setupparagraphs[mypar][2][width=0.07\textwidth, style=type] %, rule=on]
\setupparagraphs[mypar][3][width=0.45\textwidth, style=italic]
\startmypar
%\vbox{
\startlily                
#(let((m (rm mus 
             6 #{ ees'1 #} 
             #f
             4)))
    (rm 'saxo 4 m))
\stoplily
%}%
\mypar 
; let\crlf
; 6\crlf
; \#f\crlf
; 4
\mypar
declares local variables\crlf
bar that is replaced with an E flat\crlf
repla-extra-pos,\crlf
position where music begins
\stopmypar
\hairline
Do note the difference between \type{(rm music…)} and \type{(rm 'music…)}. The former
returns a new musical expression without actually modifying \type{music}, whereas the
latter assigns this return value back to the \type{'music} instrument.
\hairline
\blank
- In case \type{obj} is a list of {\em instrument}s, any element of this list may in turn
be a list of {\em instrument}s. Thus,
\startmylily
(rm '(flute (clar sax) bassClar) 5 '(musicA musicB musicC))
\stopmylily 
will trigger assignments as in this diagram:\crlf
\vtop{\hbox{
 \hspace[lilyindent]
 \starttable[|lT|c|l|]
    \type{'flute} \NC $\leftarrow$ \NC \type{\musicA} \FR
    \NR
    \type{'clar} \NC $\leftarrow$ \NC \type{\musicB} \MR
    \NR
    \type{'sax} \NC $\leftarrow$ \NC \type{\musicB} \MR
    \NR
    \type{'bassClar  } \NC $\leftarrow$ \NC \type{\musicC} \LR
    \NR
  \stoptable}
}


                     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subject[positions_musicales]{Music positions and bar numbers explained}
%\blank[0.8em]
- A position is denoted by a bar number. What if the position should not begin at
the start of a measure? In such a case, the position is a {\em list of integers}: 
\startmylily '(n i j k …) \stopmylily
where \type{n} is the bar number, and \type{i j k …} are powers of two (1, 2, 4,
8, 16, etc…) denoting the distance from the beginning of the \type{n}-th bar. 

Thus, \type{'(5 2 4)} is a position, located in measure 5, after a half note (\type{2})
and a quarter note (\type{4}), that is, in a \type{4/4} beat, fifth measure, fourth beat.\\

- Any \type{n} lower than the \type{measure1-number} passed to \type{init}, which
defaults to 1, will be silently transformed into that number. In practice, it means that
\type{'(0 2 4)} points to the same location as \type{'(1 2 4)}…\\

- {\em Negative} values for \type{i j k …} are allowed.
\\In a 4/4 beat, \type{'(5 2 4)} is the same position as \type{'(6 -4)}, which reads
\quotation{One quarter note before measure 6.}.\\
Negative values are the only way to access a pickup at the start of the piece: \type{'(1 -4)} is the beginning of a tune starting with \type{\partial 4 …}.\\

- Any note still held at the beginning of the replacement is appropriately shortened by \type{rm}.

In the \in{previous example}{ (}[exemple3]\at{page}{)}[exemple3], this code: 
\startmylily
(rm 'cl '(5 2 4) #{ r4 #})
\stopmylily
would yield, as the clarinet's fifth measure, to:
\startmylily 
{c2. r4}
\stopmylily
$\Longrightarrow$ the whole C note turns into a dotted half note.
\reference[multirestWarning]{}
\hairline
Beware: while notes and rests may be arbitrarily split into smaller values,
full-measure rests (written with capital \type{R}) can only be shortened at bar lines.
\hairline
\blank[0.5em]
This is why, in our \in{example}{ on page \at{}[exemple3]}[exemple3],
\startmylily
(rm 'fl '(5 2 4) #{ c''4 #})
\stopmylily
would trigger a warning resembling:
\startmylily
&\it\quotation{{&warning: barcheck failed at: 3/4
 mmR = { #infinite-mmR \tag #'mmWarning R1 }&}}&
\stopmylily
(The 2\high{nd} line originates from the {\em extractMusic.ly} file.)\\
The solution is:
\startmylily
(rm 'fl 5 #{ r2 r4 c''4 #})    ;&\em{& rests written out by hand !&}&
\stopmylily
%\crlf % <- ne marche pas ici
\blank[1em]

- This last example demonstrate the use of positions with the \type{\cadenzaOn} command.
\blank[0.2em]
\underbar{\sc\Words exemple 4}
\startfiguretext[right][exemple4]{}
{\vbox{\blank[1.7em]\externalfigure[exemple04.pdf][wfactor=200, align=flushright]}}
\startlily[space=fixed]
cadenza = \relative c' { c4^"cadenza" d e f g }
global = {
   \time 3/4
   s2.
   \cadenzaOn
     #(skip-of-length cadenza) \bar "|"
   \cadenzaOff
   s2.*2 \bar "|." }
#(begin
   (init '(clar))
   (rm 'clar 2 cadenza)
   (rm 'clar 3 #{ c'2. #}))
\stoplily
\stopfiguretext
\godown[-1.5em]
In order to insert an E note before measure 3, one can use negative number:
\startmylily
(rm 'clar '(3 -2 -4) #{ e'2. #})
\stopmylily

Internally, {\em arranger.ly} occasionally uses a different syntax for positions:
\startmylily `(n ,moment)    ;&\it\rm{& or : (list n moment)&}& \stopmylily

To insert the E, the following would then be possible:
\startmylily
(rm 'clar `(2 ,(ly:music-length cadenza)) #{ e'2. #})
\stopmylily
Note finally that the syntax \type{`(n ,(ly:make-moment p/q))} can be reduced to \type{'(n p/q)}, provided that the quotient \type{p/q} is not reducible to an integer.
\startmylily 
(rm 'clar '(2 5/4) #{ e'2. #})  ;&\it\rm{& ok with 5/4 : same result as previous code&}&  \stopmylily
On the other hand, \type{8/4} would be \type{(ly:make-moment 1/2)}, not \type{(ly:make-moment 2/1)}.

\blank[1.2em]
- \underbar{Convention} :
\blank[0.1em]
\hairline
In all following functions, any argument ending in \type{-pos} (such as
\type{from-pos}, \type{to-pos}, \type{where-pos}, etc.) shall be \type{position}s as
described in this paragraph, as well as \type{pos1}, \type{pos2}, etc.
\hairline

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title[ListageFonctions]{LISTINGS of the FUNCTIONS}

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                  
\subject[copiercoller]{Copy-paste functions}
\blank[-2em]
%%%%%%%%%
\func{rm}
\syntax{(rm obj where-pos repla}{repla-extra-pos obj-start-pos)}
\type{rm} is described separately in a very detailed manner \at{page}[rm-info].
\blank[0.8em]
\midaligned{ \tfd ------------}

%%%%%%%%%
\func{copy-to}
\index{copy-to-with-func}
\syntax {(copy-to destination source from-pos to-pos . args)}{}
Copy \type{source} in \type{destination} between positions \type{from-pos} and \type{to-pos}\\
\type{destination} can be an {\em instrument}, or a list of a mix of {\em instrument}s and lists of {\em instrument}s.\\
\type{source} is an {\em instrument}, or a list of {\em instrument}s, but also a {\em music} or a list of 
{\em music}s\\
You can put after several sections, by specifying new sources and new positions in the parameter optional \type{args}. User can optionally separate each section by a slash \type{/}.
\startmylily
(copy-to destination sourceA posA1 posA2 / sourceB posB1 posB2 / etc…)
\stopmylily
If you omit the parameter \type{source} in a section, the source of the previous section 
is taken into account.
\startmylily
(copy-to destination source pos1 pos2 / pos3 pos4)
\stopmylily
is equivalent to : 
\startmylily
(copy-to destination source pos1 pos2 / source pos3 pos4)
\stopmylily
If \type{source} do not begin at the beginning of the piece, then the optional key parameter \type{#:source-start-pos} can be used like that :
\startmylily
(copy-to destination source pos1 pos2 #:source-start-pos pos3 / pos4 pos5 …)
\stopmylily
Finally, user can replace \type{copy-to} by the function \type{(copy-to-with-func func)}, which will apply \type{func} to each copied section. See how to use this feature at the function  \goto{\type{apply-to}}[apply-to], \at{page}[apply-to].
\startmylily
((copy-to-with-func func) destination source pos1 pos2 …)
\stopmylily
\blank[1em]
\midaligned{ \tfd ------------}

%%%%%%%%%
\func{copy-out}
\index{copy-out-with-func}
\syntax {(copy-out obj from-pos to-pos where-pos . other-where-pos)}{}
Copy out the section \type{[from-pos to-pos[} of the instrument or list of instruments \type{obj}, to the position \type{where-pos}, and then eventually to other positions.
\startmylily
(copy-out obj from-pos to-pos where-pos1 where-pos2 where-pos3 etc...)
\stopmylily
User can replace \type{copy-out} by the function \type{(copy-out-with-func func)}, which will apply \type{func} to each copied section. See how to use this feature at the function  \goto{\type{apply-to}}[apply-to], \at{page}[apply-to].
\startmylily
((copy-out-with-func func) obj from-pos to-pos where-pos …)
\stopmylily
\blank[1em]
\midaligned{ \tfd ------------}

%%%%%%%%%
\func{x-rm}
\syntax {(x-rm obj replacement pos1 pos2 … posn)}{}

Simple shortcut for :
\startmylily
(rm obj pos1 replacement)
(rm obj pos2 replacement)
…
(rm obj posn replacement)
\stopmylily
\blank[0.3em]
\midaligned{ \tfd ------------}
\page

%%%%%%%%%
\func{rm-with} 
\syntax {(rm-with obj pos1 repla1 / pos2 repla2 / pos3 repla3 …)}{}

Shortcut for : 

\startmylily
(rm obj pos1 repla1)
(rm obj pos2 repla2)
etc…
\stopmylily
The slash \type{/} that split the instruction is optional.\\
If a \type{repla}{\em n} want to use music of a previous section, once modified, please use the scheme function \type{delay} and the function \type{em} of the \at{page}[em] in the following way~:
\startmylily
(delay (em obj pos1 …)) ; &\tfx\em{&Extract obj music after it is modified&}&
\stopmylily 
\blank[0.8em]
\midaligned{ \tfd ------------}
\godown[0.4em]

%%%%%%%%%
\func{apply-to}
\index{to-set-func}
\index{compose}
\syntax{(apply-to obj func from-pos to-pos}{obj-start-pos)}
Apply \type{func} to music of \type{obj} inside section \type{[from-pos to-pos[}.\\
\type{obj} is a {\em musique}, an {\em instrument}, or a list of {\em musique}s or {\em instrument}s.\\ 
The \type{obj-start-pos} parameter allows user to specify the starting position of \type{obj} when  different from the whole piece.
\blank[0.5em]
\underbar{The parameter \type{func}} :
\blank[0.7em]

{\tfa -} \type{func} is a function with only one parameter of type \type{music}.\\
"{\em arranger.ly}" defines a number of such function, in the form of a sub-function whose name begins  with \type{set-}~:\\
\type{set-transp}, \type{set-pat}, \type{set-ncopy}, \type{set-note}, \type{set-pitch}, \type{set-notes+}, \type{set-arti}, \type{set-reverse}, \type{set-del-events}, \type{set-chords->nmusics}.
(These functions are described later in this document).
\blank[0.6em]

{\tfa -} You can, however, easily create your own functions, compatible \type{apply-to}, with the help of a "wrapper" function called \type{to-set-func}, particularly adapted to changing musical properties. \type{to-set-func} takes itself in parameter, a {\em function} with musical parameter.\\
In the following example, we define a function \type{func} which, when used with \type{apply-to}, will transform all \type{c'} into \type{d'}.
\blank[0.3em]

\startmylily
(define func (to-set-func (lambda(m) 
               (if (equal? (ly:music-property m 'pitch #f) #{ c' #}) 
                 (ly:music-set-property! m 'pitch #{ d' #})))))
\stopmylily
%\crlf % don't work
\blank[0.3em]
{\tfa -} You can also group several operations together at the same time, using the \type{compose} function~:
\blank[0.3em] 
\startmylily (compose func3 func2 func1 …) \stopmylily 
\blank[0.3em]
…which will result, when applied to a \type{music} parameter, to :
\blank[0.3em]
\startmylily (func3 (func2 (func1 music)))\stopmylily
\blank[0.6em]
{\tfa -} Let's go back to the functions of "{\em arranger.ly}" mentioned earlier, functions of the form :
\blank[0.3em] 
\startmylily ((set-func args) music) \stopmylily
\blank[0.3em]
During the call of \type{apply-to}, all arguments of the sub-function \type{set-func} remain the same and fixed for all instruments contained in \type{obj}. 
However, it is in certain cases desirable that these arguments are, on the contrary, customizable for each instrument.\\
This will be possible, provided that a new syntax is adopted for the argument \type{func} of \type{apply-to}, which will then be defined as a pair, with in 1\high{st} element, the name of the sub-function, and in 2\high{nd}, a list, composed with the arguments corresponding to each instrument.

\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\type{func} becomes : \inframed{\type{(cons set-func (list args-instrument1 args-instrument2 …))}}
\blank[0.4em]
Each \type{args-instrument} of the list is either a single element or either a list itself, depending on the number of parameters required by \type{set-func}.
\blank[0.3em]
Example 5 below, copies patterns for 3 measures and then changes the pitch of the notes in
\blank [0.3em] % the \high below need Y space
 the 2\high{nd} measure.
\blank [0.3em]

This is done using 3 functions that will be seen later :
\startitemize[5,standard,intro][margin=\lilyspace]
\item The \goto{\type{fill} function}[fill] \at{page}[fill] ({\em music}s patterns)
\item The \goto{\type{set-pitch} function}[set-pitch] \at{page}[set-pitch]. It waits for a single parameter, of type {\em music}.
\item The \goto{\type{chords->nmusics} function}[chords->nmusics] \at{page}[chords->nmusics]. It returns a list of \type{n} elements that are just of type …~{\em music}.
\stopitemize

\blank[1.5em]
\underbar{\sc\Words exemple 5}
\startfiguretext[right][exemple5]{}
{\vbox{\blank[-3em]\externalfigure[exemple05.pdf][wfactor=248, align=flushright]}}
\startlily[space=fixed]
global = { s1*3 \bar "|." }
instrus = #'(I II III)
#(init instrus)

chords = \relative c' {
  <b f' gis> <d f b> <c e a> <b d e> }

#(begin
(fill instrus (list #{ r8 e'-. #}
                    #{ r8 c'-. #}
                    #{ a8-> r c'-. r b-. r a-. r #})
              1 4)
(apply-to instrus (cons set-pitch (chords->nmusics 3 chords))
                  2 3))
\stoplily
\stopfiguretext
\godown[-1.2em] %\blank[-2em]
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{x-apply-to}
\syntax {(x-apply-to obj func from-pos1 to-pos1
              / from-pos2 to-pos2 /…)}{} 
Simple shortcut for :
\startmylily
(apply-to obj func from-pos1 to-pos1)
(apply-to obj func from-pos2 to-pos2)
etc…
\stopmylily
The slash \type{/} is optional.\\
A key : \type{obj-start-pos} can optionally specify a starting point that differs from the beginning of the song~:
\startmylily
(x-apply-to obj func pos1 pos2 #:obj-start-pos pos3 …)
\stopmylily
\godown[1.5em]
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{xchg-music} (shortcut of "e\underbar{xch}ange music")
\syntax {(xchg-music obj1 obj2 from-pos1 to-pos1 / from-pos2 to-pos2 /…)}{}
Copy \type{[from-posn to-posn[} section from \type{obj1} to \type{obj2}, and the one from \type{obj2} to \type{obj1}.\\
The slash \type{/} is optional.
\blank
\midaligned{ \tfd ------------}
\page
                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subject[agencement]{Manipulating musical elements}
The following functions help manipulating sequential or simultaneous musics, extracted from instruments.
\godown[2em]

%%%%%%%%%
\func{em} : «e» from \underbar{e}xtract, «m» from \underbar{m}usic, reference function : 
\type+\extractMusic+
\footnote{See {\em extractMusic-doc.pdf} at \from[extractMusic]}
\syntax {(em obj from-pos to-pos}{obj-start-pos)}
Extract music in measures range \type{[from-pos to-pos[}. An event will be kept if it begins between theses two limits, and his length will be cut if it lasts after \type{to-pos}.\\
\type{obj} is typically an {\em instrument}, or a list of {\em instrument}s.\\
If \type{obj} is a {\em music} or a {\em music}s list, the \type{obj-start-pos} parameter will inform the function about the position of \type{obj} in the piece (by default : the beginning of the piece).

\type{em} returns a {\em music}s list if \type{obj} is a list, or a {\em music} in the opposite.\\
See an example of use in the following example (function \type{seq}).
\blank[0.3em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{seq}(shortcut of {\em \underbar{seq}uential})
\syntax {(seq musicI musicII musicIII etc…)}{}

Equivalent to : \type+{ \musicI \musicII \musicIII…}+

All arguments are {\em music}s.\\
\underbar{\sc\Words Example} :
\startmylily
(rm 'clar 12 (seq (em 'flute 12 15)         ; &\em{&Double the flute&}&
                  #{ r2 r4 #}               ; &\em{&Measure 15&}&
                  (em 'violon '(16 -4) 20)) ; &\em{&Double the violin&}&
\stopmylily 
\blank[0.7em]
\midaligned{ \tfd ------------}
\godown[0.4em]

%%%%%%%%%
\func{sim} (shortcut of {\em \underbar{sim}ultaneous})
\syntax {(sim musicI musicII musicIII etc…)}{}

Equivalent to : \type+<< \musicI \musicII \musicIII …>>+ 

All arguments are {\em music}s.\\
See an example in \goto{\type{volta-repeat->skip} function }[volta-repeat->skip], \at{page}[volta-repeat->skip]
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{split}
\syntax {(split musicI musicII)}{}

Equivalent to : \type+<< \musicI \\ \musicII >>+\\
Both arguments are {\em music}s.
\blank[0.3em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{part-combine}
\syntax {(part-combine musicI musicII)}{}

Equivalent to : \type+\partCombine \musicI \musicII+\\
Both arguments are {\em music}s.
\blank[1em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%
\func{def!}
\syntax {(def! name}{music)}

Equivalent to a Lilypond déclaration : %
\type+name = \music+

\type{name} is an {\em instrument}, or an '{\em instrument}s list.
(\type{def!} is applied to each instruments of the list).\\
\type{music} is a {\em music} or a {\em music}s list.(\type{music1} is associated to \type{instrument1}, \type{music2} to \type{instrument2} etc…)\\
If \type{music} is omitted, the default value is a skip (\type{s1{*}}...) with the same length as  \type{\global}.\\
See example below, in function \type{volta-repeat->skip}.
\blank[1.2em]
\midaligned{ \tfd ------------}
\godown[0.5em]

%%%%%%%%%
\func{at}
\syntax {(at pos mus)}{}

Return \type+{ s1*… \mus }+, with \type{s1*…} with a length from beginning of the piece to \type+pos+.

\blank[1.2em]
\midaligned{ \tfd ------------}
\godown[0.5em]

%%%%%%%%%
\func{cut-end}
\syntax {(cut-end obj new-end-pos [start-pos])}{}

Cut, at position \type{new-end-pos}, the musics associated with \type{obj}, keeping only the beginning.\\
It is  particularly usefull during building process of \type{\global}, as shown in \goto{addendum I}[addendum1] \at{page}[addendum1].

\blank[1.2em]
\midaligned{ \tfd ------------}
\godown[0.2em]

%%%%%%%%%
\index{pos-sub}
\blank[-2em]
\func{volta-repeat->skip}
\syntax {(volta-repeat->skip r . alts)}{}

Returns a \type+\repeat volta [\alternate]+ structure, where each element is a \type{\skip}.\\
The repetitions count is computed from the elements count of \type{alts} (or ignored if empty).\\
All arguments are rational numbers, in the p/q form, with q as a power of two (1 2 4 8…). They indicate the length of each element.
\startmylily (volta-repeat->skip 9 3 5/4) \stopmylily
is equivalent to :
\startmylily \repeat volta 2 s1*9 \alternate { s1*3 s4*5 } \stopmylily \\
Alternatively, arguments can be of type \type{moment}. It allows the use of the internal function \type{pos-sub} which returns a \type{moment} equal to the difference of the 2 positions.\\
For example, \type{(pos-sub 24 13)} returns the length between measure 13 and measure 24 : easy to compute in a 4/4 signature, but more difficult if the section has a lot of measure changes (as \type{\time 7/8} then  \type{\time 3/4} etc …).\\
You can use the \type{def!} function (described above), to create a variable containing the various repetitions in the piece :\\
\underbar{\sc\Words Example 5} :
\blank[0.5em]
\startmylily 
(def! 'structure)                ; &\em{&same length as \global&}&  
(rm-with 'structure              ; &\em{&add repetitions&}&  
    5 (volta-repeat->skip 9 3 5/4)                        ; &\em{&(in &}&4/4&\em{&)&}& 
   29 (volta-repeat->skip (pos-sub 38 29) (* 2 3/4) 3/4)) ; &\em{&(in &}&3/4&\em{&)&}&   
(def! 'global (sim global structure))  ; &\em{&global = << \global \structure >>&}&
\stopmylily
\blank[2em]
\midaligned{ \tfd ------------}
\page  %%%%%%%%%%%%%%%%%%%%%%%%%%%%


                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                     
\subject[gerer-voix]{Managing voices (addition, extraction )}
%\footnote{Voir {\em chordsAndVoices-doc.pdf} à \from[chord]} 
See also {\em chordsAndVoices-doc.pdf} at \from[chord]
\blank[-1em]
%%%%%%%%%
\func{voice} 
\syntax {(voice n music)}{}
\index{set-voice}
or : (2\high{nd} equivalent form, to be used with \goto{\type{apply-to}}[apply-to])
\syntax {((set-voice n) music)}{}
Extract the voice \type{n}, in a music with several simultaneous voices.\\
If \type+music = << { a b } \\ { c d } >>+, the code :\\
\type+(voice 2 music)+ will result to : \type+{ c d }+

\blank
\midaligned{ \tfd ------------}\\

%%%%%%%%%
\func{replace-voice} 
\syntax {(replace-voice n music repla)}{}
\index{set-replace-voice}
or : (2\high{nd} equivalent form, to be used with \goto{\type{apply-to}}[apply-to])
\syntax {((set-replace-voice n repla) music)}{}
Replace, in a simultaneous music, the voice \type{n}.\\
If \type+music = << { a b } \\ { c d } >>+, the code :\\
\type+(replace-voice 2 music #{ f g #})+ will result to : \type+<< { a b } \\ { f g } >>+

\blank
\midaligned{ \tfd ------------}\\

%%%%%%%%%
\func{dispatch-voices}
\syntax {(dispatch-voices obj where-pos music-with-voices}{voices-extra-pos obj-start-pos)} 
\underbar{\sc\Words Example} :
\startlily music = << { c2 d } \\ { e2 f } \\ { g2 b } >> \stoplily 
The code :
\startlily (dispatch-voices '(bassoon clarinet (oboe flute)) 8 music) \stoplily 
will produce, measure 8, the following assignment : 
\starttabulate[|l|l|c|l|]
    \NC\myindent\NC {\type{'bassoon}}\NC $\leftarrow$ \NC \type+ { c2 d } +
    \NR
    \NC\myindent\NC {\type{'clarinet}} \NC $\leftarrow$ \NC \type+ { e2 f  } +
    \NR
    \NC\myindent\NC {\type{'oboe}} \NC $\leftarrow$ \NC \type+ { g2 b } +
    \NR
    \NC\myindent\NC {\type{'flute}} \NC $\leftarrow$ \NC \type+ { g2 b } +
    \NR
\stoptabulate 
See \in{la fonction \type{rm}}[rm-info] (\at{page}[rm-info]) for the signification of the optional  arguments.

\blank
\midaligned{ \tfd ------------}

%%%%%%%%%
\hairline
The following functions are all created, at the parameter level, on the same model. Each of them just allows to obtain a particular type of simultaneous music :
\starttabulate[|l|l|c|l|]
    \NC\myindent\NC {\type{add-voice1/add-voice2}}\NC $\rightarrow$ \NC \type+ << \voiceI \\ \voiceII >> +
    \NR
    \NC\myindent\NC {\type{merge-in/merge-in-with}} \NC $\rightarrow$ \NC \type+ << \voiceI \voiceII >> +
    \NR
    \NC\myindent\NC {\type{combine1/combine2}} \NC $\rightarrow$ \NC \type+ \partCombine \voiceI \voiceII +
    \NR
\stoptabulate 
\hairline
\page  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\func{add-voice1, add-voice2}{}
\syntax{(add-voice1 obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}        
\syntax{(add-voice2 obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}
The music of each {\em instrument}, is replaced at the \type{where-pos} position with 
\startmylily << [existing music] \\ new-voice >>  &\rm{&for&}& add-voice2 \stopmylily
and with :
\startmylily << new-voice \\ [existing music] >>  &\rm{&for&}& add-voice1&\rm{&.&}& \stopmylily

\type{obj} is an {\em instrument} or a list of {\em instrument}s

\type{new-voice} is a {\em music} or a list of {\em music}s.\\
Use \type{voice-start-pos}, if \type{new-voice} begins before \type{where-pos}.\\
Use \type{to-pos} if tou want to stop the replacement before the end of \type{new-voice}.\\ 
Use \type{obj-start-pos} if \type{obj} doesn't begin to the beginning of the piece (typically  
measure~1,~see \at{\type{init} function, page}[init]).

\blank
\midaligned{ \tfd ------------}
\page[preference]

%%%%%%%%%
\func{merge-in}
\syntax{(merge-in obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}

music of \type{obj} is replaced , measure \type{where-pos}, by : 
\startmylily << new-voice [existing music] >> \stopmylily
For optional parameters, see above (\type{add-voice1}).
\blank[1em]
\midaligned{ \tfd ------------}
\godown[0.8em]

%%%%%%%%%
\func{merge-in-with}
\syntax {(merge-in-with obj pos1 music1 / pos2 music2 / pos3 music3 …)}{}
is a shortcut for :
\startmylily 
(merge-in obj pos1 music1)
(merge-in obj pos2 music2)
(merge-in obj pos3 music3)	
…
\stopmylily
The slash \type{/} is optionnal
\blank
\midaligned{ \tfd ------------}
\godown[0.8em]

%%%%%%%%%
\func{combine1, combine2}{}
\syntax{(combine1 obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}        
\syntax{(combine2 obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}
music of each {\em instrument}, is replaced, at  \type{where-pos} position, by :  
\startmylily \partCombine [existing music] \new-voice  &\rm{&for&}& combine2 \stopmylily
and by
\startmylily \partCombine \new-voice [existing music]  &\rm{&for&}& combine1&\rm{&.&}& \stopmylily
\\See \type{add-voice} function in the top of this page, for optional parameters.
\blank[1em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subject[gerer-accords]{Managing chords }
\blank[-1em]
%%%%%%%%%
\func{note}
\syntax {(note n [m p ...] music)}{}
\index{set-note}
or : (2\high{nd} equivalent form, to be used with \goto{\type{apply-to}}[apply-to])
\syntax {((set-note n [m p …]) music)}{}

Extract the n\high{\itxx th} note of each chords (in the same order as in the source file).\\
If other numbers are specified, (\type{m}, \type{p} ...), \type{note} will form chords by searching the original chord for the note corresponding to each of these numbers.\\
If no match is found, \type{note} returns the last note of the chord.\\ 

\underbar{\sc\Words Example} :
\startmylily
music = { <c e g>-\p <d f b>-. }
(note 1 music)   &$\Longrightarrow$& { c-\p d-. }
(note 2 3 music) &$\Longrightarrow$& { <e g>-\p <f b>-. }
(note 4 music)   &$\Longrightarrow$& { g-\p b-. }
\stopmylily
\blank[0.9em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{notes+}
\syntax {(notes+ music newnotes1 [newnotes2…])}{}
\index{set-note†}
or : (2\high{nd} equivalent form, to be used with \goto{\type{apply-to}}[apply-to])
\syntax {((set-notes+ newnotes1 [newnotes2…]) music))}{}
Transforms each note of \type{music} into a chord, and inserts in it, the corresponding \type{newnotes}  note.\\
A \type{\skip} in \type{newnotes} leaves the original note unchanged.\\

\underbar{\sc\Words Example} :
\startmylily
music = { c'4  b  <g c'>2  c'  c' }
notes = { e  <d f>  e      s   c  }	
(notes+ music notes) &$\Longrightarrow$& { <e c'>4 <d f b> <e g c'>2 c' <c c'> }
\stopmylily
\blank[0.9em]
\midaligned{ \tfd ------------}
\godown[1.2em]

%%%%%%%%%
\func{add-notes} 
\syntax {(add-notes obj where-pos newnotes1 [newnotes2]…[obj-start-pos])}{}
Same as \type{notes+} but applied now to a given position \type{where-pos}\\
\type{obj} can be an {\em instrument}, a list of {\em instrument}s, a {\em music} or a list of {\em music}s.\\
\type{newnotes} are {\em music}s, but if both \type{newnotes1} and \type{obj} are lists, \type{notes+} is applied element to element.\\
See \in{the \type{rm} function}[rm-info] (\at{page}[rm-info]) to know the signification of last optional parameter \type{obj-start-pos}.
\blank[0.9em]
\midaligned{ \tfd ------------}
\godown[1.2em]

%%%%%%%%%
\func{dispatch-chords}  
\syntax {(dispatch-chords instruments where-pos music-with-chords . args)}{}
\type{dispatch-chords} assigns each note of the chords of a {\em music} to separate parts..\\
\type{instruments} is the list of instruments that receive, at the where-pos position, those parts.\\
\type{music-with-chords} is the {\em music} containing the chords.
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
The note 1 of a chord is sent to the last item in the list \type{instruments}, then the note 2 to the second to last one etc…\\
The code :
\startmylily
music = { <c e g>4 <d f b>-. }
(dispatch-chords '(alto (tenorI tenorII) basse) 6 music)
\stopmylily
will result, at measure 6, in :
\startmylily
basse   &$\leftarrow$& { c4 d-. }
tenorI  &$\leftarrow$& { e4 f-. }
tenorII &$\leftarrow$& { e4 f-. }
alto    &$\leftarrow$& { g4 b-. }
\stopmylily
The optional args are the same than \in{the \type{rm} function}[rm-info] (\at{see page}[rm-info]) 
\blank[0.6em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{reverse-chords}  
\syntax {(reverse-chords n music}{strict-comp?)}
\index{set-reverse}
or : (2\high{nd} equivalent form, to be used with \goto{\type{apply-to}}[apply-to])
\syntax {((set-reverse n [strict-comp?]) music)}{}
Reverse \type{n} times chords contained in \type{music}.\\
The displaced note is octavated as many times as necessary to make its pitch higher (lower if \type{n<0}) than the note preceding it.\\
The optional parameter \type{strict-comp?} proposes either, when set to \type{#t}, the comparison: {\em strictly} higher ({\em strictly} lower for \type{n<0}), or, when set to \type{#f}, the comparison : higher (lower) or {\em equal}.\\
By default, \type{strict-comp?} is set to \type{#f} for \type{set-reverse} and to \type{#t} for \type{reverse-chords} !
\blank[2em]
\underbar{\sc\Words Example} (in absolute pitch mode) :
\blank[1.3em]
\startmylily
                   music    &\hbox to 1.3em {\\$=$\\}\hbox to 0.1em {\\}&   { <c e g>   <c g e'>    <c e c'> }
(reverse-chords 1 music)    &$\Longrightarrow$&   {   <e g c'>  <g e' c''>  <e c' c''> }
(reverse-chords 2 music)    &$\Longrightarrow$&   {     <g c' e'> <e' c'' g''><c' c'' e''> }

(reverse-chords 0 music)    &$\Longrightarrow$&   {       <c e g>   <c g e'>  <c e c'> }
(reverse-chords -1 music)   &$\Longrightarrow$&   {    <g, c e>  <e, c g>  <c, c e> }
(reverse-chords -2 music)   &$\Longrightarrow$&   { <e, g, c><g,, e, c><e,, c, c> }

(reverse-chords 1 music #f) &$\Longrightarrow$&   {   <e g c'>  <g e' c''>  <e c' c'> }
\stopmylily
\blank
\midaligned{ \tfd ------------}
\godown[1.2em]

%%%%%%%%%
\func{braketify-chords}  
\syntax{(braketify-chords obj)}{}
Adds bracket in chords containing at least 2 notes and not linked in previous chord by a tilde~\type{~} \\
This function extends the \type{\braketifyChords} function defined in {\em copyArticulations.ly} accepting also as parameter, a list of {\em music}s, an {\em instrument}, or a list of {\em instrument}s.
\blank
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                     
\subject[gerer-accords-voix]{Managing chords and voices together}
\blank[-2em] 

%%%%%%%%%
%%%%%%%%%
\func{treble-of}
\syntax {(treble-of music)}{}

Extract in first voice, the last note of each chord.

\blank
\midaligned{ \tfd ------------}
%%%%%%%%%
\func{bass-of} 
\syntax {(bass-of music)}{} 

Extract in last voice, the first note of each chord.

\blank
\midaligned{ \tfd ------------}
%%%%%%%%%
\func{voices->chords} 
\syntax {(voices->chords music)}{} 

Transform a simultaneous {\em music} \type+<<{a b}\\{c  d}>>+ \\%
in a sequential {\em music} \type+{<a c> <b d>}+

\blank
\midaligned{ \tfd ------------}
%%%%%%%%%
\func{chords->voices} 
\syntax {(chords->voices music)}{} 

Transform a sequence of chords \type+{<a c> <b d>}+ \\
in a simultaneous {\em music}  \type+<<{a b}\\{c  d}>>+

\blank
\midaligned{ \tfd ------------}\\

%%%%%%%%%
\func{chords->nmusics} 
\syntax {(chords->nmusics n music)}{}
\index{set-chords->nmusics}
or : (2\high{nd} equivalent form, to be used with \goto{\type{apply-to}}[apply-to])
\syntax {((set-chords->nmusics n) music)}{}

Transform a sequence of chords in a {\em list} of %
\type{n} {\em music}s\\
For : \type+music = {<e g c'> <d f b> <c e g c'>}+\\
the \type{chords->nmusics} function give the following list :

\blank
\hbox{{\hspace[lilyindent]}
\starttable[|c|l|]
 \NC n \VL liste \NC\SR
 \HL
 \NC 1 \VL \type+{e d c}+ \NC\FR
 \NR
 \NC 2 \VL \type+{g f e}{e d c}+ \NC\MR
 \NR
 \NC 3 \VL \type+{c' b g}{g f e}{e d c}+ \NC\MR
 \NR
 \NC 4 \VL \type+{c' b c'}{c' b g}{g f e}{e d c}+ \NC\LR
\stoptable
}
\blank[1.5em]
See a use of \type{chords->nmusics} at \goto{example 5}[exemple5] of \at{page}[exemple5].
\blank[1.5em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

                     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subject[gerer-hauteur]{Managing pitch of notes}
\blank[-2em]
%%%%%%%%%
\func{rel}
\syntax {(rel [n] music)}{}
returns : \type{\relative} {\em pitch} \type{\music}\\
\midaligned{{\em pitch} as the central \type{c'}, transposed by \type{n} octaves.\type{    }}
%\rightaligned{{\em hauteur} étant le do central c' transposé de \type{n} octaves.}

\hbox{{\hspace[lilyindent]}
\starttable[s0|rs0|l|]
 \NC \type{(rel -2 music)} \Longrightarrow \NC\JustLeft\type{ \relative c, \music} \NC\FR
 \NR
 \NC \type{(rel -1 music)} \Longrightarrow \NC\JustLeft\type{ \relative c \music} \NC\MR
 \NR
 \NC \type{(rel music)}    \Longrightarrow \NC\JustLeft\type{ \relative c' \music}  \% {\em par défaut :} \type{n=0} \NC\MR
 \NR
 \NC \type{(rel 1 music)}    \Longrightarrow \NC\JustLeft\type{ \relative c'' \music} \NC\MR
 \NR
 \NC \type{(rel 2 music)}  \Longrightarrow \NC\JustLeft\type{ \relative c''' \music} \NC\LR
\stoptable
} % end of \hbox

An extended syntax is possible. See \goto{\type{octave} function}[octave], \at{page}[octave].

\blank[1em]
\midaligned{ \tfd ------------}\\

%%%%%%%%%
\func{set-pitch} (reference function : \type+\changePitch+)
\syntax {((set-pitch from-notes) obj)}{}

Replace pitch of notes in \type{obj} by those in \type{from-notes}.
To use typically with \in{\type{apply-to}}[apply-to]\at{(page}{)}[apply-to].See \goto{example 5}[exemple5] at \at{page}[exemple5].
\blank[0.6em]
\midaligned{ \tfd ------------}\\

%%%%%%%%%
\func{set-transp}
\syntax {((set-transp octave note-index alteration/2) obj [obj2 [obj3 …]])}{}
\syntax {((set-transp func) obj [obj2 [obj3 …]])}{}
Apply the Lilypond scheme function \type{ly:pitch-transpose} to each pitch of \type{obj}, with a {\em "delta-pitch"} parameter equal to :
\startitemize[joinedup,intro]
  \nop either the return value of \type{(ly:make-pitch octave note-index alteration/2)} (syntax 1)
  \nop either the return value of the \type{func(p)} function (syntax 2).(\type{p} current pitch to transpose).
\stopitemize
\blank[0.2em]
The \type{obj} parameters are {\em music}s, {\em instrument}s or a list of one of these 2 types.\\
The function returns the transposed {\em music}, or a list of transposed {\em music}s\\
\type{set-transp} is  compatible with \in{\type{apply-to}}[apply-to] and can be used as 
follows :
\startlily
#(let((5th (set-transp 0 4 0))}      ; &\em{\small &4 notes above = a fifth&}&
      (3rd (set-transp 0 2 -1/2))    ; &\em{\small &like from c to ees&}&
      (enhar (set-transp 0 1 -1)))   ; &\em{\small &from c to deses = enharmony&}&
   (rm all 67 (5th (em all 11 23)))  ; &\em{\small &[11-23] is copied at 67 to the fifth&}&
   (rm '(AclarI AclarII) 1 (3rd cl1 cl2))  ; &\em{\small &concert pitch transposed in A&}&
   (apply-to 'saxAlto enhar 10 15)   ; &\em{\small &set [10-15] in the enharmonic tone&}&
\stoplily
The function \type{maj->min} presented now, uses syntax 2 to adapt the transposition interval around the modal notes (degree III and VI) of the original major key. 
\startfiguretext[right][set-transp-func]{}
 {\vbox{\blank[-0.2em]\externalfigure[set-transp-func-en][wfactor=345, align=flushright]}}
 {\vbox{\blank[-0.38em]
\setupinterlinespace[medium]
The 3 instruments are initially identical, then \type{'II} and \type{'III} are transposed into minor.}}
\stopfiguretext
\setupinterlinespace[small]
\godown[-0.4em]
The function \type{maj->min} is defined as follows:
\page
\startmylily
#(define (maj->min from-pitch to-pitch)  ;&\em{\small& return the function lambda &}&
   (let ((delta (ly:pitch-diff to-pitch from-pitch))
         (special-pitches (music-pitches ;&\em{\small& defined in scm/music-functions.scm &}&
           (ly:music-transpose #{ dis e eis gis a ais #} from-pitch))))
     (lambda(p) (ly:make-pitch           ;&\em{\small& return the delta pitch &}&
       0 
       (ly:pitch-steps delta) 
       (+ (ly:pitch-alteration delta)    ;&\em{\small& the interval varies according to p &}&   
          (if (find (same-pitch-as p 'any-octave) special-pitches)
            -1/2  0))))))        ;&\em{\small& same-pitch-as is defined in checkPitch.ly &}&
\stopmylily
All that's left is to choose which \type{to-pitch} parameter to apply to \type{'II} and \type{'III}:
\startmylily 
(apply-to 'II (set-transp (maj->min  #{ c' #} #{ a #})) 1 8) 
(apply-to 'III (set-transp (maj->min #{ c' #} #{ c' #})) 1 8))            
\stopmylily

\blank[0.8em]
\midaligned{ \tfd ------------}
\godown[0.6em]


%%%%%%%%%
\func{octave}
\syntax {(octave n obj)}{}
or : (2\high{nd} equivalent form, to be used with \goto{\type{apply-to}}[apply-to])
\index{set-octave}
\syntax {((set-octave n) obj)}{}

Basically, \type{octave} is a simple shortcut to the function \type{(set-transp n 0 0)}, where \type{n} can be positive (upward transposition) or negative (downward transposition).\\
However, like the \type{rel} and \type{octave+} functions, it has an extended syntax.\\
Here are some possibilities.
\blank[0.6em]
\underbar{1\high{st} case}: put a theme in different octaves, to instruments of different tessitura.
\blank[1mm]
\startmylily
(rm '(vlI vlII va (vc db)) 18 (octave 2 1 0 -1 theme))
\stopmylily 
\blank[1mm]
The function returns the list \type{((octave 2 theme)(octave 1 theme)} etc …\type{)}\\
Note that the cello and the double bass receive the same music: \type{(octave -1 theme)}
\blank[0.6em]
\underbar{2\high{nd} case} : put in a specified octave, several musics at the same time.
\blank[1mm]
\startmylily
(rm '(instruI instruII instruIII instruIV) 18 (octave 1 m1 m2 m3 m4))
\stopmylily 
\blank[1mm]
All musics \type{m1 m2 m3 m4} are transposed to the octave.
\blank[0.6em]
\underbar{3\high{rd} case} : great mix !
\blank[1mm]
\startmylily
(rm '(vlI vlII va (vc db)) 18 (octave 2 m1 1 m2 m3 -1 m4))
\stopmylily 
\blank[1mm]
\type{m1} is transposed 2 octaves up, \type{m2} and \type{m3} are transposed : 1 octave up, and \type{m4} is transposed : 1 octave down.

\blank
\midaligned{ \tfd ------------}
\godown[0.6em]

%%%%%%%%%
\func{octavize} 
\syntax {(octavize n obj from-pos1 to-pos1 [/ from-pos2 to-pos2 /…])}{} 

\type{octavize} transpose by \type{n} octaves the {\em instrumen}t (or the list of {\em instrument}s)\type{ obj}, between the positions \type{[from-pos1 to-pos1]}, \type{[from-pos2 to-pos2]}, etc…

\blank
\midaligned{ \tfd ------------}
\godown[0.6em]

%%%%%%%%%
\func{octave+}
\syntax {(octave+ n music)}{}

Shortcut of \type!(notes+ music (octave n music))! (see \in{\type{notes+}}[notes+] \at{page}{}[notes+]) but without doubling articulations.\\
\type{octave+} has the same extended syntax as \type{octave} (see above) and \type{rel}.

\blank
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%
\func{add-note-octave} 
\syntax {(add-note-octave n obj from-pos1 to-pos1 [/ from-pos2 to-pos2 /…])}{} 

Apply the previous \type{(octave+ n music)} function to each \type+[from-pos to-pos]+ section.

\godown[0.6em]
\midaligned{ \tfd ------------}
\godown[-0.6em]

%%%%%%%%%
\hairline
The 2 following functions : \type{fix-pitch} and \type{pitches->percu} are more specifically designed for percussion. They put a bridge between notes with pitch and percussion notes.
\hairline
\blank[-2em]

%%%%%%%%%
\func{fix-pitch}
\syntax {(fix-pitch music pitch)}{}
\syntax {(fix-pitch music [octave] note-index [alteration])}{}
\index{set-fix-pitch}

Sets all the notes to pitch \type{pitch} or \type{(ly:make-pitch octave note-index alteration)}.\\
\type{octave} can only be omitted (\type{-1} by default) if \type{alteration} is omitted (\type{0} by default).\\
The equivalent function: \type{((set-fix-pitch ...) music)} takes the same parameters.
\blank[0.5em]
\midaligned{ \tfd ------------}
\godown[0.3em]

%%%%%%%%%
\func{pitches->percu} 
\syntax {(pitches->percu music percu-sym-def . args)}{}
Converts notes to percussion-type notes.\\
The argument \type{args} is a sequence of : a pitch, a percussion symbol, and optionally a separation slash \type{/} with the following group.\\
For each note of \type{music}, the function searches for the corresponding percussion symbol. If none is found, the symbol \type{percu-sym-def} is given.\\
The percussion instrument is assigned to the \type{'drum-style} property of the note.\\
Finally, note that any number \type{n} is transformed into \type{(ly:make-pitch -1 n 0)} by the function.
\blank[0.2em]
\underbar{\sc\Words exemple 6}
\startfiguretext[right][exemple6]{}
{\externalfigure[exemple06.pdf][wfactor=150, align=flushright]}
\startlily[space=fixed]
music = << 
   { e8 e e e e e e e} \\ 
   { c4 d8 c c4 d8 c } >>
percu = #(pitches->percu music 'hihat /
                       #{ c #} 'bassdrum /  ;&\em{\small& or : 0 'bassdrum /&}&
                       #{ d #} 'snare)      ;&\em{\small& or : 1 'snare)&}&
\new DrumStaff \drummode { \percu }
\stoplily
\stopfiguretext

\godown[-1.6em]
\midaligned{ \tfd ------------}
\godown[0.1em]

%%%%%%%%%
\func{set-range} (see : \type{correct-out-of-range} in {\em checkPitch.ly})
\syntax {((set-range range) music)}{} 

\type{range} is in the form \type{{c, c''}} or \type{<c, c''>}\\
Transposes to the right octave, all notes out of \type{range}. The function allows you to adjust the score to the tessitura of an instrument, for example.\\
Can be used with \goto{\type{apply-to}} [apply-to].

\godown[-0.1em]
\midaligned{ \tfd ------------}
\godown[0.3em]

%%%%%%%%%
\func{display-transpose} 
\syntax {(display-transpose music amount)}{} 

Visually moves notes from \type{amount} positions up or down.

\godown[0.6em]
\midaligned{ \tfd ------------}

                     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
                     
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                               
\subject[utiliser-pattern]{Using «patterns»}
\blank[-1em] 

%%%%%%%%%
\func{set-pat}  : {\em rhythm} pattern (reference function is \type+\changePitch+%
\footnote{See {\em changePitch-doc.pdf} at \from[changePitch]})
\index{cp}
\index{cp1}
\index{cp2}
\syntax {((set-pat pattern [include-ending-rest?]) obj)}{}

Returns: \type+\changePitch \pattern \music+\\
with \type+\music+ being the music referenced by \type{obj}.\\
If \type{obj} is a list, the function returns a list.\\
Once the last note of \type{obj} is reached, any rests of \type{pattern} that should be put after that note are ignored, unless you set \type{#t} as the parameter \type{include-ending-rest?}.\\
3 shortcuts have been defined (their name refers to \type+\changePitch+) :
\startmylily
(cp pattern obj) &$\Longrightarrow$& ((set-pat pattern) obj)
(cp1 obj)        &$\Longrightarrow$& (cp patI obj)
(cp2 obj)        &$\Longrightarrow$& (cp patII obj)
\stopmylily
Unlike \type{set-pat}, the \type{include-ending-rest?} parameter of these 3 shortcuts is set to \type{#t} by default. Again invertible by the code : \type{(cp #f pattern obj)}. \\
See \goto{\type{tweak-notes-seq}} [tweak-notes-seq] (\at{page} [tweak-notes-seq]) for a use of the shortcut \type{cp1}
\blank
\midaligned {\ \tfd ------------}\\


%%%%%%%%%
\index{ca}
\func{set-arti} : {\em articulations} pattern (reference function is  \type+\copyArticulations+
\footnote{See \from[copyArticulations-LSR] for the use of \type{\copyArticulations}})
\syntax{((set-arti pattern) obj)}{}

Returns: \type+\copyArticulations \pattern \music+\\
with \type+\music+ as the music referenced by \type{obj}.\\
If \type{obj} is a list, the function returns a list.\\
An equivalent function has been defined: \type{ca}. It allows an alternative syntax:
\startmylily
(ca pattern obj) &$\Longleftrightarrow$& ((set-arti pattern) obj))
\stopmylily
\blank
\midaligned{ \tfd ------------}\\

%%%%%%%%%
%%\page
\func{fill-with} : {\em musics} pattern
\syntax {(fill-with pattern from-pos to-pos)}{}

Repeat the \type{pattern} music the number of times necessary to fill the \type{[from-pos to-pos]} interval exactly, eventually cutting off the last copy.\\
Returns the resulting music, or a list of these musics if \type{pattern} is a list of musics.
\blank
\midaligned{ \tfd ------------}\\

%%%%%%%%%
\func{fill} : {\em musics} pattern
\syntax {(fill obj pattern from-pos to-pos . args)}{} 

Équivalent of \type{(rm obj from-pos music)} with
\startmylily music = (fill-with pattern from-pos to-pos) \stopmylily
The following syntax is possible:
\startmylily (fill obj pat1 from1 to1 / [pat2] from2 to2 / [pat3] from3 to3 …) \stopmylily
If a \type{pat} parameter is omitted, the one from the previous section is retrieved.\\
See \goto{example 5}[exemple5] \at{page}[exemple5].
\blank
\midaligned{ \tfd ------------}
\page

%%%%%%%%%
\func{fill-percent} : {\em musics} pattern
\syntax {(fill-percent obj pattern from-pos to-pos . args)}{} 

Same as function \type{fill} above, but produces \type{\repeat percent …} musics instead.
\blank
\midaligned{ \tfd ------------}\\

%%%%%%%%%
\func{tweak-notes-seq} : {\em notes} pattern
\syntax {(tweak-notes-seq n-list music)}{} 
or : (2\high{nd} equivalent form, to be used with \goto{\type{apply-to}}[apply-to])
\index{set-tweak-notes-seq}
\syntax {((set-tweak-notes-seq n-list) music)}{}
\type{music}  is a music with notes in it.\\
\type{n-list} is an integers list. Each \type{n} number represents the n\high{th} note extracted from \type{music}.\\
\type{tweak-notes-seq} returns a sequential music by replacing each number of \type{n-list} with the corresponding note. When the last number is reached, the process starts again at the beginning of the list of numbers, but increasing it by the largest number in the list. The process stops when there are no more notes to match in \type{music}.
\startmylily
(tweak-notes-seq '(1 2 3 2 1) #{ c d e | d e f | e f g #}) 
& $\Longrightarrow$ & { c d e d c
      d e f e d
      e f g f e }
\stopmylily
In \type{n-list}, a number \type{n} can be replaced by a pair \type{(n . music-function)}.\\
\type{music-function} is then applied to the note \type{n}. It must take a music as parameter and return a music. Typically, this function is \goto{\type{set-octave}}[octave].\\
The following example uses this function, in combination with the \goto{\type{cp1}}[set-pat] shortcut of the \type{set-pat} function.

%\blank[0.7cm]
\startfiguretext[right][exemple7]{}
{\vbox{\blank[-0.5em]\externalfigure[exemple07.pdf][wfactor=235, align=flushright]}}
\underbar{\sc\Words exemple 7}
%\blank[1cm]
\startlily[space=fixed]
patI = { r8 c16 c c8 c c c }
#(rm 'instru 1 (cp1 
   (tweak-notes-seq 
     `(1 2 3 (1 . ,(set-octave +1)) 3 2) 
     (rel 1 #{ c e g | a, c e | f, a c | g b d #}))))
\stoplily
\stopfiguretext
\midaligned{ \tfd ------------}\\

%%%%%%%%%%
\func{x-pos} : {\em bar numbers} pattern
\syntax {(x-pos from-measure to-measure}{pos-pat (step 1))} 

\type{from-measure} and \type{to-measure} are bar numbers (some {\em integers}).\\
\type{pos-pat} is a {\em position}s \footnote {positions are defined \in{in the \quotation{music  positions} paragraph}[positions_musicales], \at{page}[positions_musicales].} list, with a letter, generally n, instead of bar numbers.\\
\type{x-pos} converts this list, replacing n (the letter) by the bar number \type{from-measure} and increasing it recursively by \type{step} units, as long as this value remains strictly inferior to \type{to-measure}.\\
Default, \type{pos-pat} = \type{'(n)}, \type{step} = 1.
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
The following table shows the list obtained with different values:
\startmylily
(x-pos 10 14)              & $\Longrightarrow$ & '(10 11 12 13)
(x-pos 10 14 '(n (n 4)))   & $\Longrightarrow$ & '(10 (10 4) 11 (11 4)) 12 (12 4) 13 (13 4))
(x-pos 10 14 '(n (n 4)) 2) & $\Longrightarrow$ & '(10 (10 4) 12 (12 4))
(x-pos 10 13 '(n (n 4)) 2) & $\Longrightarrow$ & '(10 (10 4) 12 (12 4))
(x-pos 10 12 '(n (n 4)) 2) & $\Longrightarrow$ & '(10 (10 4))
\stopmylily
\type{x-pos} can be used in conjunction with \type{x-rm} for example, and the scheme function \type{apply}:
%%% Exemple 5
%\startfiguretext[right][exemple5]{}
\blank
\reference[exemple8]{exemple8}
\starthanging[right]
{\vbox{\blank[5.2em]\externalfigure[exemple08.pdf][wfactor=305, align=flushright]}}
\underbar{\sc\Words example 8}
\startlily
global = {s1*12 \bar "|."}
music = { e'2 f' | g' f' | e'1 }

cls = #'(clI clII)
#(init cls)

#(begin
  (rm cls 10 music)
  (apply x-rm 'clII #{ c'8 c' c' #} (x-pos 10 13 '((n 8)(n 2 8)))))
\stoplily %\blank[2.1cm]%
\stophanging
%\stopfiguretext
%\blank
%\midaligned{ \tfd ------------}

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                                
\subject[ajouter-text]{Ajouter du texte et des citations musicales (quote)}
\blank[-2em]
%%%%%%%%
\func{txt}
\syntax {(txt text [dir [X-align [Y-offset]]])}{}

\type{text} is a {\em markup} \\
\type{dir} is the {\em direction} of \type{text} : %
\type{1} (or \type{UP}), \type{-1} (or \type{DOWN}), or by default \type{0} (automatic).\\
\type{X-align} is the {\em self-alignment-X} property value of \type{text} : \type{-1} by default.\\
\hbox{{\hspace[lilyindent]}
\starttable[|c|c|]  
\NC \type{X-align} \VL text alignment \NC\SR
\HL
\NC -1 or \type{LEFT}\VL to left \NC\FR
\NC 1 or \type{RIGHT}\VL to right \NC\MR
\NC 0 or \type{CENTER} \VL center \NC\LR
\stoptable 
}\\
\type{Y-offset} is the {\em Y-offset} property value of \type{text} : 0 by default\\
The function returns a zero-length {\em skip}.\\
\underbar{\sc\Words Exemple} :
\startmylily (txt "Hello" UP 0 -2) \stopmylily
is equivalent to :
\startmylily
s1*0 -\tweak self-alignment-X #CENTER 
     -\tweak Y-offset #-2 
     ^"Hello"  % &\em{&^ = UP &}&
\stopmylily
Note that setting one of the optional parameters \type{dir}, \type{X-align} or \type{Y-offset} to the value \type{#f}, has the same effect as omitting this parameter: its corresponding property is not modified.
\blank
\midaligned{ \tfd ------------}
\blank[-2em]
%%%%%%%%%
\func{adef}
\syntax {(adef music [text [dir [X-align [Y-offset]]]])}{}
Formats \type{music} with cue notes, like in a {\em \quotation {a def}} section . A text can be added   with the same arguments as the previous \type{txt} function.
\page
\reference[exemple9]{example9}
\underbar{\sc\Words Example 9} :
\blank[1em]
\setupnarrower[left=\lilyindent]
\defineparagraphs[mypar][n=2,before=,after={\blank[0.1em]},distance=0em]
\setupparagraphs[mypar][1][width=0.3\textwidth]
\setupparagraphs[mypar][2][before={\hspace[lilyindent]},rule=off]
%%%%
\startmypar
\startnarrower
\godown[1.3em]
Consider the following violin:
\stopnarrower
\mypar %%%%%
\mbox{\hspace[lilyindent] %
      \externalfigure[exemple09-violon.pdf][wfactor=265, align=flushleft]}
\stopmypar
%%%%
\startmypar
\startnarrower
\godown[0.7em]
and a flute beginning bar 4~:
\stopnarrower 
\mypar %%%%%
\godown[1.3em]
\startmylily (rm 'fl 4 (rel #{ f'4 g a b | c1 #})) \stopmylily
\stopmypar
\blank[big]
%%%%
\startmypar
\startnarrower
\godown[0.7em]
The following code~:
\stopnarrower
\mypar %%%%%
\startmylily
(add-voice2 'fl 3 (adef (em vl 3 4) "(violin)" DOWN))
(rm 'fl 4 (txt "play" UP))       
\stopmylily
\stopmypar
\blank[-2em] 
%%%%
\startmypar
\startnarrower
\godown[2.65em]
will produce the flute~:
\stopnarrower
\mypar %%%%%
\mbox{\hspace[lilyindent]%
      \externalfigure[exemple09-flute-en.pdf][wfactor=265, align=flushleft]}
\stopmypar
\blank[big]
The difference in size of a {\em \quotation {a def}} section from the current size is \type+adef-size = -3+. You can redefine \type+adef-size+ as you wish. For example, it can be:
\startmylily(define adef-size -2)\stopmylily
If we want to have, in the example above, the text: "(violin)" at the normal size, we must replace this text by the following {\em markup}:
\startmylily (markup (#:fontsize (- adef-size) "(violon)")) \stopmylily
\blank
\midaligned{ \tfd ------------}

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                              
\subject{Adding dynamics}
\blank[-2em]
%%%%%%%%
\func{add-dynamics}
\syntax {(add-dynamics obj pos-dyn-str)}{}

\type{obj} is a {\em music}, an {\em instrument}, or a list of {\em instrument}s.\\
\type{pos-dyn-str} is a {\em string}  "…", composed by a sequence of position-dynamics, separated by a slash~\type{/} (the slash is mandatory here).\\
The function analyzes the string \type{pos-dyn-str} and returns a code of the form:
\startmylily
(rm-with obj pos1 #{ <>\dynamics1  #}/ pos2 #{ <>\dynamics2 #} /…)
\stopmylily
For list positions, the \type{'} character can be omitted: 
\type{'(11 4 8)} $\Longrightarrow$ \type{(11 4 8)}.\\
For dynamics, all backslashes~\type+\+ {\em must} be removed. Direction symbols, on the other hand, \type+-^_+ are allowed. Several dynamics are separated with a space.
\godown[0.7em]
\underbar{\sc\Words Example}:
\godown[1em]
Taking the violin from the \in{previous example 9}{(page \at{}[adef])}[adef], the following code:
\startlily
(add-dynamics 'vl "1 mf / 2 > / 3 p cresc / (4 2) ^f")
\stoplily
will result in:\\
\mbox{\hspace[lilyindent]\externalfigure[exemple09-violon-nuances.pdf][wfactor=265, align=flushleft]}\\

- A position followed by no dynamic tells the function to search and delete the previous dynamic that would occur at the same {\em moment}.\\

- It is possible to specify adjustments of the position \type{X} and \type{Y} of a dynamic \type{dyn} by the following basic syntax (it will be adapted in most cases): \type{dyn#X#Y}.
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Something like: \type{mf#1#-1.5} will result to:
\startlily <>-\tweak self-alignment-X 1 -\tweak extra-offset #'(0 . -1.5) -\mf \stoplily
To replace the {\em zero} of the first element of the \type{extra-offset} pair, we can also put a third parameter between the other two. The general syntax then becomes:
\startlily dyn#val1#val3#val2 \stoplily
and it results to:
\startlily <>-\tweak self-alignment-X val1 -\tweak extra-offset #'(val3 . val2) -\dyn \stoplily 
A \type{val} value can be omitted but the number of \type{#} characters must match to the 
index 1,2 or 3~:\\
\hbox{{\hspace[lilyindent]}
\starttable[s0|ls2|c|l|]
 \NC \type{#val}   \NC \Longrightarrow \NC\JustLeft\type{val1} : \type{self-alignment-X val}\NC\FR
 \NC \type{##val}  \NC \Longrightarrow \NC\JustLeft\type{val2} : \type{extra-offset #'(0 . val)}\NC\MR
 \NC \type{##val#} \NC \Longrightarrow \NC\JustLeft\type{val3} : \type{extra-offset #'(val . 0)}\NC\MR
 \NC \type{##valA#valB} \NC \Longrightarrow \NC\JustLeft\type{val3,val2} : \type{extra-offset #'(valA . valB)}\NC\LR
\stoptable
}\\ % end of \hbox

- Regardless of these placement adjustments induced by the \type{\tweak} command, the \type{add-dynamics} function allows very precise placement of dynamics by judicious choice of its associated musical position. However, if it is easy, for example, to insert a dynamic at the position \type{'(3 64)}, there is a problem if a fourth starts at bar \type{3} because it will be cut at the 64\high{th} beat !\\
It would therefore be wise to create a special separate voice for the instrument \type{instru}, named \type{instruDyn} for example, made up only of \type{skip}s and which would receive all the \type{instru} dynamics.\\
Then simply combine that voice with the voice of notes and with \type{global}.The example at the beginning of the paragraph will become~:
\startlily
(def! 'vlDyn)  ; & \at{see page}{}[def!]. &
(add-dynamics 'vlDyn "1 mf / 2 > / 3 p cresc / (4 2) ^f")
…
\new Staff { << \global \vlDyn \vl >> }
\stoplily
Note that this is identical to the traditional way of proceeding, except that here there is no need to make calculations to find the adequate duration of the \type{skip}s between 2 dynamics. It's {\em arranger.ly} that takes care of it.\\
Also note that {\em arranger.ly} introduces a \goto{\type{sym-append} function}[sym-append], which is particularly well suited to the creation of these special voices. See the given example \at{at page}{}[sym-append], precisely with voices dedicated to dynamics.
\godown[0.5em]
\hairline
The following functions, \type{assoc-pos-dyn}, \type{extract-pos-dyn-str}, \type{instru-pos-dyn->music} and \type{add-dyn}, are attempts to further simplify the management of dynamics, in particular by avoiding 1) the redundant informations provided for instruments having the same dynamics at the same moments, and 2) to solve the problem of duplicate dynamics when, in orchestral scores, 2 instruments shares the same staff.
\hairline
\godown[1.8em]

\func{assoc-pos-dyn}
\syntax {(assoc-pos-dyn pos-dyn-str1 instru1 / pos-dyn-str2 instru2 /…)}{}
The \type{pos-dyn-str}s are strings as defined in the above \goto{\type{add-dynamics}}[add-dynamics] function.\\
\type{instru} is either a single \type{instrument} or a list of \type{instrument}s.\\
The function returns an {\em associated-list} consisting of {\em pairs} \type{'(pos-dyn-str . instru)}.\\  
The slashes~\type{/} are optional.
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\underbar{\sc example} :
\blank[0.8em]
\startmylily
vls = #'(vlI vlII) 
horns = #'(hornI … hornIV) 
all = #'(fl oboe cl …)
assocDynList = #(assoc-pos-dyn            
  "1 p" 'hornI / "5 mf" vls / 
  "25 f / (31 4) < " horns / 
  "33 ff / 35 decresc / 38 mf" all …)
\stopmylily
Dynamics for a single instrument, can then be extracted by setting \type{assocDynList} as last parameter of the 2 functions \type{extract-pos-dyn-str} or \type{instru-pos-dyn->music}.
\blank[1.2em]
\midaligned{ \tfd ------------}
\godown[1.2em]
%%%%%%%%
\func{extract-pos-dyn-str}
\syntax {(extract-pos-dyn-str extract-code assoc-pos-dyn-list)}{}
\type{assoc-pos-dyn-list} is the association list created with the \in{\type{assoc-pos-dyn}} [assoc-pos-dyn] function above.\\
The function \type{extract-pos-dyn-str} returns a {\em pos-dyn-str}, as defined in \in{\type{add-dynamics}}[add-dynamics]. It is the concatanation of all {\em pos-dyn-str}s whose associated {\em instrument}s return \quotation{true} to the \type{extract-code} predicate.
\blank[1em]
Here's how the \type{extract-code} predicate works:\\
- \type{extract-code} is either a single {\em instrument}, or a list of {\em instrument}s with one of the following three logical operators as the first element: \type{'or 'and 'xor}\\
For a single {\em instrument}, \type{extract-code} returns \quotation{true} when the list of  instruments associated with a particular {\em pos-dyn-str}, contains this instrument.\\
For 2 instruments, it depends on the operator:\\
\hbox{{\hspace[lilyindent]}
\starttable[|c|c|]  
\NC \type{extract-code} \VL associated list \NC\SR
\HL
\NC \type{'a} \VL contains \type{'a} \NC\FR
\NC \type{'(and a b)} \VL contains \type{'a} {\bold \underbar and} \type{'b} \NC\MR
\NC \type{'(or a b)} \VL contains \type{'a} {\bold \underbar or} \type{'b} \NC\MR
\NC \type{'(xor a b)} \VL contains \type{'a} but {\bold \underbar not} \type{'b} \NC\LR
\stoptable  
}\\
\underbar{\sc{Example}} :
\startmylily
horns = #'(hornI hornII hornIII)
assocDynList = #(assoc-pos-dyn            
    "1 p" 'hornI / "5 mf <" '(hornI hornII) / "6 ff > / 7 !" horns)   
%% &\em{&Simple extraction&}&
#(extract-pos-dyn-str 'hornIII assocDynList) 
   => "6 ff > / 7 !"
%% &\em{&Extraction with operator&}&
#(instru-pos-dyn-str '(or hornI hornII) assocDynList)
   => "1 p / 5 mf < / 6 ff > / 7 !" 
#(instru-pos-dyn-str '(xor hornI hornII) assocDynList)
   => "1 p"
#(instru-pos-dyn-str '(and hornI hornII) assocDynList)
   => "5 mf < / 6 ff > / 7 !"
\stopmylily
\blank[0.5em]
- More than 2 items to an operator are allowed. The third element is combined with the result of the operation of the first two.
\startmylily
'(and a b c) = '(and (and a b) c)
\stopmylily
\blank[0.2em]
- A list of {\em instrument}s can be made up of sub-lists. If a sub-list does not begin with an operator, its items are copied to the higher-level list.
\godown[1em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\func{instru-pos-dyn->music}
\syntax {(instru-pos-dyn->music extract-code assoc-pos-dyn-list)}{}
Same as \type{extract-pos-dyn-str} above, but the return string is converted using \type{add-dynamics},  into a {\em music} in the form:
\startmylily
{ <>\p s1*4 <>\mf s1*29 <>\ff }
\stopmylily
\blank[0.8em]
\midaligned{ \tfd ------------}
\blank[-2em]

%%%%%%%%
\func{add-dyn}
\syntax {(add-dyn extract-code)}{}
\type{(add-dyn extract-code)} is a macro (shortcut) of the function \type{instru-pos-dyn->music} above, which avoids specifying the last parameter \type{assoc-pos-dyn-list}. It is defined as follows:
\startmylily
#(define-macro (add-dyn extract-code)
   `(instru-pos-dyn->music ,extract-code assocDynList))
\stopmylily
So this macro will only work if you have defined an \type{assocDynList} variable:
\startmylily assocDynList = #(assoc-pos-dyn...) \stopmylily
\godown[-0.1em]
\hairline
Additional informations on \type{assocDynList} is provided \at{page}{ in the addendum II}[complément-assocDynList].
\hairline
\blank[0.1em]

\subject{Gérer les indications de tempo}  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Les 2 fonctions qui suivent sont utilisées dans l'%
\in{addendum concernant \type{global}}[addendum1]\at{page}[addendum1].
\blank[-2em]
%%%%%%%%
\func{metronome}
\syntax {(metronome mvt note x [txt [open-par [close-par ]]])}{}
Renvoie un {\em markup} equivalent à celui produit par la fonction \type{\tempo}\\
- \type{mvt} est un {\em markup} indicatif du mouvement du morceau. Par exemple : "Allegro" \\
- \type{note} est une {\em chaine de caractères} représentant une valeur de note : "4." par ex pour une noire pointée, "8" pour une croche.\\
- \type{x} représente soit un tempo métronomique si \type{x} est {\em entier}, soit comme pour l'argument précédent, une {\em chaîne} représentant une valeur de note. Voir exemple ci-dessous (fonction \type{tempos}).\\
- Optionnellement, la variable \type{txt} permet de rajouter, après l'indication métronomique, un texte tel que "env" ou "ca.".\\
- Grâce aux variables \type{open-par} et \type{close-par}, on peut changer (ou supprimer, en mettant "") les parenthèses ouvrantes et fermantes entourant l'indication métronomique.
\blank
\midaligned{ \tfd ------------}
\godown[0.5em]

%%%%%%%%
\func{tempos}
\syntax {(tempos obj pos1 txt1 [space1] / pos2 txt2 [space2] / …)}{}
Insert dans \type+\global+ et à la position \type+pos+, l'indication métronomique %
\type+\tempo txt+.\\
Si un nombre \type{space} est spécifié, le {\em markup} \type{txt} est déplacé horizontalement de $+$ ou $-$ \type{space}s unités vers la droite ou la gauche.\\
Les barres obliques \ sont optionnelles.

\underbar{\sc\Words Exemple} :
\startmylily
(tempos 1 "Allegro" / 50 (metronome "Andante" "4" 69) /
      100 (metronome "Allegro" "4" "8") -2 ; &\tfx\em{&sera déplacé de 2 unités vers la gauche&}&
      150 (markup #:column ("RONDO" (metronome "Allegro" "4." "4")))
\stopmylily
\blank
\midaligned{ \tfd ------------}
%\page%[preference]

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                              
\subject{Manipuler les listes}
Outre les fonctions de base \type{cons} et \type{append} de {\em\sc GUILE}, on pourra avoir besoin des 3 ou 4 fonctions suivantes.
\blank[-2em]
%%%%%%%%
\func{lst} (\type{lst} et également \type{flat-lst}) 
\syntax {(lst obj1 [obj2…])}{}
\index{flat-lst}

\type{obj1}, \type{obj2…} sont des {\em instrument}s ou des listes d'{\em instrument}s.\\
Renvoie une liste de tous les {\em instrument}s donnés en paramètres\\

\underbar{\sc\Words Exemple} :
\startmylily
tpettes = #'(tpI tpII)
cors = #'(corI corII) 
tbnes = #'(tbnI tbnII)
cuivres = #(lst tpettes cors tbnes 'tuba)
\stopmylily
La dernière instruction est équivalente à :
\startmylily
cuivres = #'(tpI tpII corI corII tbnI tbnII tuba)
\stopmylily
\type{lst} garde intacte les sous listes de listes.\\
Avec :
\startmylily
tpettes = #'(tpI (tpII tpIII))
\stopmylily
le résultat serait
\startmylily
cuivres = #'(tpI (tpII tpIII) corI corII tbnI tbnII tuba)
\stopmylily
Si ce n'est pas le résultat escompté, on peut utiliser la fonction \type{flat-lst} (même syntaxe), qui, elle, renvoie une liste composée uniquement d'{\em instrument}s, quelque soit la profondeur des listes données en paramètres.

\blank
\midaligned{ \tfd ------------}

%%%%%%%%%
\func{lst-diff}
\syntax {(lst-diff mainlist . tosubstract)}{}
Enlève de \type{mainlist} les {\em instrument}s spécifiés dans \type{tosubstract}.\\
\type{tosubstract} est une suite d'{\em instrument}s ou de listes d'{\em instrument}s

\blank
\midaligned{ \tfd ------------}

%%%%%%%%%
\func{zip}
\syntax {(zip x1 [x2…])}{}
\type{x1}, \type{x2…} sont des listes standard (non circulaires, prédicat \type{proper-list?}).\\
La fonction re-définit la fonction \type{zip} de {\sc guile}, en permettant l'ajout de tous les éléments des plus grosses listes. La fonction \type{zip} originale de {\sc guile} a été renommée \type{guile-zip}.
\startmylily
(guile-zip '(A1 A2) '(B1 B2 B3)) & $\Rightarrow$ & '((A1 B1) (A2 B2))
      (zip '(A1 A2) '(B1 B2 B3)) & $\Rightarrow$ & '((A1 B1) (A2 B2) (B3))
\stopmylily
Si on a définit les listes et musique suivantes : 
\startmylily
tpettes = #'(tpI tpII tpIII)
clars = #'(clI clII clIII) 
saxAltos = #'(altI altII)
music = \relative c' { <c e g> <d f b> }
\stopmylily
Le code suivant :
\startmylily
(dispatch-chords (zip tpettes clars saxAltos) 6 music)
\stopmylily
donnera à la mesure 6 :
\startmylily
'(tpI clI altI)    & $\leftarrow$ & { g b }
'(tpII clII altII) & $\leftarrow$ & { e f }
'(tpIII clIII)     & $\leftarrow$ & { c d }
\stopmylily

\blank
\midaligned{ \tfd ------------}

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                                                                 
\subject{Fonctions diverses}
\blank[-2em]   
                                   
%%%%%%%%
\func{sym-append}
\syntax {(sym-append 'sym}{to-begin?)}
Ajoute à la fin d'un nom de symbole le suffixe \type{sym}. Si \type{to-begin?} est à \type{#t}, \type{sym} devient un préfixe (collé au début).\\
Cette fonction s'applique à un {\em symbole} ou à une liste de {\em symbole}s.\\
En l'associant à la fonction \in{\type{def!}}[def!]\at{de la page}{}[def!], on peut créer automatiquement des musiques de la {forme \type+{s1*…}+}, de la même longeur que le morceau, et pouvant être associées à chacun des instruments (pour mettre par exemple les nuances dans des voix séparées).
\blank[0.5em]
\startmylily
all = #'(oboeI oboeII clarinet violinI violinII viola cello)
#(define dyn-append (sym-append 'Dyn))        % &\tfx\em{& 'instru => 'instruDyn&}&
#(begin
   (def! (dyn-append all))   ;; &\tfx\em{&déclaration et initialisation de oboeIDyn, oboeIIDyn …&}&
   (add-dynamics 'clarinetDyn "1 p / 4 f …")  ;; &\tfx\em{& ajout des nuances&}&
   (add-dynamics '(oboeIDyn oboeIIDyn) "2 p < / 4 f …")
  …)
\stopmylily
\blank[0.5em]
Dans les parties séparées ou le conducteur, on mettra~:
\blank[0.5em]
\startmylily
\new Staff << \global \oboeI \oboeIDyn >>
\new Staff << \global \oboeII \oboeIIDyn >>
\new Staff << \global \clarinet \clarinetDyn >> …
\stopmylily
\blank[0.5em]
On pourra alors, vouloir alléger l'écriture des \type{\new Staff}. C'est ce qui est proposé dans \goto{l'addendum II}[addendum2], de la \at{page}[addendum2], avec la fonction \type{part->music}.
\blank[0.8em]
\midaligned{ \tfd ------------}
\godown[0.8em]

%%%%%%%%
\func{set-del-events}
\syntax {(set-del-events event-sym . args)}{}
Supprime tous les évenements de nom\footnote {Un nom d'événement commence par une majuscule, et se termine par "Event". Exemple : {\em 'SlurEvent}} \type{event-sym} \\
Plusieurs événements peuvent être spécifiés à la suite, et même sous forme d'une liste.\\
Ainsi, la liste nommée \type{dyn-list}, définie dans {\em "chordsAndVoices.ly"} de la manière suivante :
\blank[0.5em]
\startmylily
#(define dyn-list '(AbsoluteDynamicEvent CrescendoEvent DecrescendoEvent))
\stopmylily
\blank[0.5em]
permet, utilisée avec la fonction \type{set-del-events}, d'effacer toutes les nuances d'une portion de musique et éventuellement de les remplacer par d'autre :
\blank[0.5em]
\startmylily
#(let((del-dyn (set-del-events dyn-list))
   (apply-to 'trompette del-dyn 8 12)
   (add-dynamics 'trompette "8 p / 10 mp < / 11 mf"))
\stopmylily
\blank[0.8em]
\midaligned{ \tfd ------------}
\godown[0.8em]

%%%%%%%%
\func{n-copy}
\syntax {(n-copy n music)}{}
\index{set-ncopy}
or : (2\high{nd} equivalent form, to be used with \goto{\type{apply-to}}[apply-to])
\syntax {((set-ncopy n) music)}{}
Copie \type{n} fois \type{music}.
\blank[0.3em]
\midaligned{ \tfd ------------}
\page

%%%%%%%%
\index{index->string-letters}
\func{def-letters}
\syntax {(def-letters measures [index->string][start-index][show-infos?])}{}
La fonction associe des lettres aux mesures contenues dans la liste : \type{measures}. Elle convient particulièrement quand \type{Score.markFormatter} est de la forme \type{#format-mark-[…]-letters}.\\
Les 3 paramètres suivant \type{measures} sont optionnels et se distinguent uniquement par leur type.\\
\type{index->string} est une fonction de rappel renvoyant une {\em chaîne de caractères}, et prenant en paramètre un {\em index} (un entier positif). L'index est incrémenté de 1 à chaque appel, en commençant par la valeur du paramètre \type{start-index} (\type{0} si \type{start-index} non spécifié).\\
Par défaut, \type{index->string} est la fonction interne \type{index->string-letters} qui renvoie la ou les lettre(s) capitale(s) correspondante(s) à leur index dans l'alphabet, mais en sautant la lettre~"\type{I}"~:
\blank[0.3em]
\hbox{\hspace[lilyindent]"\type{A}"…"\type{H}" puis "\type{J}"…"\type{Z}" puis "\type{AA}"…"\type{AH}" 
puis "\type{AJ}"…"\type{AZ}" etc…}
\blank[0.3em]
L'instruction : \type {#(def-letters '(9 25 56 75 88 106))} donne les correspondances suivantes :\\
\midaligned{\hbox{\hspace[lilyindent]
\starttable[s0|cs1|c|ls2|]
 \NC \type{A} \NC $\Longrightarrow$ \NC mesure \type{9} \NC\FR
 \NC \type{B} \NC $\Longrightarrow$ \NC mesure \type{25} \NC\MR
 \NC \type{F} \NC $\Longrightarrow$ \NC mesure \type{106} \NC\MR
 \NC \type{G} \NC $\Longrightarrow$ \NC <erreur> \NC\LR
\stoptable
\hspace[threelilyindent]
\starttable[|cs1|c|ls2|]
 \NC \type{(+ A 2)} \NC $\Longrightarrow$ \NC mesure \type{11} \NC\FR
 \NC \type{'(A 4 8)} \NC $\Longrightarrow$ \NC <erreur> \NC\MR
 \NC \type{`(,A 4 8)} \NC $\Longrightarrow$ \NC position \type{'(9 4 8)} \NC\MR
 \NC \type{(list (+ A 2) 4 8)} \NC $\Longrightarrow$ \NC position \type{'(11 4 8)} \NC\LR
\stoptable
\hspace[lilyindent]
}} % end of \hbox
Si une lettre était déja définie avant l'appel de \type{def-letters}, la fonction fait précéder la lettre par le caractère "\type{_}". Ceci est surtout nécessaire pour les lettres \type{X} et \type{Y}, qui ont déjà une valeur associée dans {\em Lilypond} (\type{0} et \type{1}). Ces  2 lettres deviendront donc {\em toujours} \type{_X} et \type{_Y}. Un message prévient l'utilisateur du changement, sauf si on inclut \type{#f} dans les options (paramètre \type{show-infos?}) :
\startmylily #(def-letters '(9 25 …) #f) \stopmylily
\blank[0.8em]
\midaligned{ \tfd ------------}
\godown[-1.3em]

%% set-frag is not ready enough (bugs remains). Perhaps in a future version of arranger.ly
                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                                                 
%\subject{"Baliser" une musique}
%\godown[0.3em]
%\underbar{Rappel}
%\blank[0.56em]
%Le fichier {\em addAt.ly} permet de travailler avec des balises qui permettent de répérer un fragment  particulier d'une musique. Deux fonctions y sont définies : \type{\anchor} (balise) et \type{\musicAt}.
%\startlily
%music = \relative c' {
%  \anchor #'A  c4 c c c
%  \anchor #'B  d d d d
%  \anchor #'C  e e e e
%  }
%\musicAt #'A  %%&\em{& => { c c c c } &}&
%\musicAt #'B  %%&\em{& => { d d d d } &}&
%\musicAt #'C  %%&\em{& => { e e e e } &}&
%\stoplily
%Noter que chaque \type{\anchor} re-initialise le mode \type{\relative} à \type{c'} avec la fonction \type{ \resetRelativeOctave}~: tous les \type{\anchor}s sont donc relatif au do central.\\
%{\em arranger.ly} étend la capacité de balisage\\
%%%%%%%%%
%\func{set-frag}
%\syntax {((set-frag music) sym)}{}

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                                                 
\subject{Compiler une portion de score}
\godown[1.2em]
%%%%%%%%
\func{show-score}
\syntax {(show-score from-pos to-pos)}{}

Insert dans \type+\global+, des \type+\set Score.skipTypesetting = ##t+ ou \type+##f+,  de manière à ne compiler (et ne montrer) que la musique de la partition se trouvant entre les positions \type+from-pos+ et \type+to-pos+ (utile pour les gros "scores").
\blank[0.8em]
\midaligned{ \tfd ------------}
\godown[-1.2em]                     

                     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                              
\subject{Exporter ses instruments}
\godown[1.2em]                                        
%%%%%%%%
\func{export-instruments}
\syntax {(export-instruments instruments filename}{overwrite?)}

\type{instruments} est la liste d'{\em instrument}s à exporter.\\
\type{filename} est le nom du fichier dans lequel sera effectué l'export, dans le répertoire courant .\\
On obtient un fichier~{\em ly} classique avec des déclarations de la forme 
\startmylily
instrument-name = { music … }
\stopmylily
(Les notes seront écrites en mode absolu).\\
Si \type{filename} existe déjà, les definitions des instruments seront ajoutées à la fin du fichier, sauf si \type{overwrite?} est mis à  \type+#t+ : l'ancienne version est alors effacée !\\
\hairline
Cette fonction est encore au stade expérimental ! Agir avec prudence.
\hairline
\page


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\starttitle[
  reference=addendum1,
  title={-ADDENDUM I-\\CONSTRUIRE \type+\global+ AVEC «arranger.ly»},
  list={ADDENDUM I : CONSTRUIRE \type+\global+}
  ]

%[addendum1]{ADDENDUM\\CONSTRUIRE \type+\global+ AVEC «arranger.ly»}

\type+\global+ est généralement assez fastidieux à entrer car on doit calculer «à la main» la durée séparant 2 événements (entre 2 \type+\mark\default+ par exemple) . \\        
Voici comment «{\em arranger.ly }» peut  faciliter la vie du codeur, sur un morceau de 70 mesures, contenant  changements de mesures, changements d'armures, de tempos etc…
\startlily
global = { s1*1000 }                  %%&\em\tfx{& On prévoit une grande longueur&}&
#(init '())                           %%&\em\tfx{& Liste d'instruments d'abord vide =>&}&
     %%&\em\tfx{& les positions tiennent compte des insertions précédentes.  &}&
     %%&\em\tfx{& ( \global est ré-analysé à chaque fois. ) &}&
#(begin                               ;;&\em\tfx{& Construction de \global&}&
(rm-with 'global 1 #{ \time 3/4 #} /  ;;&\em\tfx{& D'abord les signatures&}&
                10 #{ \time 5/8 #} /
                20 #{ \time 4/4 #})
(cut-end 'global 70)                  ;;&\em\tfx{& On coupe ce qui est en trop&}&                         
(x-rm 'global #{ \mark \default #}    ;;&\em\tfx{& Les repérages&}&
         10 20 30 40 50 60)
(tempos                               ;;&\em\tfx{& Les indications de tempos&}&
   1 (metronome "Allegro" "4" 120) / 
  10 (metronome "" "8" "8") /
  20 (metronome "Allargando" "4" "4.")
  30 "Piu mosso"
  60 (markup #:column ("FINAL" 
                       (metronome "Allegro vivo" "4" 200))))
(rm-with 'global 1 #{ \key c \major #} /  ;;&\em\tfx{& Les armures&}&
                20 #{ \key c \minor #} /
                30 #{ \key c \major #})
(x-rm 'global #{ \bar "||" #} 20 30 60)   ;;&\em\tfx{& Les barres&}&
(rm-with 'global 1 #{ \markLengthOn #})   ;;&\em\tfx{& Choses diverses&}&  
(rm 'global 70 #{ \bar "|." #})           ;;&\em\tfx{& La touche finale&}&
)                                         %%&\em\tfx{& Fin \global&}&
            %%&\em\tfx{& On peut maintenant initialiser la liste d'instruments&}&
#(init '(test))   %%&\em\tfx{& Liste non vide = métrique fixée : tout ajout sera ignoré&}&              
\new Staff { << \global \test >> }
\stoplily

%\startfiguretext[middle][exemple7]{}
{\externalfigure[exemple10.pdf][wfactor=fit]}
%\stopfiguretext
\midaligned{\underbar{\sc\Words exemple 10}}
\stoptitle

\starttitle[
  reference=addendum2,
  title={-ADDENDUM II-\\S'ORGANISER},
  list={ADDENDUM II : S'ORGANISER}
  ]

Voici quelques idées d'organisation pour la création d'un arrangement pour une grosse formation. Quelques fonctions sont ici proposées, mais notez bien qu'elles ne font {\em pas} parties de {\em arranger.ly}. Il faudra recopier leurs definitions si on desire les utiliser.\\

{\tfa\bf→} {\bf Structure des fichiers.}

\hbox{{\hspace[lilyindent]}
\starttable[s0|ls2|c|c|]
 \NC fichiers \NC utilité \NC \type{\include}\SR
 \HL
 \NC init.ily \NC \type{global = {…}} et (\type{init all})\NC"arranger.ly"\NC\FR
 \NC NOTES.ily \NC remplissage des instruments\NC "init.ily" et en fin de fichier "dynamics.ily" \NC\MR
 \NC dynamics.ily \NC \type{assocDynList = …} \NC - \NC\MR
 \NC SCORE.ly \NC le conducteur \NC "NOTES.ily" \NC\MR
 \NC parts/instru.ly \NC parties séparées \NC "../NOTES.ily" \NC\LR
\stoptable
}\\ % end of \hbox

{\tfa\bf→} {\bf Instrument dans partie séparée vs instrument dans conducteur.}\\
On peut vouloir que certains réglages d'un instrument varient quand il est édité en partie séparée, ou bien  dans un conducteur. Voici comment avoir un code source conditionnel.\\

Placer, en tête de chacune des parties séparés,  l'instruction :
\startmylily #(define part 'instru) ;;&\em\tfx{& 'instru instrument définit dans (init…)&}&\stopmylily
et en tête du conducteur, l'instruction :
\startmylily #(define part 'score) \stopmylily
On ajoutera, dans le fichier {\em init.ily} par exemple, la fonction \type{part?} suivante :
\startmylily 
#(define (part? arg) (and (defined? 'part)
                          (if (list? arg)(memq part arg)
                                         (eq? part arg))))
\stopmylily
On pourra alors utiliser dans le code, l'instruction \type{(if (part? 'instru) val1 val2)}, ou bien 
\type{(if (part? '(instruI instruII)) val1 val2)}.\\
Dans le code suivant, le texte sera aligné à gauche dans le conducteur et à droite dans la partie d'euphonium :\type{ (rm 'euph 5 (txt "en dehors" UP (if (part? 'score) LEFT RIGHT))) }\\


{\tfa\bf→} {\bf Parties séparées : allègement de code - fonction \type{instru->music}}
\index{obj->music}
\index{instru->music}
\\
Préalable : avoir défini \type{assocDynList} (dans le fichier {\em dynamics.ily})\\
\type{instru->music} utilise \type{obj->music}, une fonction qui renvoie la musique associée à un instrument \footnote{\type{(obj->music 'clar)} renvoie \type{clar}}, et la fonction \type{make-clef-set} (définie dans le répertoire {\em Lilypond}, fichier \type{scm/parser-clef.scm}), qui est l'équivalent scheme de \type{\clef}.
\startmylily
#(define* (instru->music instru #:optional (clef "treble"))
    (sim (make-clef-set clef) global (obj->music instru) (add-dyn instru)))
\stopmylily
Les parties séparées en clef de sol, pourront être éditées simplement avec :
\startmylily \new Staff { $(instru->music 'vlI) } \stopmylily
Les autres parties devront spécifier la clef :
\startmylily
\new Staff { $(instru->music 'viola "alto") } ;; &\tfx\em{&clef d'ut 3&}&
\new Staff { $(instru->music 'vlc "bass") } ;; &\tfx\em{&clef de fa&}&
\stopmylily
Notez que si vous avez mis en tête de fichier \type{#(define part 'instru)}, comme expliqué dans le paragraphe précédent, on peut remplacer le nom de l'instrument par le mot \type{part} :
\startmylily \new Staff { $(instru->music part [clef]) } \stopmylily
\godown[1em]

\index{split-instru}
{\tfa\bf→} {\bf Conducteur : gérer 2 instruments sur une même portée - fonction \type{split-instru}}\\
La fonction ci-dessous permet d'éviter les nuances en double. Elle met en un exemplaire les nuances communes en bas de la portée; seules les nuances n'appartenant qu'à la voix du haut se trouveront au dessus de la portée.
\page
\startmylily
#(define* (split-instru instru1 instru2 #:optional (clef "treble"))
   (split                    ; &\tfx\em{& << … \\ … >>&}&
      (sim                   ; &\tfx\em{& << … >> &}&
         (make-clef-set clef)
         global
         dynamicUp           ; &\tfx\em{& nuances au dessus de la portée &}&
         (add-dyn (list 'xor instru1 instru2))
         (obj->music instru1))
      (sim 
         (add-dyn instru2)
         (obj->music instru2))))
%% &\tfx\em{& Dans le conducteur &}&  %%
\new Staff { $(split-instru 'clarI 'clarII) }
\stopmylily
\blank[0.8em]
Pour un conducteur avec 3 cors par exemple , on peut utiliser \type{instru->music} et \type{split-instru}~:
\startmylily
\new StaffGroup <<
  \new Staff \with { instumentName = #"cor 1" } 
                 $(instru->music 'corI)
  \new Staff \with { instumentName = 
                            \markup \vcenter {"cor " \column { 2 3 }}}
                 $(split-instru 'corII 'corIII) >>
\stopmylily

À la place de \type{split-instru}, on pourra préférer une fonction \type{part-combine-instru}. Il suffira dans la fonction de remplacer \type{split} par \type{part-combine}.\\

\reference[complément-assocDynList]{}
{\tfa\bf→} {\bf Supplement for the use of \type{assocDynList}.}
\blank[0.6em]
{\bf-} Customing dynamics:
\blank[0.3em]
\startmylily
pocodim = #(make-dynamic-script (markup #:normal-text #:italic "poco dim"))
piuf = #(make-dynamic-script (markup #:normal-text #:italic "più"
                                     #:dynamic "f"))
assocDynList = #(assoc-pos-dyn
  "1 f / 5 pocodim / 8 mf / (10 4) piuf / 12 fff" all)  % &\tfx\em{&(tous les instuments) &}& 
\stopmylily
\blank[0.7em]

{\bf-} Enlever une nuance et la remplacer par une autre :\\
Pour mettre, par exemple, \type{ff} mesure 12 à la trompette à la place de \type{fff}, il faut d'abord annuler la précédente avec une nuance "vide", sinon Lilypond nous signale une nuance en double.
\blank[0.3em]
\startmylily
assocDynList = #(assoc-pos-dyn
  "1 f / 5 pocodim / 8 mf / 10 piuf / 12 fff" all      ;&\tfx\em{& tous (dont trompette)&}& 
  "12 / 12 ff" 'tp )			              %&\tfx\em{& trompette mes 12 : fff -> ff&}&  
\stopmylily
\blank[0.7em]

{\bf-} Pour alléger le nombre de nuances d'un conducteur dans, par exemple un grand {\em crescendo} orchestral contenant "\type{cresc - - -}" à chaque instruments, on peut utiliser la fonction \type{part?} décrite ci-dessus, afin que la suppression ne soit effective que dans le conducteur.
\blank[0.3em]
\startmylily
#(if (part? 'score) ;&\tfx\em{& on allège le conducteur&}&
 (set! assocDynList (append assocDynList (assoc-pos-dyn
   "15 / 18" '(&\tfx\em{& [list des instruments dont on supprime les nuances mes 15 et 18]&}& )))))
\stopmylily
\blank[0.7em]

{\bf-} On peut définir les positions par des variables (voir fonction \goto{\type{def-letters}}[def-letters]\at{ page}[def-letters]) et les utiliser dans \type{assocDynList} sans se soucier des caractères {\tfb '} {\tfb `} ou {\tfb ,} à mettre habituellement devant les listes et les symboles.
\startmylily 
A = #9           %&\tfx\em{& un numéro de mesure&}& 
B = #'(2 8 16)   %&\tfx\em{& des temps à l'intérieur d'une mesure&}& 
assocDynList = #(assoc-pos-dyn
       "A p / (A 2 8) mp / (+ A 3) mf / ((+ A 3) 2 8) f" 'instruI
  ; => "9 p / (9 2 8) mp / 12 mf      / (12 2 8) f"
       "(cons 18 B) < / (cons 21 B) !" 'instruII
  ; => "(18 2 8 16) < / (21 2 8 16) !"
\stopmylily

\stoptitle
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
 
\title[index]{INDEX}
\placeindex[level=title]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\stoptext
