%%%%%% Documentation française de arranger.ly. Version YYYY/MM/DD = 2023/09/11 %%%%%%
%% À compiler avec : ConTeXt (LuaTex)
%% https://wiki.contextgarden.net/Main_Page

%\setupsynctex[state=start,method=min] : ne fonctionne plus !!!
\setuplayout[header=1cm, topspace=0.5cm, margin=0.5cm, height=middle, width=middle]
%\showframe
%\showlayout
%\showsetups

\language[fr] % français
\definebodyfontenvironment[default][em=italic]
\setupbodyfont[11pt]

\setuppagenumbering[location={footer}, left={-},right={-}]
\setuphead[title][align=center,style=bold, incrementnumber=yes, number=no]
\setuphead[subject][textstyle={\bold},after=\nowhitespace, incrementnumber=yes, number=no]
%\setuphead[section][after=\nowhitespace,before=\nowhitespace]  
\setuphead[subsection][before={\blank[-3.5em]}] %  \nowhitespace n'est pas suffisant
                          
\setupitemize[before=\nowhitespace]

\setuplist[title][align=center,style=bold, alternative=a, pagenumber=no, before={\blank[0.3cm]}, after={\blank[0.1cm]}]
\setuplist[subject,chapter,subject,subsubject,section,subsection][alternative=c]
\setuplist[subsection][margin=1.5em]
%\setuplist[title][align=center,style=bold, alternative=a]
%\setupheadtext[content=Sommaire]
\setupcombinedlist[content][list={title,chapter,subject,subsubject,section,subsection}]


\def\lilyspace{0.7cm}
\definehspace[lilyindent][0.7cm]
\definehspace[threelilyindent][2.1cm]
\definetyping[lily][margin=\lilyspace, page=yes, escape={&,&}]
\definetyping[mylily][margin=\lilyspace, space=fixed, before=\nowhitespace, after=\nowhitespace, escape={&,&}]

\def\myindent{\hphantom{0}\hspace[lilyindent]}

\defineframed[noframed][frame=no]

%% URL
\useURL[chord][http://gillesth.free.fr/Lilypond/chordsAndVoices/]
\useURL[changePitch][http://gillesth.free.fr/Lilypond/changePitch/]
\useURL[copyArticulations][http://gillesth.free.fr/Lilypond/copyArticulations/]
\useURL[addAt][http://gillesth.free.fr/Lilypond/extractMusic/]
\useURL[extractMusic][http://gillesth.free.fr/Lilypond/extractMusic/]
\useURL[checkPitch][http://gillesth.free.fr/Lilypond/chordsAndVoices/]
\useURL[copyArticulations-LSR][http://lsr.di.unimi.it/LSR/Item?id=769]
\setupinteraction[state=start,color=black,contrastcolor=black, style=\tf]

\setupexternalfigures[directory={exemples}]   % répertoire des images

%%%%% fonction \syntax
\define[2]\syntax
{% Affiche => syntaxe : #1 #2
\blank
\hbox{\hspace[lilyindent]{\em {\small $\triangleright$} syntaxe }{: }% 
\doifemptyelse{#2}%
{\inframed{\type{#1}}}%
{\vcenter\framed[location=middle, width=fit, height=fit]{%% \inframed ne centre pas verticalement :-(
\vtop{{\hbox{\type{#1}}}%
      {\hbox {\hspace[threelilyindent] {\ttsl \#:optional} \type{#2}}}}}}%
}%
\blank
}

%%%%% fonction \func
\define[1]\func
{ % Affiche => La fonction #1
 %% \index{#1}   % <- #1 peut se terminer par le caractère + qui ne sera alors pas affiché :-(
 %% On remedie au problème avec lua :
 \ctxlua{context.index((string.gsub("#1","+", "\\textplus")))}  %% remplace dans l'index tout caractère + par \textplus
              %% Noter les doubles parenthèses pour forcer une seule valeur de retour de gsub
              %% https://wiki.contextgarden.net/Programming_in_LuaTeX
 \startsubsection[number=no,list=#1,reference=#1]{}
 %\startsubsubject[list=#1,reference=#1]{}   % ne marche pas !
 {\switchtobodyfont[20pt] \checkmark} 
 {\sca la fonction \cap{\bf #1}}
 %\stopsubsubject
 \stopsubsection
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Début du document %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\starttext

%%%%%% Page de titre
\startstandardmakeup
\midaligned{\tfd\sc Arranger.ly}
\blank[2cm]
\midaligned{\tfd ---}
\stopstandardmakeup

%%%%%% Sommaire
\midaligned{\bf \underbar Sommaire}
\placecontent[criterium=all]

%%%%%% Chapitre 1 ...
\title[generalites]{GÉNÉRALITÉS}
\subject[objectifs]{Objectif de arranger.ly :}
{\em fournir un environnement facilitant l'arrangement musical\footnote{On entend par arrangement musical la ré-orchestration d'une instrumentation originale}}. Un ensemble de fonctions devront permettre une ré-orchestration rapide, à partir d'un encodage de musique minimal et réutilisable.
\blank[0.7em]
Un des aspects principaux de {\em arranger.ly} concerne le repérage d'une position musicale, qui sera basé désormais sur les {\em numéros de mesures}\footnote {Lilypond utilise un système basé sur les {\em moment}s : \type{(ly:make-moment 5/4)} par exemple.}. Les méthodes de travail de l'arrangeur s'en trouveront assouplies car il sera désormais possible de travailler non pas de manière linéaire (mesure par mesure et instrument par instrument) mais plus au fils de ses idées : on s'occupe des instruments qui font le thème, puis ceux qui font l'accompagnement, les basses etc…
\blank[0.7em]
Typiquement, au départ, l'utilisateur déclare une liste d'instruments, et {\em arranger.ly} se charge lui-même d'initialiser les instruments de cette liste par des mesures à compter.

L'utilisateur peut ensuite, en une seule commande, insérer un fragment de musique à plusieurs {\em instruments} à la fois, en plusieurs {\em endroits} à la fois, et {\em «copier-coller »} des sections entières de musique en une seule ligne de code.

Des fonctions permettront ensuite, d'octavier ou doubler à l'octave une section de musique, d' utiliser des «patterns» pour des rythmes ou des articulations qui se répètent, d'assigner chaque note d'une série d'accords à des instruments, de renverser les accords etc…, l'objectif étant de ne pas avoir à répéter une information plus d'une fois.

Toutes ces fonctions seront utilisables directement au niveau scheme, ce qui allège la syntaxe (pas de \type{\}  devant les noms de variables, pas de \type{#} devant les numéros de mesures etc …), et rend une manipulation des listes d'instruments plus aisée.

Enfin, une fois l'arrangement fini, une fonction permettra d'exporter éventuellement son code source de la manière  habituelle :
\blank[0.3em]
\startmylily
flute = {…}
clar = {…}
etc…
\stopmylily
\godown[-0.3em]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subject {Pré-requis logiciels :}
\startitemize[2,joinedup,intro]
\item Lilypond 2.24 ou supérieur
\item Le fichier {\em arranger.ly} nécessite les fichiers \type{include} suivants :
  \starttabulate[|l|l|,before={\blank[1mm]},after={\blank[1mm]}, indenting=yes]
    \NC {\textbullet \hspace[1] \em chordsAndVoices.ly} \NC\small {(\from[chord])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em changePitch.ly} \NC\small{ (\from[changePitch])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em copyArticulations.ly} \NC\small{(\from[copyArticulations])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em addAt.ly} \NC\small{(\from[addAt])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em extractMusic.ly} \NC\small{ (\from[extractMusic])} \NC
    \NR
    \NC {\textbullet \hspace[1] \em checkPitch.ly} \NC\small{ (\from[checkPitch])} \NC
    \NR
  \stoptabulate 
\stopitemize
Le plus simple est de mettre tous ces fichiers (7 au total avec {\em arranger.ly})
dans un même répertoire et d'appeler Lilypond avec l'option \type{-include=monrépertoire}. Seule la ligne suivante est alors à ajouter, en début de son fichier ly :\\
\myindent\type{\include } \type{"arranger.ly"} % pbs d'espace avec \type{\include "arranger.ly"}
\godown[-0.3em]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subject{Les 2 préalables à l’utilisation des fonctions}
\startitemize[n]
\item Spécifier une variable \type+\global+ contenant tous les changements de mesure de la partition.\\
Par ex :
\startmylily global = { \time 4/4 s1*2 \time 5/8 s8*5*2 \time 3/4 s2.*2 } \stopmylily
{\em arranger.ly} pourra alors convertir les numéros de mesures en {\em moment} Lilypond. 
\item Appeler la fonction \goto{\type{init}}[init] décrite \at{page}[init] pour déclarer les noms des {\em instrument}s au parser. Cet appel {\em doit} précéder toute utilisation des fonctions qui vont suivre.
\stopitemize 
\page 
%%%%%%%%%%%%%%%%%

\subject{Conventions et rappels}
Dans ce document, nous appellerons {\em instrument} tout
symbole scheme référençant une {\em musique} Lilypond. \\
La {\em musique} référencée par un {\em instrument} a basiquement la même
longueur que \type{\global} et commence en même temps (mesure 1 par défaut, avec parfois, une levée (… une {\em anacrouse})).
Cependant, plus généralement, dans les fonctions qui vont suivre,
quand on parlera de {\em musique}, il s'agira d'un fragment qui n'a
pas de position définie, et que l'on pourra insérer à n'importe quelle
mesure du morceaux.

Comme tout symbole, le nom d'un {\em instrument} sera précédé dans un bloc scheme, du  \hbox{caractère \type{'}}\\
\myindent ex : \type{'flute}\\
Dans un bloc Lilypond, il faudrait en plus rajouter un \type+#+\\
\myindent ex : \type+#'flute+\\
Le nom seul \type{flute} quant à lui, est, dans un bloc scheme,
équivalent à \type+\flute+ dans un bloc Lilypond.

Une liste d'{\em instrument}s peut s'écrire, dans un bloc scheme :

\startmylily '(flute hautbois clarinette)\stopmylily
où bien

\startmylily(list 'flute 'hautbois 'clarinette)\stopmylily
Une liste de {\em musique}s s'écrira

\startmylily(list flute hautbois clarinette)\stopmylily
où bien avec un «quasiquote»

\startmylily 
`(,flute ,hautbois ,clarinette) ;&\em{& notez bien le `( et non '( &}&
\stopmylily
{\em arranger.ly} fournit des fonctions utilitaires pour faciliter la manipulation de ces listes. (voir \type{lst}, \type{flat-lst}, et \type{zip})
\blank[-0.6cm]                 
%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%

\reference[init]{}
\index[init-info]{init}                   
\subject{Initialisation}
- La fonction \type{init} ci-dessous doit être appellée \emph{après} la déclaration de \type{\global} et \emph{avant} tout appel aux autres fonctions. Elle prend, comme arguments, une liste d'\emph{instrument}s, et optionnellement un entier :
\syntax {(init instru-list}{measure1-number)}
Chaque instrument de la liste est déclaré à Lilypond et initialisé par des silences multi-mesures.\\
Si on a défini \type{global} par :
\startlily
global = { s1*20 \time 5/8 s8*5*10 \bar "|."}
\stoplily
les 2 lignes de code suivant :
\startlily
all = #'(flute clar sax tptte cor tbne basse)
#(init all)
\stoplily
seront équivalentes à :
\startlily
flute = { R1*20 R8*5*10 } 
clar = { R1*20 R8*5*10 } 
sax = { R1*20 R8*5*10 } 
tptte = { R1*20 R8*5*10 } 
cor = { R1*20 R8*5*10 } 
tbne = { R1*20 R8*5*10 } 
basse = { R1*20 R8*5*10 }
\stoplily
- \type{instru-list} peut éventuellement être vide : \type{(init '())}. C'est notamment le cas si on veut utiliser les fonctions arranger.ly, pour l'édition directe de la variable \type+\global+, comme montré dans l'\goto{addendum I}[addendum1], \at{page}[addendum1].

Une fois tous les éléments interférents sur la métrique mis en place dans \type+\global+, on peut alors appeller une 2\high{\itxx ème} fois \type{init} avec maintenant une liste d'intruments non vide.
\blank
- La fonction \type{init} prend en compte pour le comptage des mesures, des adaptations manuelles des propriétés (du \type+Score+ ou du \type+Timing+) telles \type+measurePosition+, \type+measureLength+, \type+currentBarNumber+, ainsi que celles amenées par les commandes \type+\partial+, 
\type+\cadenzaOn|Off+.
Pour un \type+\partial+ en début de morceau, \type{init} ajoute même automatiquement à tous les instruments un silence de la durée du \type+\partial+.

\setupcaptions[location=none]
\startfiguretext[right][exemple1]{}
{\vbox{\blank[-0.6em]\externalfigure[exemple01.pdf][wfactor=180, align=flushright]}}
\underbar{\sc\Words exemple 1}
\godown[-0.3em]
\startlily[bodyfont=10.7pt]
global = { 
  \partial 4 s4
  s1*2
  %&\em{& mesure &}&3&\em{& : seulement &}&2&\em{& temps&}&
  s4 \set Timing.measurePosition =
                  #(ly:make-moment 3/4)
     s4
  s1                    %&\em{& mesure &}&4
  \set Score.currentBarNumber = #50
  %&\em{& \set Timing.currentBarNumber = #&}&50
  s1                    %&\em{& mesure &}&50&\em{& !&}&
  \bar "|."  }
all = #'(fl cl sax tptte cor tbne basse)
#(init all)

\stoplily %\blank[2.1cm]%
\stopfiguretext
\index{measure-number->moment}
On pourra utiliser la fonction interne \type{measure-number->moment} pour vérifier que les positions {\em arranger.ly} et {\em Lilypond} correspondent. Dans cet exemple :
\startmylily#(display (map measure-number->moment '(1 2 3 4 50)))\stopmylily
renverra le nombre de noires depuis le début du morceau pour les mesures 1 2 3 4 et 50 :
\startmylily (#<Mom 1/4> #<Mom 5/4> #<Mom 9/4> #<Mom 11/4> #<Mom 15/4>)\stopmylily
\blank[1em]  % crlf 
- Le paramètre optionnel \type{measure1-number}\crlf
La fonction \type{init} peut prendre en dernier argument un nombre entier qui indiquera le numéro de la première mesure (1 par défaut) . Cela peut être utile si on décide de rajouter, disons 3 mesures d'introduction à notre arrangement ; remplacer le code par défaut par :
\startmylily 
(init all -2) 
\stopmylily
permet de décaler automatiquement toutes les positions de mesures déjà entrées. Si vous vous trouvez dans cette situation, il pourra être judicieux dans un premier temps de mettre en début de \type{\global}, la ligne suivante : 
\startmylily
\set Score.currentBarNumber = #-2
\stopmylily
et laisser le paramètre \type{measure1-number} à 1.
Puis, une fois le morceaux totalement terminé, supprimer la ligne du \type{currentBarNumber} ci-dessus (les numéros de mesures recommenceront à~1 à la première mesure) et finir en mettant  \type{measure1-number} à -2.

D'une manière générale, les réglages suivants peuvent être utiles pendant le travail :
\blank[0.8em]
\startmylily
tempSettings = { 
  \override Score.BarNumber.break-visibility = ##(#f #t #t)
  \override Score.BarNumber.font-size = #+2
  \set Score.barNumberVisibility = #all-bar-numbers-visible 
}
\stopmylily
\godown[-1em]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                     
\reference[rm-info]{}           
\subject{La fonction de base : \type{rm}}
%\label{rm}%
\type{rm} signifie «\underbar{r}eplace \underbar{m}usic».
La fonction, typiquement, redéfinit un {\em instrument} en remplaçant une partie de sa musique existante, par le fragment de musique donné en paramètre.\crlf
\type{rm} est en fait une extension de la fonction \type+\replaceMusic+
de «{\em extractMusic.ly}».\crlf
Consulter éventuellement le chapitre 8 de la documentation {\em extractMusic-doc.pdf}, à~:\crlf
\hbox{\hspace[lilyindent]\from[extractMusic]}
\page %%%%%%%%%%%%%%%%%%%%%%%%
Voici la syntaxe de \type{rm} :

\syntax{(rm obj where-pos repla}{repla-extra-pos obj-start-pos)}

- \type{obj} est $\left\{
\vcenter{%
\mbox{un {\em instrument}, par exemple : \type{'flute }}
\mbox{une liste d'{\em instrument}s : \type{'(clar tptte sax)}}
\mbox{mais il peut être aussi une {\em musique} : \type{music ou #{…#}} }
\mbox {ou une liste de {\em musique}s : \type{(list musicA musicB musicC…)}} 
}
\right.$

\blank[medium]
- \type{where-pos} indique où effectuer le remplacement. C'est un numéro de mesure, ou, plus \startnarrower[left] exactement, une {\em position musicale}, telle définie dans le paragraphe suivant, \at{page}[positions_musicales].\stopnarrower

- \type{repla} est une {\em musique} ou une liste de {\em musique}s, mais la syntaxe avec \type{quote '} est \startnarrower[left] acceptée~:~\type{'(musicA musicB musicC…)}.\stopnarrower

- \type{repla-extra-pos }et\type{ obj-start-pos }sont
aussi des {\em positions musicales}.
\startnarrower[left] (voir utilisation ci-après).\stopnarrower
\blank
{\hbox{\hspace[lilyindent]{\em {\small $\triangleright$} retour }{: }}}
\blank
- Si \type{obj} est un {\em instrument} ou une {\em musique},
\type{rm} renvoie la {\em musique} obtenue après remplacement\startnarrower[left]%
 effectué. Dans le cas d'un {\em instrument}, cette nouvelle valeur est réaffectée automatiquement au symbole le représentant.\stopnarrower

- Si \type{obj} est une liste d'{\em instrument}s ou
de {\em musique}s, \type{rm} renvoie la liste des {\em musique}s
obtenues.
\blank[0.7cm]
\startfiguretext[right][exemple2]{}
{\vbox{\blank[-1.1em]\externalfigure[exemple02-fr.pdf][wfactor=175, align=flushright]}}
\underbar{\sc\Words exemple 2}
\blank[0.7cm]
\startlily
global = { s1*4 \bar "|." } 
all = #'(fl cl sax tptte cor tbne basse) 
#(init all)

musA = \relative c' { e2 d c1 }
musB = { f1 e1 } 
musC = { g,1 c1 }

#(begin 
  (rm 'flute 1 #{ c'''1 #})
  (rm '(clar sax tptte) 2 #{ c''1 #}) 
  (rm '(cor tbne basse) 3 
                  '(musA musB musC)))
\stoplily
\stopfiguretext
\blank[0.7cm]
Par défaut, pour la fonction \type{rm}, la musique entière
du paramètre \type{repla} est pris en compte, mais on peut n'en prendre
qu'une partie en spécifiant de manière adéquat le paramètre optionnel
\type{repla-extra-pos}.\crlf 
En voici le principe :
\hairline
\type{repla} est positionné à la plus petite des
valeurs des positions \type{where-pos} et \hbox{\type{repla-extra-pos} :}
\definesymbol[5][$\rightarrow$]
\startitemize[5, joinedup, intro][margin=\lilyspace]
\item si \type{repla-extra-pos} est avant \type{where-pos},
la partie {[}\type{repla-extra-pos} \type{where-pos}{[} {\em ne
sera} {\em pas} remplacée (on ignore le début du paramètre \type{repla}). 
\item si \type{where-pos} est avant \type{repla-extra-pos},
seule la partie {[}\type{where-pos} \type{repla-extra-pos}{[}
de l’instrument {\em sera} remplacée (on ignore la
fin du paramètre \type{repla}).
\stopitemize
\hairline

\blank[0.7cm]
La pratique en est plus intuitive :
\page %%%%%%%%%%%%%%%%%%%%%%%%
\underbar{\sc\Words exemple 3}
\startfiguretext[right][exemple3]{}
{\vbox{\blank[0.15em]\externalfigure[exemple03.pdf][wfactor=220, align=flushright]}}
\startlily
mus = \relative c' {
  f1 c' f a f' }    %&\em{& cl mes &}&4 
#(begin
  (rm 'fl 7 mus 4)
  (rm 'cl 4 mus #f)
    ;&\em{& = (rm 'cl &}&4&\em{& mus)&}&
  (rm 'bs 4 mus 6))
\stoplily
\stopfiguretext

- L' argument optionnel \type{obj-start-pos} permet de préciser où débute \type{obj} 
 (\type{repla-extra-pos} lui, concerne \type{repla}). C'est typiquement le cas si \type{obj} est
une { \em musique} (et non un {\em instrument}).On utilisera alors la valeur de retour de \type{rm}.\\

Dans l'exemple 3, si on voulait changer le fa de la mesure 6, par
un mib, et assigner le résultat à un autre instrument (disons un saxo),
on pourrait écrire :

\defineparagraphs[mypar][n=3,before={\blank}, after={\blank}, distance=1em]
\setupparagraphs[mypar][1][width=0.42\textwidth, style=type]
\setupparagraphs[mypar][2][width=0.07\textwidth, style=type] %, rule=on]
\setupparagraphs[mypar][3][width=0.45\textwidth, style=italic]
\startmypar
%\vbox{
\startlily                
#(let((m (rm mus 
             6 #{ ees'1 #} 
             #f
             4)))
    (rm 'saxo 4 m))
\stoplily
%}%
\mypar 
; let\crlf
; 6\crlf
; \#f\crlf
; 4
\mypar
permet de déclarer des variables locales\crlf
mesure où placer le mib\crlf
repla-extra-pos,\crlf
position de début de music
\stopmypar
\godown[-0.2em]
\hairline
Notez bien la différence entre : \type{(rm music…)} et \type{(rm 'music…)} Dans le premier cas, \type{music} reste inchangé ; on ne récupère que la valeur de retour. Dans le second cas, cette valeur de retour est affectée à un symbole.(Celui-ci représenterait un instrument dont le nom serait \type{'music}).
\hairline
\blank
- Dans le cas où le paramètre \type{obj} est une liste d'{\em instrument}s,
un élément de cette liste peut être lui-même une liste d'{\em instrument}s.
Ainsi, pour :
\startmylily
(rm '(flute (clar sax) bassClar) 5 '(musicA musicB musicC))
\stopmylily 
l'assignement à la mesure 5 se fait comme suit :\crlf
\vtop{\hbox{
 \hspace[lilyindent]
 \starttable[|lT|c|l|]
    \type{'flute} \NC $\leftarrow$ \NC \type{\musicA} \FR
    \NR
    \type{'clar} \NC $\leftarrow$ \NC \type{\musicB} \MR
    \NR
    \type{'sax} \NC $\leftarrow$ \NC \type{\musicB} \MR
    \NR
    \type{'bassClar  } \NC $\leftarrow$ \NC \type{\musicC} \LR
    \NR
  \stoptable}
}
\godown[-0.1em]

                     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subject[positions_musicales]{Les positions musicales et numéros de mesures, en détails}
- On indique une position par son numéro de mesure, mais quid si une position musicale ne commence pas juste au début d'une mesure ? La syntaxe à employer dans ce cas là, se présentera sous la forme d'une {\em liste d'entiers} : 
\startmylily '(n i j k …) \stopmylily
où \type{n} est le numéro de la mesure, et \type{i j k} …, des puissances de deux (1, 2, 4, 8, 16 etc…) représentant les valeurs de notes à ajouter après le début de la mesure \type{n}.\footnote{La fonction \goto{\type{add-dynamics}}[add-dynamics] \at{page}[add-dynamics], montre des cas pariculiers où les \type{i j k} … sont des entiers non puissance de 2.}

Par exemple \type{'(5 2 4) }indique la position de la musique se trouvant à la mesure 5, après une blanche (\type{2}), puis après une noire (\type{4}) soit, dans une mesure à \type{4/4} :  mesure 5, 4ème temps.\\

- Tout \type{n} inférieur à 1 (ou au nombre transmis en paramètre dans \type{init}, -3 par exemple) sera transformé en 1 (resp. en -3). L'erreur ne sera pas signalée, mais la position \type{'(0 2 4)} pointe vers le même endroit que \type{'(1 2 4)}…\\

- Les {\em valeurs négatives} pour \type{i j  …} sont admises. Le code \type{'(5 2 4)} peut aussi s'écrire en \type{4/4}~: \type{'(6 -4)} soit \quotation{mesure 6, moins la valeur d'une noire}. Les valeurs négatives sont le seul moyen d'accéder à une levée en début de morceau~:~position \type{'(1 -4)} pour \type{\partial 4 …}
\page %%%%%%%%%%%%%%%%%%%%%
- À l'instar des expressions de durées dans Lilypond, un point après une puissance de 2 est possible :
\type{'(7 4.)} pour \type{'(7 4 8)}\crlf
Pour 2 points et plus, par contre, on devra écrire : \type{'(7 4.2)} pour \type{'(7 4 8 16)}, \type{'(7 4.3)} pour~\type{'(7 4 8 16 32)}, etc… (jusqu'à 9 points !).
\blank
- Avec la fonction \type{rm}, une note qui commence avant la position passée en paramètre mais qui se poursuit après, sera raccourcie en conséquence.

Dans l'\goto{exemple précédent \at{(page}{)}[exemple3]}[exemple3], le code : 
\startmylily (rm 'cl '(5 2 4) #{ r4 #})  ;&\em{& ou '(5 2.) donc…&}&\stopmylily
donnerait pour la clarinette à la mesure 5 : 
\startmylily {c2. r4} \stopmylily 
$\Longrightarrow$ le do ronde est transformé en blanche
pointée.
\reference[multirestWarning]{}
\hairline
Attention : si les notes et les silences peuvent se «couper» en des valeurs plus petites, il n'en est pas de même pour les silences multi-mesures ( \type{R1 R1*2} etc…) qui ne peuvent se couper qu'à des barres de mesures.
\hairline
\blank[0.5em]
Ainsi, toujours dans cet \goto{exemple 3 de la page \at{}[exemple3]}[exemple3], le code : 
\startmylily(rm 'fl '(5 2 4) #{ c''4 #})\stopmylily
produirait un avertissement du genre :
\startmylily
&\it\quotation{{&Avertissement : échec du contrôle de mesure (barcheck) à 3/4
  mmR = { #infinite-mmR \tag #'mmWarning R1 }&}}&
\stopmylily
\blank[0.2em]
(La 2\high{ème} ligne est une ligne de code du fichier {\em «extractMusic.ly»}… )\\
La solution ici est : 
\startmylily
(rm 'fl 5 #{ r2 r4 c''4 #}) ;&\em{& on met les silences à la main !&}&
\stopmylily
\blank
- Voici pour finir, un exemple montrant l'utilisation des positions avec la commande 
\type{\cadenzaOn}
\blank[0.4em]
\underbar{\sc\Words exemple 4}
\godown[-0.3em]
\startlily
cadenza = \relative c' { c4^"cadenza" d e f g }
\stoplily
\godown[-1.3em]
\startfiguretext[right][exemple4]{}
{\vbox{\blank[-0.5em]\externalfigure[exemple04-1.pdf][wfactor=200, align=flushright]}}
\startlily
global = {
   \time 3/4
   s2.
\stoplily
\stopfiguretext
\godown[-2.9em]
\startlily
   \cadenzaOn #(skip-of-length cadenza) \cadenzaOff
   s2.*2 \bar "|." }
#(init '(clar))
#(rm 'clar 2 #{ \cadenza r2. #})
\stoplily
%\godown[-0.2em]
\startfiguretext[right][exemple4]{}
{\vbox{\blank[-0.5em]\externalfigure[exemple04-2.pdf][wfactor=200, align=flushright]}}
\godown[-0.2em]
Si avant la mesure 3, on veut remplacer le silence par un la, on pourra utiliser un nombre négatif :
\godown[0.4em]
\startmylily (rm 'clar '(3 -2.) #{ a'2. #}) \stopmylily
\stopfiguretext
\godown[-0.7em]
{\em arranger.ly} utilise quelque fois en interne une autre syntaxe pour les positions :
\startmylily `(n ,moment)    ;&\it\rm{& ou : (list n moment)&}& \stopmylily
Son utilisation ici, pour insérer le la à partir de la mesure 2, donnerait alors :
\startmylily (rm 'clar `(2 ,(ly:music-length cadenza)) #{ a'2. #}) \stopmylily
Notez enfin que la syntaxe \type{`(n ,(ly:make-moment p/q))} peut s'alléger en
\type{'(n p/q)}, à condition que le quotient \type{p/q} ne soit pas réductible à 1 entier.
\startmylily 
(rm 'clar '(2 5/4) #{ a'2. #})  ;&\it\rm{& ok avec 5/4 : même résultat que le code précédent&}&  \stopmylily
Par contre, \type{8/4} donnerait \type{(ly:make-moment 1/2)} et non \type{(ly:make-moment 2/1)}
\blank
- \underbar{Convention} :
\hairline
Dans toutes les fonctions qui vont suivre, tout argument se terminant par \type {-pos} (\type {from-pos}, \type {to-pos}, \type {where-pos} etc…) sera du type {\em position}, tel qu'il vient d'être décrit dans tout ce paragraphe. Seront aussi de ce type, les noms tels que \type {pos1}, \type {pos2} etc\dots
\hairline
\page %%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%
%%%%%% Chapitre 2 ...
\title[ListageFonctions]{LISTAGE des FONCTIONS}

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                  
\subject[copiercoller]{Les fonctions de copier-coller}
\blank[-2em]
%%%%%%%%%
\func{rm}
\syntax{(rm obj where-pos repla}{repla-extra-pos obj-start-pos)}
\type{rm} est décrit à part d'une manière très détaillée à la \at{page}[rm-info].
\blank[0.8em]
\midaligned{ \tfd ------------}

%%%%%%%%%
\func{copy-to}
\index{copy-to-with-func}
\syntax {(copy-to destination source from-pos to-pos . args)}{}
Copie \type{source} dans \type{destination} entre les positions \type{from-pos} et 
\type{to-pos}\\
\type{destination} peut être un {\em instrument}, ou une liste contenant des {\em instrument}s ou des listes d'{\em instrument}s.\\
\type{source} est un {\em instrument}, une liste d'{\em instrument}s, une {\em musique} ou une liste de {\em musique}s\\
On peut copier plusieurs sections à la suite en spécifiant à chaque fois des nouveaux paramètres sources et positions dans le paramètre \type{args}. On pourra séparer éventuellement chaque section par des barres obliques «diviser» \type{/}
\startmylily
(copy-to destination sourceA posA1 posA2 / sourceB posB1 posB2 / etc…)
\stopmylily
Si on omet un paramètre \type{source} dans une section, la source de la
section précédente est prise en compte.
\startmylily
(copy-to destination source pos1 pos2 / pos3 pos4)
\stopmylily
est équivalent à : 
\startmylily
(copy-to destination source pos1 pos2 / source pos3 pos4)
\stopmylily
Si \type{source} ne commence pas au début du morceau, on peut spécifier une clef optionnelle \type{#:source-start-pos} de la manière suivante :
\startmylily
(copy-to dest source pos1 pos2 #:source-start-pos pos3 / pos4 pos5 …)
\stopmylily
Enfin, on peut remplacer \type{copy-to} par la fonction \type{(copy-to-with-func func)} qui appliquera \type{func} à chaque section copiée. Voir l'utilisation de \type{func} à la fonction \goto{\type{apply-to}}[apply-to], \at{page}[apply-to].
\startmylily
((copy-to-with-func func) destination source pos1 pos2 …)
\stopmylily
\blank[1em]
\midaligned{ \tfd ------------}

%%%%%%%%%
\func{copy-out}
\index{copy-out-with-func}
\syntax {(copy-out obj from-pos to-pos where-pos . other-where-pos)}{}
Recopie la section \type{[from-pos to-pos[} d'un instrument ou groupe d'instruments \type{obj}, vers la position \type{where-pos},
puis éventuellement vers d'autres positions. 
\startmylily
(copy-out obj from-pos to-pos where-pos1 where-pos2 where-pos3 etc…)
\stopmylily
On peut remplacer \type{copy-out} par la fonction \type{(copy-out-with-func func)} qui appliquera \type{func} à  chaque section copiée. Voir l'utilisation de \type{func} à la fonction \goto{\type{apply-to}}[apply-to], \at{page}[apply-to].
\startmylily
((copy-out-with-func func) obj from-pos to-pos where-pos …)
\stopmylily
\blank[1em]
\midaligned{ \tfd ------------}

%%%%%%%%%
\func{x-rm}
\syntax {(x-rm obj replacement pos1 pos2 … posn)}{}

Simple raccourci pour :
\startmylily
(rm obj pos1 replacement)
(rm obj pos2 replacement)
…
(rm obj posn replacement)
\stopmylily
\blank[0.3em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%
\func{rm-with} 
\syntax {(rm-with obj pos1 repla1 / pos2 repla2 / pos3 repla3 …)}{}

Raccourci pour : 

\startmylily
(rm obj pos1 repla1)
(rm obj pos2 repla2)
etc…
\stopmylily

La barre oblique «diviser» \type{/} permet de diviser l'instruction en sections mais est optionnelle.\\
Si un \type{repla} veut utiliser la musique d'une section précédente après modification , il est possible d'utiliser conjointement, la fonction scheme \type{delay} et la fonction \type{em} de la \at{page}[em]~:
\startmylily
(delay (em obj from-pos to-pos)) ; &\tfx\em{&Extrait la musique de obj déjà modifiée&}&
\stopmylily
\blank[0.8em]
\midaligned{ \tfd ------------}
\godown[0.4em]
%%%%%%%%%
\func{apply-to}
\index{to-set-func}
\index{compose}
\syntax{(apply-to obj func from-pos to-pos}{obj-start-pos)}
Applique la fonction \type{func} à la section \type{[from-pos to-pos[} de \type{obj.}\\
\type{obj} est une {\em musique}, un {\em instrument}, ou une liste de {\em musique}s ou d' {\em instrument}s.\\
Le paramètre \type{obj-start-pos} permet de spécifier la position du début de \type{obj}, si celle-ci est différente de celle du morceau.
\blank[0.5em]
\underbar{Le paramètre \type{func}} :
\blank[0.7em]
{\tfa -} \type{func} est une fonction à 1 seul paramètre de type {\em musique}.\\
"{\em arranger.ly}" en définit un certain nombre sous la forme d'une sous-fonction commençant par \type{set-}~: \type{set-transp} , \type{set-pat} , \type{set-ncopy} , \type{set-note} , \type{set-pitch} , \type{set-notes+} , \type{set-arti} , \type{set-reverse} , \type{set-del-events} , \type{set-chords->nmusics}\\(ces fonctions sont décrites plus loin dans ce document).
\blank[0.6em]
{\tfa -} On peut, cependant, facilement créer soi-même des fonctions compatibles \type{apply-to}, avec l'aide d'une fonction "enveloppe" appelée \type{to-set-func}, particulièrement adaptée au changement de propriétés musicales. \type{to-set-func} prend elle-même en paramètre une {\em fonction}, à paramètre musical.\\
Dans l'exemple suivant, on definit une fonction \type{func} qui, utilisée avec \type{apply-to}, transformera tous les \type{c'} en \type{d'}~:
\blank[0.3em]
\startmylily
(define func (to-set-func (lambda(m) 
               (if (equal? (ly:music-property m 'pitch #f) #{ c' #}) 
                 (ly:music-set-property! m 'pitch #{ d' #})))))
\stopmylily
%\crlf % ne marche pas
\blank[0.3em]
{\tfa -} On peut également regrouper plusieurs opérations en même temps, en utilisant la fonction \type{compose}~:
\blank[0.3em] 
\startmylily (compose func3 func2 func1 …) \stopmylily 
\blank[0.3em]
ce qui donnera, appliquée à un paramètre \type{music} :
\blank[0.3em]
\startmylily (func3 (func2 (func1 music)))\stopmylily
\blank[0.6em]
{\tfa -} Revenons aux fonctions de "{\em arranger.ly}" mentionées plus haut, de la forme :
\blank[0.3em] 
\startmylily ((set-func args) music) \stopmylily
\blank[0.3em]
Pendant l'appel de \type{apply-to}, tous les arguments \type{args} de la sous-fonction \type{set-func} restent identiques et fixés pour tous les instruments contenus dans \type{obj}. Or, il est dans certain cas souhaitable que ces arguments soient au contraire, personnalisables à chaque instrument.\\ Cela sera possible, à la condition d'adopter une nouvelle syntaxe pour l'argument \type{func} de \type{apply-to}, qui sera alors défini comme une paire, avec en 1\high{er} élément, le nom de la sous-fonction, et en 2\high{nd}, une liste, composée des arguments correspondant à chaque instrument.
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\type{func} devient : \inframed{\type{(cons set-func (list args-instrument1 args-instrument2 …))}}
\blank[0.4em]{args-instrument} est soit un élément unique soit une liste, en fonction du nombre de paramètres requis par \type{set-func}.
\blank[0.3em]
L'exemple 5 ci-dessous, copie des patterns sur 3 mesures puis change la hauteur des notes de la
\blank[0.3em] 
2\high{ème} mesure.
\blank[0.3em]
On utilise pour cela 3 fonctions qui sont vues plus tard :
\startitemize[5,intro][margin=\lilyspace,before=\blank]
\item La fonction \goto{\type{fill}}[fill] \at{page}[fill] (pattern de {\em musique}s)
\item La fonction \goto{\type{set-pitch}}[set-pitch] \at{page}[set-pitch], qui attend 1 seul paramètre, de type {\em musique}.
\item La fonction \goto{\type{chords->nmusics}}[chords->nmusics] \at{page}[chords->nmusics], qui retourne une liste de \type{n} éléments de type …~{\em musique} justement.
\stopitemize

\blank[1.5em]
\underbar{\sc\Words exemple 5}
\startfiguretext[right][exemple5]{}
{\vbox{\blank[-3em]\externalfigure[exemple05.pdf][wfactor=270, align=flushright]}}
\startlily[space=fixed]
global = { s1*3 
           \bar "|." }
instrus = #'(I II III)

#(init instrus)
\stoplily
\stopfiguretext
\godown[-2em]
\startlily
chords = \relative c' { <b f' gis> <d f b> <c e a> <b d e> }

#(begin
(fill instrus (list #{ r8 e'-. #}
                    #{ r8 c'-. #}
                    #{ a8-> r c'-. r b-. r a-. r #})
              1 4)
(apply-to instrus (cons set-pitch (chords->nmusics 3 chords))
                  2 3)
\stoplily

\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{x-apply-to}
\syntax {(x-apply-to obj func from-pos1 to-pos1
              / from-pos2 to-pos2 /…)}{} 
Simple raccourci pour :
\startmylily
(apply-to obj func from-pos1 to-pos1)
(apply-to obj func from-pos2 to-pos2)
etc…
\stopmylily
La barre oblique \type{/} est optionnelle.\\
Une clef : \type{obj-start-pos} peut optionnellement spécifier un point de départ diffèrent du début du morceau~:
\startmylily
(x-apply-to obj func pos1 pos2 #:obj-start-pos pos3 …)
\stopmylily
\godown[1.5em]
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{xchg-music} (raccourci de "e\underbar{xch}ange music" : échanger la musque)
\syntax {(xchg-music obj1 obj2 from-pos1 to-pos1 / from-pos2 to-pos2 /…)}{}
Copie la section \type{[from-posn to-posn[} de \type{obj1} dans \type{obj2} et celle de \type{obj2} dans \type{obj1}.\\
La barre oblique \type{/} est optionnelle.
\blank
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subject[agencement]{Agencement d'éléments musicaux}
Les fonctions suivantes permettent de déclarer ou construire
de la musique, séquentielle ou simultanée, à partir de musiques, éventuellement extraites
d'instruments.
\godown[2.5em]

%%%%%%%%%
\func{em} : de \underbar{e}xtract et \underbar{m}usic, fonction de référence : \type+\extractMusic+%
\footnote{Voir {\em DOCS/extractMusic-doc.pdf} à \from[extractMusic]}
\syntax {(em obj from-pos to-pos}{obj-start-pos)}
Extrait la musique dans l'intervalle de mesures \type{[from-pos to-pos[}. Un événement musical sera déclaré éligible s'il commence entre ces 2 bornes, et sa durée sera coupée s'il se prolonge après \type{to-pos}.\\
\type{obj} est typiquement un {\em instrument}, ou une
liste d'{\em instrument}s\\
Si \type{obj} est une {\em musique} ou une
liste de {\em musique}s, le paramètre \type{obj-start-pos} renseignera la fonction sur la position de \type{obj} dans le morceau (par défaut : au début du morceau).

\type{em} renvoie une liste de {\em musique}s si \type{obj} est une liste, ou une {\em musique} dans le cas contraire.\\
Voir l'exemple de la fonction \type{seq}, ci-après.
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{x-em}
\syntax {(x-em obj pos1 pos2 / pos3 pos4 / ...)}{}
Renvoie : \type{(list (em obj pos1 pos2) (em obj pos3 pos4) ...)}
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{seq}(abréviation de {\em \underbar{seq}uential})
\syntax {(seq musicI musicII musicIII etc…)}{}

Équivalent à : \type+{ \musicI \musicII \musicIII…}+

Tous les arguments sont des {\em musique}s mais des listes de {\em musique}s sont aussi acceptées.\\
\underbar{\sc\Words Exemple} :
\startmylily
(rm 'clar 12 (seq (em 'flute 12 15)         ; &\em{&Double la flûte&}&
                  #{ r2 r4 #}               ; &\em{&Mesure 15&}&
                  (em 'violon '(16 -4) 20)) ; &\em{&Double le violon&}&
\stopmylily  
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%%%%
\func{seq-r}(r comme {\em\underbar{r}est})
\syntax {(seq-r . args)}{}

Idem que \type{seq} mais un nombre est converti en un silence de la durée de ce nombre.\\
L'exemple précédent peut s'écrire :
\startmylily
(rm 'clar 12 (seq-r (em 'flute 12 15)         ; &\em{&Double la flûte&}&
                    2 4                       ; &\em{&Mesure 15 : des silences&}&
                    (em 'violon '(16 -4) 20)) ; &\em{&Double le violon&}&
\stopmylily
Un point après le nombre est possible : \type{4.} pour \type+#{ r4. #}+.\\
Pour 2, 3 points ou plus, on ajoute ce chiffre après le point : \type{4.3} pour \type+#{ r4... #}+ (3 points)

\hairline
\type{seq} et \type{seq-r} sont maintenant une seule et même fonction et peuvent s'utiliser indifféremment.
Le nom \type{seq-r} est conservé uniquement par compatibilité avec les versions précédentes.
\hairline
%\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%
\func{sim} (abréviation de {\em \underbar{sim}ultaneous})
\syntax {(sim musicI musicII musicIII etc…)}{}

Équivalent de \type+<< \musicI \musicII \musicIII …>>+

Tous les arguments sont des {\em musique}s mais des listes de {\em musique}s sont aussi acceptées.\\
Voir un exemple à la fonction \goto{\type{volta-repeat->skip}}[volta-repeat->skip], \at{page}[volta-repeat->skip]
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{split}
\syntax {(split ['(id1 id2 id3...)] music1 music2 music3...)}{}

Équivalent de \type+\voices id1,id2,id3 ... << music1 \\ music2 \\ music3 ... >> +\\
La liste des {\em id}s pour chaque voix est optionnelle.\\
La liste par defaut est basée sur le modèle \type+'(1 3 5 ... 6 4 2)+
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{part-combine}
\syntax {(part-combine musicI musicII)}{}

Équivalent de \type+\partCombine \musicI \musicII+\\
Les 2 arguments sont des {\em musique}s.
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{def!}
\syntax {(def! name}{music)}

Équivalent d'une déclaration Lilypond : %
\type+name = \music+

\type{name} est un {\em instrument}, ou une liste d'{\em instrument}s
(on applique \type{def!} à chaque instrument de la liste).\\
\type{music} est une {\em musique} ou une liste de {\em musique}s (\type{music1} est associé à \type{instrument1}, \type{music2} à \type{instrument2} etc…).\\
Si \type{music} est omis, la valeur par défaut est un
skip \type+{ s1*… }+ de la longueur de \type{\global}.\\
Voir l'exemple ci dessous, à la fonction \type{volta-repeat->skip}.
\blank[1.2em]
\midaligned{ \tfd ------------}
\godown[0.5em]

%%%%%%%%%
\func{at}
\syntax {(at pos mus)}{}

Renvoie \type+{ s1*… \mus }+, avec \type{s1*…} d'une longueur égale à celle du début du morceau à \type+pos+.

\blank[1.2em]
\midaligned{ \tfd ------------}
\godown[0.5em]

%%%%%%%%%
\func{cut-end}
\syntax {(cut-end obj new-end-pos [start-pos])}{}

Coupe la fin des musiques associées à \type{obj} à la position \type{new-end-pos}.\\
Utile particulièrement pour la construction de \type{\global} ; voir l'\goto{addendum I}[addendum1]  \at{page}[addendum1]

\blank[1em]
\midaligned{ \tfd ------------}
\page  %%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%
\index{pos-sub}
\func{volta-repeat->skip}
\syntax {(volta-repeat->skip r0 [r1 r2…])}{}
\syntax {(volta-repeat->skip r0 '((r1 n1 [n2…])(r2 ni [ni+1…])…)}{}
Retourne une structure \type+\repeat volta [\alternate]+ où chaque éléments est un \type{\skip}.\\
Les arguments \type{r…} sont des rationnels de la forme p/q où q est une puissance de deux (1 2 4 8…) et indiquent la longueur de chaque \type{\skip}.\\
Dans la syntaxe 2, les arguments \type{n…} de la \quote {\type{liste de listes }} du 2\high{ème} paramètre, sont les entiers naturels correspondant à ceux de la commande \type+\volta+ (Par exemple \type+\volta 1,2,3+).\\
Le nombre de répétitions est calculé sur le nombre de \type{r1 r2…} pour la syntaxe 1 et sur le nombre de \type{n1 n2…} pour la syntaxe 2.
\startmylily (volta-repeat->skip 9 3 5/4) &\em{&ou&}& (volta-repeat->skip 9 '((3 1) (5/4 2)) \stopmylily
sont dans les 2 cas, equivalents à :
\startmylily \repeat volta 2 s1*9 \alternate { \volta 1 s1*3 \volta 2 s4*5 } \stopmylily  \\
Les arguments \type{r…} peuvent être alternativement de type \type{moment}, ce qui permet d'utiliser la fonction interne \type{pos-sub} qui renvoie la longeur entre 2 positions. L'exemple ci-dessous montre, à la mesure 29 l'usage d'une telle fonction, ainsi que celui de la fonction \type{def!} décrite \at{page}[def!].\\\\
\underbar{\sc\Words Exemple 5} :
\blank[0.5em]
\startmylily 
(def! 'structure)                ; &\em{&Même longeur que \global&}&  
(rm-with 'structure              ; &\em{&On ajoute les reprises&}&  
  5 (volta-repeat->skip 9 3 1)                          ; &\em{&en &}&4/4
 29 (volta-repeat->skip (pos-sub 38 29) (* 2 3/4) 3/4)) ; &\em{&en &}&7/8&\em{& et &}&3/4
 50 (volta-repeat->skip (* 9 3/4) '((3/4 1 2) (3/4 3 4 5) (3/4 6 7))) 
                                                        ; &\em{&syntaxe &}&2&\em{&, en &}&3/4 
(def! 'global (sim global structure))  ; &\em{&global = << \global \structure >>&}&
\stopmylily
\placefigure[here]{}{\externalfigure[volta-repeat-to-skip][hfactor=max]}

\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{mmr}
\syntax {(mmr ratio)}{}
\syntax {(mmr from-bar-num to-bar-num)}{}
Renvoie un \type{multiMeasasureRest} d'une durée calculée d'après :\\
\startnarrower[1em]
- un rationnel (syntaxe 1), de la forme p/q où q est une puissance de deux (1 2 4 8…)\\
(par exemple \type{(mmr 3/4)} pour \type+#{ R4*3 #}+, ou \type{(mmr 2)} pour \type+#{ R1*2 #}+)\\
- ou, pour la syntaxe 2, d'après la longueur musicale entre 2 mesures.\\
(par exemple \type{(mmr 5 13)} pour un silence remplissant intégralement les mesures 5 à 13).
\stopnarrower
La syntaxe 2 utilise en interne la fonction \type{pos-sub} décrite plus haut.
\blank[1.5em]
\midaligned{ \tfd ------------}
\page  %%%%%%%%%%%%%%%%%%%%%%%%%%%%

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                     
\subject[gerer-voix]{Gérer les voix (ajout, extraction)}
%\footnote{Voir {\em chordsAndVoices-doc.pdf} à \from[chord]} 
Voir aussi {\em chordsAndVoices-doc.pdf} à \from[chord]
\blank[-1em]
%%%%%%%%%
\func{voice} 
\syntax {(voice n [m p …] music)}{}
\index{set-voice}
ou : (2\high{ème} forme  équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\syntax {((set-voice n [m p …]) music)}{}
Extrait la voix \type{n} dans une musique à plusieurs voix simultanées :\\
\godown[0.1em]
\startmylily music = << { a b } \\ { c d } >> \stopmylily
\godown[-0.5em] 
\starttabulate[|l|l|c|l|]
    \NC\myindent\NC {\type{(voice 1 music)}}\NC $\Longrightarrow$ \NC \type+ { a b } +
    \NR
    \NC\myindent\NC {\type{(voice 2 music)}} \NC $\Longrightarrow$  \NC \type+ { c d } +
    \NR
    \NC\myindent\NC {\type{(voice 3 music)}} \NC $\Longrightarrow$  \NC \type+ { c d } +
    \NR
    \NC\myindent\NC { \space \dots} \NC 
\stoptabulate
\godown[0.7em]
Si d'autres nombres \type{m p …} sont spécifiés, la fonction renvoie une liste des voix correspondante à chacuns de nombres \type{n m p …}
\startmylily 
(rm '(instru1 instru2) 5 (voice 1 2 music)) 
\stopmylily
est équivalent à :
\startmylily 
(rm 'instru1 5 { a b })
(rm 'instru2 5 { c d })
\stopmylily

\godown[0.2em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{replace-voice} 
\syntax {(replace-voice n music repla)}{}
\index{set-replace-voice}
ou : (2\high{ème} forme  équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\syntax {((set-replace-voice n repla) music)}{}
Remplace, dans une musique à plusieurs voix simultanées, la voix \type{n}.\\ 
Si \type+music = << { a b } \\ { c d } >>+, le code :\\
\type+(replace-voice 2 music #{ f g #})+ donnera \type+<< { a b } \\ { f g } >>+

\blank
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{dispatch-voices}
\syntax {(dispatch-voices obj where-pos music-with-voices}{voices-extra-pos obj-start-pos)}
\underbar{\sc\Words Exemple} :
\startlily music = << { c2 d } \\ { e2 f } \\ { g2 b } >> \stoplily 
Le code :
\startlily (dispatch-voices '(basson clarinette (hautbois flute)) 8 music) \stoplily 
produira, à la mesure 8, l'assignement suivant : 
\starttabulate[|l|l|c|l|]
    \NC\myindent\NC {\type{'basson}}\NC $\leftarrow$ \NC \type+ { c2 d } +
    \NR
    \NC\myindent\NC {\type{'clarinette}} \NC $\leftarrow$ \NC \type+ { e2 f  } +
    \NR
    \NC\myindent\NC {\type{'hautbois}} \NC $\leftarrow$ \NC \type+ { g2 b } +
    \NR
    \NC\myindent\NC {\type{'flute}} \NC $\leftarrow$ \NC \type+ { g2 b } +
    \NR
\stoptabulate 

Voir \in{la fonction \type{rm} (\at{page}[rm-info])}[rm-info] pour la signification des arguments optionnels

\blank
\midaligned{ \tfd ------------}
\page  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%
\hairline
Les fonctions qui vont suivre sont toutes créées, au niveau des paramètres, sur le même modèle. Chacunes d'elles permettent juste d'obtenir un type de musique simultanée particulier :
\starttabulate[|l|l|c|l|]
    \NC\myindent\NC {\type{add-voice1/add-voice2}}\NC $\rightarrow$ \NC \type+ << \voiceI \\ \voiceII >> +
    \NR
    \NC\myindent\NC {\type{merge-in/merge-in-with}} \NC $\rightarrow$ \NC \type+ << \voiceI \voiceII >> +
    \NR
    \NC\myindent\NC {\type{combine1/combine2}} \NC $\rightarrow$ \NC \type+ \partCombine \voiceI \voiceII +
    \NR
\stoptabulate 
\hairline

\blank
\func{add-voice1{,} add-voice2}{}
\syntax{(add-voice1 obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}        
\syntax{(add-voice2 obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}

La musique de chaque {\em instrument}, est remplacée à la position \type{where-pos} par : 
\startmylily << [musique existante] \\ new-voice >>  &\rm{&pour&}& add-voice2 \stopmylily
et par
\startmylily << new-voice \\ [musique existante] >>  &\rm{&pour&}& add-voice1&\rm{&.&}& \stopmylily

\type{obj} est un {\em instrument} ou une liste d'{\em instrument}s

\type{new-voice} est une {\em musique} ou une liste de {\em musique}s.\\
Utiliser \type{voice-start-pos}, si \type{new-voice} commence avant \type{where-pos}.\\
Utiliser \type{to-pos} si vous voulez stopper le remplacement avant la fin de \type{new-voice}.\\ 
Utiliser \type{obj-start-pos} si \type{obj} ne commence pas au début de la pièce (typiquement
la mesure~1,~voir la \at{fonction \type{init} page}[init]).

\blank
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{merge-in}
\syntax{(merge-in obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}

La musique de \type{obj} est remplacée à la mesure \type{where-pos} par : 
\startmylily << new-voice [existing music] >> \stopmylily
Pour les paramètres optionnels, voir ci-dessus (\type{add-voice1}).

\blank
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{merge-in-with}
\syntax {(merge-in-with obj pos1 music1 / pos2 music2 / pos3 music3 …)}{}
est un raccourci pour :
\startlily 
(merge-in obj pos1 music1)
(merge-in obj pos2 music2)
(merge-in obj pos3 music3)	
…
\stoplily
La barre oblique \type{/} est optionnelle

\blank
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{combine1{,} combine2}{}
\syntax{(combine1 obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}        
\syntax{(combine2 obj where-pos new-voice}{voice-start-pos to-pos obj-start-pos)}

La musique de chaque {\em instrument}, est remplacée à la position \type{where-pos} par : 
\startmylily \partCombine [musique existante] \new-voice  &\rm{&pour&}& combine2 \stopmylily
et par
\startmylily \partCombine \new-voice [musique existante]  &\rm{&pour&}& combine1&\rm{&.&}& \stopmylily
\blank
Voir la fonction \type{add-voice} en haut de la page, pour les paramètres optionnels.

\blank
\midaligned{ \tfd ------------}
\godown[1.5em]

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subject[gerer-accords]{Gérer les accords}
\blank[-1em]
%%%%%%%%%
\func{note}
\syntax {(note n [m p …] music)}{}
\index{set-note}
ou : (2\high{ème} forme  équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\syntax {((set-note n [m p …]) music)}{}
Extrait la n\high{\itxx ième} note de chaque accord (dans un ordre identique à celui du fichier source).\\
Si d'autres nombres sont spécifiés, (\type{m}, \type{p} …), \type{note} formera des accords, en recherchant dans l'accord d'origine, la note correspondante à chacun de ces nombres.\\
Si aucune correspondance n'est trouvée, \type{note} renvoie la dernière note de l'accord.\\ 
\blank[1em]
\underbar{\sc\Words Exemple} :
\startmylily
music = { <c e g>-\p <d f b>-. }
(note 1 music)   &$\Longrightarrow$& { c-\p d-. }
(note 2 3 music) &$\Longrightarrow$& { <e g>-\p <f b>-. }
(note 4 music)   &$\Longrightarrow$& { g-\p b-. }
\stopmylily
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{notes+}
\syntax {(notes music newnotes1 [newnotes2…])}{}
\index{set-notes\textplus}
ou : (2\high{ème} forme  équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\syntax {((set-notes+ newnotes1 [newnotes2…]) music))}{}
Transforme chaque note de \type{music} en accord, et y insère la note des \type{newnotes}  correspondante.\\
Un \type{\skip} dans \type{newnotes} laisse la note originale inchangée.\\
\blank[1em]
\underbar{\sc\Words Exemple} :
\startmylily
music = { c'4  b  <g c'>2  c'  c' }
notes = { e  <d f>  e      s   c  }	
(notes+ music notes) &$\Longrightarrow$& { <e c'>4 <d f b> <e g c'>2 c' <c c'> }
\stopmylily
\blank[1em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%
\func{add-notes} 
\syntax {(add-notes obj where-pos newnotes1 [newnotes2]…[obj-start-pos])}{}

Même chose que la fonction \type{notes+} précédente mais appliquée cette fois-ci à partir d'une position \type{where-pos} donnée.\\
\type{obj} peut être ici, un {\em instrument}, une liste d'{\em instrument}s, une {\em musique} ou une liste de {\em musique}s.\\
Les \type{newnotes} sont typiquement des {\em musique}s, mais si à la fois \type{newnotes1} et \type{obj} sont des listes, \type{notes+} est appliqué élément à élément.\\
Voir \in{la fonction \type{rm} (\at{page}[rm-info])}[rm-info] pour l'usage du dernier paramètre optionnel \type{obj-start-pos}.
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{dispatch-chords}  
\syntax {(dispatch-chords instruments where-pos music-with-chords . args)}{}

\type{dispatch-chords} assigne chaque notes des accords d'une {\em musique} à des parties séparées.\\
\type{instruments} est la liste d'{\em instrument}s recevant, à la position \type{where-pos}, ces parties.\\
\type{music-with-chords} est la {\em musique} contenant les accords.
La note 1 d'un accord est envoyée au dernier élément de la liste \type{instruments} , puis la note 2 à l'avant dernier etc…\\
Le code :
\startlily
music = { <c e g>4 <d f b>-. }
(dispatch-chords '(alto (tenorI tenorII) basse) 6 music)
\stoplily
donnera à la mesure 6 :
\startlily
basse   &$\leftarrow$& { c4 d-. }
tenorI  &$\leftarrow$& { e4 f-. }
tenorII &$\leftarrow$& { e4 f-. }
alto    &$\leftarrow$& { g4 b-. }
\stoplily
\blank
Les arguments optionnels disponibles, sont les mêmes que \goto{la fonction \type{rm}}[rm-info] (\at{page}[rm-info]) 
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{reverse-chords}  
\syntax {(reverse-chords n music}{strict-comp?)}
\index{set-reverse}
ou : (2\high{ème} forme  équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\syntax {((set-reverse n [strict-comp?]) music)}{}
Renverse \type{n} fois les accords contenus dans \type{music}.\\
La note déplacée est octaviée autant de fois qu'il est nécessaire pour que sa hauteur soit supérieure (inférieure si \type{n<0}) à la note qui la précède.\\
Le paramètre optionnel \type{strict-comp?} propose soit, s'il est à \type{#t}, la comparaison : {\em strictement} supérieure ({\em strictement} inférieure pour \type{n<0}), soit s'il est à \type{#f}, la comparaison : supérieure (inférieure) ou {\em égale}.\\
Par défaut, \type{strict-comp?} est à \type{#f} pour \type{set-reverse} et à \type{#t} pour \type{reverse-chords} !
\blank[2em]
\underbar{\sc\Words Exemple} (en mode hauteur absolue) :
\blank[1.3em]
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\startmylily
                   music    &\hbox to 1.3em {\\$=$\\}\hbox to 0.1em {\\}&  { <c e g>   <c g e'>    <c e c'> }
(reverse-chords 1 music)    &$\Longrightarrow$&  {   <e g c'>  <g e' c''>  <e c' c''> }
(reverse-chords 2 music)    &$\Longrightarrow$&  {     <g c' e'> <e' c'' g''><c' c'' e''> }

(reverse-chords 0 music)    &$\Longrightarrow$&  {       <c e g>   <c g e'>  <c e c'> }
(reverse-chords -1 music)   &$\Longrightarrow$&  {    <g, c e>  <e, c g>  <c, c e> }
(reverse-chords -2 music)   &$\Longrightarrow$&  { <e, g, c><g,, e, c><e,, c, c> }

(reverse-chords 1 music #f) &$\Longrightarrow$&  {   <e g c'>  <g e' c''>  <e c' c'> }
\stopmylily

\blank
\midaligned{ \tfd ------------}
\godown[1.2em]

%%%%%%%%%
\func{braketify-chords}  
\syntax{(braketify-chords obj)}{}

Ajoute des crochets aux accords, contenant au moins 2 notes, et non liés à l'accord précédent par un tilde  \type{~} \\
Cette fonction étend la fonction \type{\braketifyChords} définie dans {\em copyArticulations.ly} en acceptant aussi en paramètre, une liste de {\em musique}s, un {\em instrument}, ou une liste d'{\em instrument}s.
\blank[1.2em]
\midaligned{ \tfd ------------}\\
\godown[-0.5em]

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                     
\subject[gerer-accords-voix]{Gérer accords et voix ensemble}
Les fonctions suivantes sont toutes compatibles avec \goto{\type{apply-to}}[apply-to].
\godown[2em] 

%%%%%%%%%
\func{treble-of}
\syntax {(treble-of music)}{}
 
Extrait dans la première voix, la dernière note de chaque
accord.

\blank
\midaligned{ \tfd ------------}\\
\godown[0.5em]

%%%%%%%%%
\func{bass-of} 
\syntax {(bass-of music)}{} 

Extrait dans la dernière voix, la première note de chaque
accord.

\blank
\midaligned{ \tfd ------------}\\
\godown[0.5em]

%%%%%%%%%
\func{voices->chords} 
\syntax {(voices->chords [n] music)}{} 

Transforme les {\em musiques simultanées} de \type{music} en des
{\em musiques séquentielles} avec des accords de \type{n} notes. (\type{n = 2} si \type{n} omis)\\
Par défaut, la 1\high{ère} note d'un accord est extrait de la dernière voix, 
et ainsi de suite, mais un ordre particulier peut être établi en remplaçant
\type{n} par une liste d'entiers. \\
\startlily
music = << { e' g' } { c' d' } { a b } >>
(voices->chords 3 music)        &\rm{donnera}& { <a c' e'> <b d' g'> }
(voices->chords '(3 2 1) music) &\rm{donnera}& { <a c' e'> <b d' g'> } &\rm{(idem)}&
(voices->chords '(2 1 3) music) &\rm{donnera}& { <c' e' a> <d' g' b> }
\stoplily
Les resultats obtenus seront exactement les mêmes pour :
\startlily
music = << { e'4. g'8 } \\ { c'4 d' } \\ { a8 b4. } >>
\stoplily
et le rythme sera pris sur la voix 1 soit \type+{ 4. 8 }+ \\
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Par contre pour :
\startlily
music = \voices 1,3,2 << { e'4. g'8 } \\ { c'8 d'4. } \\ { a b } >>
\stoplily
le 1\high{er} accord sera précédé de toute une serie d'\type+\override+ ou de \type+\set+\\
On peut utiliser la fonction \goto{\type{set-del-events}}[set-del-events] pour ne garder que les notes.
\startlily
((set-del-events 'OverrideProperty 'PropertySet)(voices->chords 3 music))
\stoplily

\blank
\midaligned{ \tfd ------------}\\
\godown[1.5em]

%%%%%%%%%
\func{chords->voices} 
\syntax {(chords->voices [n] music)}{}

La fonction utilise la fonction \goto{\type{note}}[note] (\at{page}[note]) et la fonction \goto{\type{split}}[split] (\at{page}[split]).\\
Elle est équivalent à :\\
\startlily 
(split (note n music) 
       (note (- n 1) music)
       …
       (note 1 music))
\stoplily
Par défaut, \type+n = 2+\\
\type+n+ est converti par la fonction \goto{\type{split}}[split] en une liste de {\em id}s pour chaque voix. Néanmoins, une liste de nombres peut être directement spécifiée, mais en tenant compte qu'à la 1\high{ère} note d'un accord correspond la dernière voix.
\startlily
music = { <a c' e'> <b d' g'> }
(chords->voices 3 music) &\rm{et}& (chords->voices '(1 3 2) music) &\rm{donneront} :& 
\voices 1,3,2 << { e' g' } \\ { c' d' } \\ { a b } >>
\stoplily

\blank
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\func{chords->nmusics} 
\syntax {(chords->nmusics n music)}{}
\index{set-chords->nmusics}
ou : (2\high{ème} forme  équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\syntax {((set-chords->nmusics n) music)}{}

Transforme une séquence d'accords en une {\em liste} de\type{ n }{\em musiques}\\
\blank
Pour : \type+music = {<e g c'> <d f b> <c e g c'>}+\\
La fonction \type{chords->nmusics} donnera les listes suivantes :

\blank
\hbox{{\hspace[lilyindent]}
\starttable[|c|l|]
 \NC n \VL liste \NC\SR
 \HL
 \NC 1 \VL \type+{e d c}+ \NC\FR
 \NR
 \NC 2 \VL \type+{g f e}{e d c}+ \NC\MR
 \NR
 \NC 3 \VL \type+{c' b g}{g f e}{e d c}+ \NC\MR
 \NR
 \NC 4 \VL \type+{c' b c'}{c' b g}{g f e}{e d c}+ \NC\LR
\stoptable
}
\blank[1.5em]
Voir une utilisation de \type{chords->nmusics} à \goto{l'exemple 5}[exemple5] de la \at{page}[exemple5].
\blank[1.5em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

                     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subject[gerer-hauteur]{Gérer les hauteurs des notes}
\blank[-2em]
%%%%%%%%%
\func{rel}
\syntax {(rel [n] music)}{}
Renvoie : \type{\relative} {\em hauteur} \type{\music}\\
\midaligned{ {\em hauteur} étant le do central c' transposé de \type{n} octaves.}
%\rightaligned{{\em hauteur} étant le do central c' transposé de \type{n} octaves.}

\hbox{{\hspace[lilyindent]}
\starttable[s0|rs0|l|]
 \NC \type{(rel -2 music)} \Longrightarrow \NC\JustLeft\type{ \relative c, \music} \NC\FR
 \NR
 \NC \type{(rel -1 music)} \Longrightarrow \NC\JustLeft\type{ \relative c \music} \NC\MR
 \NR
 \NC \type{(rel music)}    \Longrightarrow \NC\JustLeft\type{ \relative c' \music}  \% {\em par défaut :} \type{n=0} \NC\MR
 \NR
 \NC \type{(rel 1 music)}    \Longrightarrow \NC\JustLeft\type{ \relative c'' \music} \NC\MR
 \NR
 \NC \type{(rel 2 music)}  \Longrightarrow \NC\JustLeft\type{ \relative c''' \music} \NC\LR
\stoptable
} % end of \hbox

Une syntaxe étendue est possible. Voir la fonction \goto{\type{octave}}[octave] \at{page}[octave]

\blank[1em]
\midaligned{ \tfd ------------}\\

%%%%%%%%%
\func{set-pitch} (fonction de référence \type+\changePitch+)%
\syntax {((set-pitch from-notes) obj)}{}

Échange la hauteur des notes de \type{obj} par celles de \type{from-notes}.
Utilisable avec \goto{\em apply-to}[apply-to]. Voir \goto{l'exemple 5}[exemple5] de la \at{page}[exemple5].
\blank[0.6em]
\midaligned{ \tfd ------------}\\

%%%%%%%%%
\func{set-transp}
\syntax {((set-transp octave note-index alteration/2) obj [obj2 [obj3 …]])}{}
\syntax {((set-transp func) obj [obj2 [obj3 …]])}{}

Applique la fonction scheme Lilypond \type{ly:pitch-transpose} à chaque hauteur de notes de \type{obj}, avec le paramètre {\em "delta-pitch"} égal :
\startitemize[joinedup,intro]
  \nop soit à la valeur de \type{(ly:make-pitch octave note-index alteration/2)} (syntaxe 1)
  \nop soit à la valeur retournée par la fonction \type{func(p)} (syntaxe 2). (\type{p} {\em pitch} courant à transposer).
\stopitemize
\blank
%%Le 3\high{\itxx ième} paramètre (altérations) est un multiple de $\pm1/2$ \\

Les paramètres \type{obj} sont des {\em musique}s, des {\em instrument}s ou une liste d'un de ces 2 types.\\
La fonction renvoie la {\em musique} transposée, ou une liste de {\em musique}s transposées.\\
\type{set-transp} est compatible avec \in{\type{apply-to}}[apply-to]
et peut s'utiliser de la manière suivante :
\startlily
#(let((5th (set-transp 0 4 0))}      ; 4&\em{\small & notes au dessus = une quinte&}&
      (3rd (set-transp 0 2 -1/2))    ; &\em{\small &comme de do à mib&}&
      (enhar (set-transp 0 1 -1)))   ; &\em{\small &de do à rebb = enharmonie&}&
   (rm all 67 (5th (em all 11 23)))  ; &\em{\small &[11-23] est copié à 67 à la quinte&}&
   (rm '(AclarI AclarII) 1 (3rd cl1 cl2))  ; &\em{\small &sons réels transcrits en la&}&
   (apply-to 'saxAlto enhar 10 15)   ; &\em{\small &met [10-15] au ton enharmonique&}&
\stoplily
La fonction \type{maj->min} présentée maintenant, utilise la syntaxe 2 pour adapter l'intervalle de transposition aux alentours des notes modales (degré III et VI) du ton majeur d'origine. 
\startfiguretext[right,fit][set-transp-func]{}
 {\vbox{\godown[-0.2em]\externalfigure[set-transp-func-fr][wfactor=345, align=flushright]}}
 {\vbox{\godown[-0.4em]
\setupinterlinespace[big]
\type{'II} et \type{'III}\\sont transposés de Do majeur en La et\\Do mineur.}}
\stopfiguretext
\setupinterlinespace[small]
\godown[-0.55em]
La fonction \type{maj->min} est définie de la manière suivante :
\page %%%%%%%%%%%%
\startmylily
#(define (maj->min from-pitch to-pitch)  ;&\em{\small& renvoie la fonction lambda &}&
   (let ((delta (ly:pitch-diff to-pitch from-pitch))
         (special-pitches (music-pitches ;&\em{\small& voir scm/music-functions.scm &}&
           (ly:music-transpose #{ dis e eis gis a ais #} from-pitch))))
     (lambda(p) (ly:make-pitch           ;&\em{\small& renvoie le "delta pitch" &}&
       0 
       (ly:pitch-steps delta) 
       (+ (ly:pitch-alteration delta) ;&\em{\small& l'intervalle varie selon p &}&   
          (if (find (same-pitch-as p 'any-octave) special-pitches)
            -1/2  0))))))   ;&\em{\small& same-pitch-as est défini dans checkPitch.ly &}&
\stopmylily
Il ne reste plus qu'à choisir le paramètre \type{to-pitch} à appliquer à \type{'II} et \type{'III} :
\startmylily 
(apply-to 'II (set-transp (maj->min  #{ c' #} #{ a #})) 1 8) 
(apply-to 'III (set-transp (maj->min #{ c' #} #{ c' #})) 1 8))            
\stopmylily

\blank[0.8em]
\midaligned{ \tfd ------------}
\godown[0.4em]

%%%%%%%%%
\func{octave}
\godown[-0.2em]
\syntax {(octave n obj)}{}
\godown[-0.2em]
ou : (2\high{ème} forme équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\godown[-0.3em]
\index{set-octave}
\syntax {((set-octave n) obj)}{}

Basiquement, \type{octave} est un simple raccourci de la fonction \type{(set-transp n 0 0)},
\type{n} pouvant être positif (transposition vers le haut) ou négatif (transposition vers le bas).\\
Cependant, au même titre que \type{rel} et \type{octave+}, elle bénéficie d'une syntaxe étendue.\\
En voici quelques possibilités.
\godown[0.5em]

\underbar{1\high{er} cas} : mettre un thème à l'octave à des instruments de tessitures différentes.
\blank[1mm]
\startmylily
(rm '(vlI vlII alto (vlc ctb)) 18 (octave 2 1 0 -1 theme))
\stopmylily 
\blank[1mm]
La fonction renvoie la liste \type{((octave 2 theme)(octave 1 theme)} etc …\type{)}\\
Notez que le violoncelle et la contrebasse reçoivent la même musique : \type{(octave -1 theme)}\godown[0.5em]

\underbar{2\high{ème} cas} : mettre à l'octave plusieurs musiques à la fois.
\blank[1mm]
\startmylily
(rm '(instruI instruII instruIII instruIV) 18 (octave 1 m1 m2 m3 m4))
\stopmylily 
\blank[1mm]
Toutes les musiques \type{m1 m2 m3 m4} sont transposées à l'octave.
\godown[0.5em]

\underbar{3\high{ème} cas} : grand mélange !
\blank[1mm]
\startmylily
(rm '(vlI vlII alto (vlc ctb)) 18 (octave 2 m1 1 m2 m3 -1 m4))
\stopmylily 
\blank[1mm]
\type{m1} est transposée de 2 octaves au dessus, \type{m2} et \type{m3} : 1 octave et \type{m4} :~1 octave en dessous.

\godown[0.9em]
\midaligned{ \tfd ------------}
\godown[0.5em]

%%%%%%%%%
\func{octavize}
\godown[-0.1em]
\syntax {(octavize n obj from-pos1 to-pos1 [/ from-pos2 to-pos2 /…])}{} 

\type{octavize} transpose de \type{n} octaves l'{\em instrumen}t (ou la liste d'{\em instrument}s)\type{ obj} entre les positions \type{[from-pos1 to-pos1]}, \type{[from-pos2 to-pos2]}, etc…

\godown[0.6em]
\midaligned{ \tfd ------------}
\godown[0.3em]

%%%%%%%%%
\func{octave+}
\godown[-0.2em]
\syntax {(octave+ n music)}{}
\godown[-0.3em]
ou : (2\high{ème} forme équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\godown[-0.3em]
\index{set-octave\textplus}
\syntax {((set-octave+ n) obj)}{}
\godown[-0.1em]
Raccourci de \type!(notes+ music (octave n music))! (voir \in{\type{notes+} \at{page}{}[notes+])}[notes+] mais sans doubler les articulations des notes octaviées.\\
\type{octave+} bénéficie de la même extension de syntaxe que \type{octave} (voir ci-dessus) et \type{rel}.

\godown[0.9em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%
\func{add-note-octave} 
\syntax {(add-note-octave n obj from-pos1 to-pos1 [/ from-pos2 to-pos2 /…])}{} 

Applique la fonction \type{(octave+ n music)} précédente à chaque section \type+[from-pos to-pos]+.

\godown[1em]
\midaligned{ \tfd ------------}
\godown[1.5em]

%%%%%%%%%
\hairline
Les 2 fonctions suivantes : \type{fix-pitch} et \type{pitches->percu} sont plus particulièrement destinées aux percussions. Elles mettent un pont entre des notes avec hauteur et des notes de percussions.
\hairline
\godown[2em]

%%%%%%%%%
\func{fix-pitch}
\syntax {(fix-pitch music pitch)}{}
\syntax {(fix-pitch music note-index)}{}
\syntax {(fix-pitch music octave note-index alteration)}{}
\index{set-fix-pitch}
Fixe toutes les notes à la hauteur \type{pitch} (syntaxe 1) ou \type{(ly:make-pitch -1 note-index 0)}  (syntaxe 2), ou enfin \type{(ly:make-pitch octave note-index alteration)}
(syntaxe 3).\\
Ces 3 lignes sont équivalentes :
\startmylily[space=fixed]
(fix-pitch music #{ c #})
(fix-pitch music 0)
(fix-pitch music -1 0 0)
\stopmylily
\blank
La fonction \goto{\type{apply-to}}[apply-to] correspondante \type{((set-fix-pitch …) music)} reprend ces mêmes paramètres de hauteur de note.
\blank[0.2em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{pitches->percu} 
\syntax {(pitches->percu music percu-sym-def . args)}{}
Convertit les notes en des notes de type percussion.\\
\type{args} est une suite de : hauteur de note (pitch) - symbole de percussion.\\
Pour chaque note de \type{music}, la fonction recherche le symbole de percussion correspondant à la hauteur de cette note. À défaut d'en trouver, c'est le symbole \type{percu-sym-def} qui est pris.\\
Cet instrument de percussion est alors assigné à la propriété \type{'drum-style} de la note.\\
On peut optionnellement séparer chaque groupe d'arguments avec une barre oblique \type{/}\\
Notez enfin que tout nombre \type{n} sera transformé en \type{(ly:make-pitch -1 n 0)} par la fonction, comme pour la syntaxe 2 de la fonction \type{fix-pitch} précédente.
\blank[0.5em]
\underbar{\sc\Words exemple 6}
\startfiguretext[right][exemple6]{}
{\externalfigure[exemple06.pdf][wfactor=150, align=flushright]}
\startlily[space=fixed]
music = << 
   { e8 e e e e e e e} \\ 
   { c4 d8 c c4 d8 c } >>
\stoplily
\stopfiguretext
\godown[-2em]
\startlily[space=fixed]
percu = #(pitches->percu music 'hihat /
                       #{ c #} 'bassdrum /  ;&\em{\small& ou : 0 'bassdrum /&}&
                       #{ d #} 'snare)      ;&\em{\small& ou : 1 'snare)&}&

\new DrumStaff \drummode { \percu }
\stoplily
\godown[1em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%
\func{set-range} (voir : \type{correct-out-of-range} dans {\em checkPitch.ly})
\syntax {((set-range range) music)}{} 

\type{range} est une séquence de 2 notes : \type+#{ c, c'' #}+ ou un accord à 2 sons : \type+#{ <c, c''> #}+\\
La fonction transpose à l'octave idoine, toutes les notes en dehors de \type{range}. Elle permet d'ajuster automatiquement une partition à la tessiture d'un instrument.\\
Peut être utiliser avec \goto{\type{apply-to}}[apply-to].

\godown[1em]
\midaligned{ \tfd ------------}
\godown[2em]

%%%%%%%%%
\func{display-transpose} 
\syntax {(display-transpose music amount)}{} 

Déplace visuellement les notes de \type{amount} positions vers le haut ou le bas. Les données midi ne sont pas affectées.

\godown[1em]
\midaligned{ \tfd ------------}
\godown[0.5em]

%%%%%%%%%
\hairline
Devrait être présentée maintenant dans ce chapitre, la fonction \type{cp}.\\
\type{cp} (de l'anglais \underbar{c}hange \underbar{p}itch) permet effectivement de modifier la hauteur d'une séries de notes, sans toucher à leur rythme. Inversement cependant, elle peut modifier le rythme des notes sans toucher à leur hauteur. Le choix a été fait de traiter la fonction \type{cp} (ainsi que la la fonction \type{cp-with}), dans la section suivante : {\em pattern de rythme}.
\hairline
\godown[2em] 

\subject[utiliser-pattern]{Utiliser des «patterns»}
\blank[-1em] 

%%%%%%%%%
\func{cp} : pattern de {\em rythme} (fonction référence \type+\changePitch+%
\footnote{Voir {\em changePitch-doc.pdf} à \from[changePitch]})
\index{cp1{,} cp2}
\syntax {(cp [keep-last-rests?] pattern[s] music[s])}{}
ou : (2\high{ème} forme équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\index{set-pat}
\syntax {((set-pat pattern [keep-last-rests?]) obj)}{}

\type{cp} est basiquement équivalent à \type+\changePitch \pattern \music+\\
Elle renvoie une {\em musique} quand \type{pattern} et \type{music} sont des {\em musique}s, et  une liste de {\em musique}s, si un de ces 2 paramètres est une liste de {\em musique}s ou d'{\em instrument}s.\\
Si \type{pattern} finit par des silences, le paramètre optionnel \type{keep-last-rests?} indique s'ils doivent être également inclus après la toute dernière note.\\
\type{keep-last-rests?} est par défaut, à \type{#t} pour \type{cp} et à \type{#f} pour \type{set-pat}.\\
2 raccourcis de \type{cp} ont été définis :
\startmylily
(cp1 obj)   &$\Longrightarrow$&   (cp patI obj)
(cp2 obj)   &$\Longrightarrow$&   (cp patII obj)
\stopmylily
Voir \goto{\type{tweak-notes-seq}}[tweak-notes-seq] (\at{page}[tweak-notes-seq]) pour un exemple d'utilisation du raccourci \type{cp1}
\blank[1em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                

%%%%%%%%%
\func{cp-with} 
\syntax {(cp-with obj pos1 notes1 [pos2 notes2 [pos3 notes3…]])}{}
Remplace à la position \type{pos}, les notes de \type{obj} par celles contenues dans \type{notes}.\\
Les rythmes originels de \type{obj} restent inchangés, seules les hauteurs de notes sont modifiées. Les articulations sont mixées.\\
Une barre oblique / après chaque paramètre \type{notes} permettra éventuellement de clarifier visuellement le code.\\
À l'instar de \goto{\type{rm-with}}[rm-with], on peut se servir de la fonction scheme \type{delay} pour récupérer la musique modifiée dans une section précédente.
\blank[0.3em]
\midaligned{ \tfd ------------}
\godown[0.8em]

%%%%%%%%%
\func{ca} : pattern {\em d'articulations} (fonction référence \type+\copyArticulations+
\footnote{Voir \from[copyArticulations-LSR] pour l'utilisation de \type{\copyArticulations}})
\syntax{(ca pattern[s] music[s])}{}
ou : (2\high{ème} forme équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\index{set-arti}
\syntax{((set-arti pattern) obj)}{}

Copie les articulations de \type{pattern} dans \type{music}, et retourne \type{music}.\\
Si au moins 1 des 2 paramètres est une liste (une liste de musiques ou une liste d'instruments), la fonction retourne une liste de musiques.\\
On pourra utiliser à l'intérieur des \type{music}s les fonctions définies dans {\em copyArticulations.ly}~:\\\type{\notCopyArticulations} (raccourci \type{\notCA}), \type{\skipArti}, \type{\nSkipArti} et \type{\skipTiedNotes}.
\blank[0.8em]
\midaligned{ \tfd ------------}
\godown[0.7em]

%%%%%%%%%
\func{fill-with} : pattern de {\em musiques}
\syntax {(fill-with pattern from-pos to-pos)}{}

Répète la musique \type{pattern} le nombre de fois nécessaire
pour remplir exactement l'intervalle \type{[from-pos to-pos]}, coupant
éventuellement la dernière copie.\\
Renvoie la musique obtenue, ou une liste des musiques si \type{pattern} est une liste de musiques.
\blank[0.7em]
\midaligned{ \tfd ------------}
\godown[0.7em]

%%%%%%%%%
\func{fill} : pattern de {\em musiques}
\syntax {(fill obj pattern from-pos to-pos . args)}{} 

Équivalent de \type{(rm obj from-pos music)} avec
\startmylily music = (fill-with pattern from-pos to-pos) \stopmylily
La syntaxe suivante est possible :
\startmylily (fill obj pat1 from1 to1 / [pat2] from2 to2 / [pat3] from3 to3 …) \stopmylily
Si un paramètre \type{pat} est omis, celui de la section précédente est récupéré.\\
Voir \goto{exemple 5}[exemple5] \at{page}[exemple5].
\blank[0.2em]
\midaligned{ \tfd ------------}
\godown[0.8em]

%%%%%%%%%
\func{fill-percent} : pattern de {\em musiques}
\syntax {(fill-percent obj pattern from-pos to-pos . args)}{} 

Idem que pour la fonction \type{fill} ci-dessus mais produit des \type{\repeat percent}
\startfiguretext[right][fill-percent]{}
{\vbox{\blank[-0.8em]\externalfigure[fill-percent.pdf][wfactor=200, align=flushright]}}
\startlily
(fill-percent 'I 
   #{ c'4 d' e' f' #} 1 4)
(fill-percent 'II 
   #{ c'4 d' #} 1 4)
\stoplily
\stopfiguretext
%\godown[-3em]
\blank
\midaligned{ \tfd ------------}\\ 

%%%%%%%%%
\func{tweak-notes-seq} : pattern de {\em notes}
\syntax {(tweak-notes-seq n-list music)}{} 
ou : (2\high{ème} forme  équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\index{set-tweak-notes-seq}
\syntax {((set-tweak-notes-seq n-list) music)}{}
\type{music} est une musique contenant des notes.\\
\type{n-list} est une liste d'entiers. Chaque nombre \type{n} représente la n\high{ième} note pris dans \type{music}.\\
\type{tweak-notes-seq} retourne une séquence de notes en remplaçant chaque chiffres de \type{n-list}  par la note correspondante. Quand le dernier chiffre est atteint, le processus recommence au début de la liste de nombres, mais en les augmentant du plus grand chiffre de la liste. Le processus s'arrête quand il n'y a plus, dans \type{music}, de notes à faire correspondre.
\startmylily
(tweak-notes-seq '(1 2 3 2 1) #{ c d e | d e f | e f g #}) 
& $\Longrightarrow$ & { c d e d c
      d e f e d
      e f g f e }
\stopmylily
On peut remplacer, dans \type{n-list}, un nombre \type{n} par une paire \type{(n . music-function)}.\\\type{music-function} est alors appliqué à la note \type{n}. Elle doit prendre en paramètre une musique et retourner une musique. Classiquement, cette fonction est \goto{\type{set-octave}}[octave].\\
L'exemple suivant utilise cette fonctionnalité, couplée au raccourci \goto{\type{cp1}}[set-pat] de la fonction \type{set-pat}

\startfiguretext[right][exemple7]{}
{\vbox{\blank[-0.5em]\externalfigure[exemple07.pdf][wfactor=235, align=flushright]}}
\underbar{\sc\Words exemple 7}
\godown[0.2em]
\startlily[space=fixed]
patI = { r8 c16 c c8 c c c }

#(rm 'instru 1 (cp1
\stoplily
\stopfiguretext
\godown[-3em]
\startlily
   (tweak-notes-seq `(1 2 3 (1 . ,(set-octave +1)) 3 2) 
                    (rel 1 #{ c e g | a, c e | f, a c | g b d #}))))
\stoplily
\midaligned{ \tfd ------------}\\

%%%%%%%%%%
\func{x-pos} : pattern de {\em numéros de mesure}
\syntax {(x-pos n-from n-to [pos-pat [step]])} {}
\syntax {((x-pos [pos-pat [step]]) n-from1 n-to1 [n-from2 n-to2...])} {}

Les paramètres \type{n-from} et \type{n-to} sont des numéros de mesures (des nombres entiers).\\
\type{pos-pat} est une liste de {\em position}s \footnote {Les positions sont définies \in{dans le paragraphe \quotation{positions musicales}, \at{page}[positions_musicales].}[positions_musicales]}, avec une lettre, habituellement n, à la place du numéro de mesure.\\
\type{x-pos} convertit cette liste, en remplaçant n (la lettre) par le numéro de mesure  \type{n-from} et en l'augmentant récursivement de \type{step} unités, tant que cette valeur reste strictement inférieure à \type{n-to}.\\
Dans la syntaxe 2, \type{x-pos} applique successivement le même pattern \type{pos-pat} et \type{step} à chacun des couples \type{n-from}/\type{n-to}.\\
Par defaut, \type{pos-pat} = \type{'(n)}, \type{step} = 1
\page %%%%%%%%%%%%%%%%%%%%
Le tableau suivant montre la liste obtenue avec différentes valeurs:
\startmylily
(x-pos 10 14)              & $\Longrightarrow$ & '(10 11 12 13)
(x-pos 10 14 '(n (n 4)))   & $\Longrightarrow$ & '(10 (10 4) 11 (11 4) 12 (12 4) 13 (13 4))
(x-pos 10 14 '(n (n 4)) 2) & $\Longrightarrow$ & '(10 (10 4) 12 (12 4))
(x-pos 10 13 '(n (n 4)) 2) & $\Longrightarrow$ & '(10 (10 4) 12 (12 4))
(x-pos 10 12 '(n (n 4)) 2) & $\Longrightarrow$ & '(10 (10 4))
\stopmylily
\type{x-pos} peut être utilisé avec par exemple \type{x-rm}, conjointement avec la fonction scheme \type{apply} :
\blank
\reference[exemple8]{exemple8}
\starthanging[right]
{\vbox{\blank[5em]\externalfigure[exemple08.pdf][wfactor=303, align=flushright]}}
\underbar{\sc\Words exemple 8}
\startlily
global = {s1*12 \bar "|."}
music = { e'2 f' | g' f' | e'1 }

all = #'(I II)
#(init all)

#(begin
  (rm all 10 music)
  (apply x-rm 'II #{ c'8 c' c' #} (x-pos 10 13 '((n 8)(n 2 8)))))
\stoplily
\stophanging
\godown[1em]

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                                
\subject[ajouter-text]{Ajouter du texte et des citations musicales (quote)}
\godown[2em]
%%%%%%%%
\func{txt}
\syntax {(txt text [dir [X-align [Y-offset]]])}{}

\type{text} est un {\em markup} \\
\type{dir} est la {\em direction} de \type{text} : %
\type{1} (ou \type{UP}), \type{-1} (ou \type{DOWN}), ou par défaut \type{0} (automatique).\\
\type{X-align} est la valeur de la propriété {\em self-alignment-X} de \type{text} : \type{-1} par défaut.\\
\hbox{{\hspace[lilyindent]}
\starttable[|c|c|]  
\NC \type{X-align} \VL alignement du texte \NC\SR
\HL
\NC -1 ou \type{LEFT}\VL à gauche \NC\FR
\NC 1 ou \type{RIGHT}\VL à droite \NC\MR
\NC 0 ou \type{CENTER} \VL centré \NC\LR
\stoptable 
}\\
\type{Y-offset} est la valeur de la propriété {\em Y-offset} du text : 0 par défaut\\
La fonction retourne un {\em skip} de longueur nulle.\\
\underbar{\sc\Words Exemple} :
\startmylily (txt "Bonjour" UP 0 -2) \stopmylily
est équivalent à :
\startmylily
s1*0 -\tweak self-alignment-X #CENTER 
     -\tweak Y-offset #-2 
     ^"Bonjour"  % &\em{&^ = UP &}&
\stopmylily
Notez que mettre un des paramètres optionnels \type{dir}, \type{X-align} ou \type{Y-offset} à la valeur \type{#f}, a le même effet que d'omettre ce paramètre : sa propriété correspondante n'est pas modifiée.
\blank[1em]
\midaligned{ \tfd ------------}
\godown[1em]

%%%%%%%%%
\func{adef}
\syntax {(adef music [text [dir [X-align [Y-offset]]]])}{}

Ajoute \type{music} avec des notes de petite taille, comme pour un {\em «a defaut»}. Un texte peut être ajouter avec les mêmes arguments que pour la fonction \type{txt} précédente.
\page %%%%%%%%%%%%%%%%%%%%
\reference[exemple9]{exemple9}
\underbar{\sc\Words Exemple 9} :
\godown[0.5em]
\setupnarrower[left=\lilyindent]
\defineparagraphs[mypar][n=2,before={\blank[0.2em]\startnarrower},after={\blank[0.8em]\stopnarrower},distance=0cm]
\setupparagraphs[mypar][1][width=0.31\textwidth]
%\setupparagraphs[mypar][2][width=\textwidth]
%%%%
\startmypar
\godown[1.4em]
Soit le violon sui-
\crlf vant :
\mypar %%%%%
\mbox{\hspace[lilyindent]\externalfigure[exemple09-violon.pdf][wfactor=240]}
%\placefigure[here][]{}{\externalfigure[exemple09-violon.pdf][wfactor=240]}
\stopmypar
%%%%
\startmypar
\godown[0.2em]
et une flute com-
\crlf mençant mesure 4~:
\mypar %%%%%
\godown[0.5em]
\startmylily (rm 'fl 4 (rel #{ f'4 g a b | c1 #})) \stopmylily
\stopmypar
%%%%
\startmypar
\godown[1.2em]
Le code suivant~:
\mypar %%%%%
\startmylily
(add-voice2 'fl 3 
       (adef (em vl 3 4) "(violon)" DOWN))
(rm 'fl 4 (txt "obligé" UP))       
\stopmylily
\stopmypar\godown[0.5em]
%%%%
\startmypar
\godown[1.8em]
donnera à la flute~:
\mypar %%%%%
\mbox{\hspace[lilyindent]\externalfigure[exemple09-flute-fr.pdf][wfactor=240, align=flushleft]}
%\placefigure[here][]{}{\externalfigure[exemple09-flute-fr.pdf][wfactor=240]}
\stopmypar
\godown[0.5em]
La difference de taille d'un {\em \quotation{a defaut}} par rapport à la taille courante est  \type+adef-size = -3+. On peut re-définir \type+adef-size+ à souhait. Par exemple :
\startmylily(define adef-size -2)\stopmylily
Si on veut avoir, dans l'exemple ci-dessus, le texte "(violon)" à la taille normale, il faut remplacer ce texte par le {\em markup} suivant :
\startmylily (markup (#:fontsize (- adef-size) "(violon)")) \stopmylily
\blank
\midaligned{ \tfd ------------}
%\godown[-1em]

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                              
\subject{Ajouter des nuances}
\godown[1.6em]
\func{add-dynamics}
\syntax {(add-dynamics obj pos-dyn-str)}{}

\type{obj} est une {\em musique}, un {\em instrument}, ou une liste d' {\em instrument}s.\\
\type{pos-dyn-str} est une chaîne de caractère "…", composée d'une séquence de position-nuances, separées par une barre oblique~\type{/} (cette barre est ici obligatoire).\\
La fonction analyse la chaîne \type{pos-dyn-str} et renvoie un code de la forme :
\startmylily
(rm-with obj pos1 #{ <>\dynamics1 #} / pos2 #{ <>\dynamics2 #} /…)
\stopmylily
Pour les positions sous formes de listes, le caractère \type{'} peut être omis :\\
\hbox{\hspace[lilyindent]\type{'(11 4 8)} $\Longrightarrow$ \type{(11 4 8)}.}\\
Pour les nuances, les  barres obliques inversées~\type+\+ {\em doivent} être retirées.\\
Les symboles de direction, par contre, \type+-^_+ sont autorisés.\\
Séparer plusieurs nuances par un espace.
\godown[1em]
\underbar{\sc\Words Exemple} :
\godown[0.6em]
En reprenant le violon de l'exemple 9 précédent, le code suivant :
\godown[-0.4em]
\startlily
(add-dynamics 'vl "1 mf / 2 > / 3 p cresc / (4 2) ^f")
\stoplily
\godown[-0.4em]
donnera :
\godown[0.1em]
\mbox{\hspace[lilyindent]\externalfigure[exemple09-violon-nuances.pdf][wfactor=265, align=flushleft]}
%\godown[-0.4em]

- Une position suivie d'aucune nuance indique à la fonction de chercher et de supprimer la nuance précédente qui se produirait au même {\em moment}.

\page %%%%%%%%%%%%%%%%%%%%

- Il est possible de spécifier des ajustements de la position \type{X} et \type{Y} d'une nuance \type{dyn} par la syntaxe de base suivante (elle suffira dans la majorité des cas) : \type{dyn#X#Y}.\\
Avec par exemple : \type{mf#1#-1.5} le code produit sera :
\godown[-0.4em]
\startlily <>-\tweak self-alignment-X #1 -\tweak extra-offset #'(0 . -1.5) -\mf \stoplily
\godown[-0.4em]
Pour remplacer le {\em zero} du 1\high{er} element de la paire du \type{extra-offset}, on peut mettre également un 3\high{ème} paramètre {\em entre} les 2 autres. La syntaxe générale devient alors :
\startlily dyn#val1#val3#val2 \stoplily
\godown[-0.4em]
qui produit :
\godown[-0.4em]
\startlily <>-\tweak self-alignment-X #val1 -\tweak extra-offset #'(val3 . val2) -\dyn \stoplily 
\godown[-0.4em]
Une valeur \type{val} peut-être omise mais le nombre de \type{#} doit correspondre à 
l'indice 1,2 ou 3~:\\
\hbox{{\hspace[lilyindent]}
\starttable[s0|ls2|c|l|]
 \NC \type{#val}   \NC \Longrightarrow \NC\JustLeft\type{val1} : \type{self-alignment-X val}\NC\FR
 \NC \type{##val}  \NC \Longrightarrow \NC\JustLeft\type{val2} : \type{extra-offset #'(0 . val)}\NC\MR
 \NC \type{##val#} \NC \Longrightarrow \NC\JustLeft\type{val3} : \type{extra-offset #'(val . 0)}\NC\MR
 \NC \type{##valA#valB} \NC \Longrightarrow \NC\JustLeft\type{val3,val2} : \type{extra-offset #'(valA . valB)}\NC\LR
\stoptable
}\\ % end of \hbox
\godown[1em]
- Indépendemment de ces ajustements de placement induits de la commande \type{\tweak}, la fonction \type{add-dynamics} permet un placement très précis des nuances par un choix judicieux de sa position musicale associée. Cependant, s'il est facile d'insérer une nuance à une position \type{'(3 64)} par exemple,, un problème se pose si une noire commence à la mesure \type{3} car elle sera coupée à la quadruple croche !\\
Une astuce est de créer pour l'instrument \type{'instru}, une voix séparée spéciale, \type{instruDyn} par exemple, composée de \type{skip}s, et qui recevra toutes les nuances de 
\type{instru}.\\
Il suffit ensuite de combiner cette voix avec \type{\instru} et \type{\global}.\\
L'exemple du début de paragraphe deviendra~:
\godown[-0.4em]
\startlily
(def! 'vlDyn)  ; & \at{\em{voir page}}{}[def!]. &
(add-dynamics 'vlDyn "1 mf / 2 > / 3 p cresc / (4 2) ^f")
…
\new Staff { << \global \vlDyn \vl >> }
\stoplily
\godown[-0.4em]
Notez que cette façon de faire est identique à la manière traditionnelle de procéder, sauf qu'ici, pas besoin de faire des calculs pour trouver la durée adéquate des \type{skip} entre 2 nuances. C'est {\em arranger.ly} qui s'en charge.\\
Notez également, que {\em arranger.ly} introduit une fonction \goto{\type{sym-append}}[sym-append], particulièrement adaptée à la création de ces voix spéciales, comme le montre l'exemple de \at{la page}{}[sym-append].\\
Une voix dédiée permettra aussi l'insertion de nuances, dans des \type{tuplet}s :\\
\startnarrower
- un {\em forte} sur la 2\high{ème} croche d'un triolet d'une mesure 5, s'obtient par \type{"(5 12) f"} \footnote{Il y a 12 croches de triolets dans une ronde},\\
- la 3\high{ème} croche par \type{"(5 12 12) f"} ou par \type{"(5 6) f"}.\\
\stopnarrower
La syntaxe avec fractions, elle, n'est utilisable dans \type{add-dynamics}, que par le biais de variables à inclure dans la chaîne de caractères :
\godown[-0.3em]
\startlily
#(define frac 1/12)
#(add-dynamics 'vlDyn "(5 frac) f / (5 (* 2 frac) p") ;&\tfx\em{& '(5 1/12) et '(5 2/12)&}&
\stoplily
- Les nuances au sein d'une section \type+\grace+ necessitent, par contre, une syntaxe particulière.\\
Pour les signaler au sein du code, on utilisera  le caractère : (2 points), suivi immédiatement de la durée \type{(8 16 …)} du \type{skip} qui "portera" éventuellement la nuance à l'intérieur de la section \type+\grace+.\\
\vtop{\hbox{
 \hspace[lilyindent]
 \starttable[lT|c|lT|]
    %% ConTeXt "mange" les espaces après \grace => on met 2 \type
    \type{"p:8"} \NC produira \NC \type+{ \grace+\type+ { s8\p } <> }+ \FR
    \NR
    \type{":16 mf:16"} \NC produira \NC \type+{ \grace+\type+ { s16 s16\mf } <> }+ \MR
    \NR
    \type{"<:16 :16*2 f"} \NC produira \NC \type+{ \grace+\type+ { s16\< s16*2 } <>\f }+ \LR    
    \NR
  \stoptable}
}

\page %%%%%%%%%%%%%%%
On pourra utiliser conjointement le caractère \type+#+ pour les "tweaks" de position des nuances mais il devra être placé après (et sans espaces) la section \type+\grace+\\
\startnarrower
\type+"mf:8#1" + produira \type+ { \grace+\type+ { s8-\tweak self-alignment-X #1 \mf } <> }+
\stopnarrower
\startfiguretext[right][exemple]{}
{\vbox{\blank[2.5em]
       \hbox{\externalfigure[grace-dynamics.pdf][wfactor=110, align=flushright]
             \hspace[big]}}}
\underbar{\sc\Words Exemple} :
\godown[-0.2em]
\startlily[space=fixed]
#(begin       ; &\em{&nuances dans une section \grace&}&
(def! '(dyn1 dyn2 dyn3))   ; &\em{&voix dédiées s1*&\dots}&  
(add-dynamics 'dyn1        ; &\em{&un simple cresc&}&
  "1 p / (1 2) <:16 :16*2 f")      
(add-dynamics 'dyn2   ; &\em{&nuances sans ajustements&}&
  "1 p / (1 2) :16 mp:16 mf:16 f") 
(add-dynamics 'dyn3   ; &\em{&nuances avec ajustements&}&
  "1 p / (1 2) :16 mp:16#1.3#-1.2
                   mf:16#0#-0.6 
                   f#-0.2#-0.6"))
\score { <<
     \new Staff $(sim global instru1 dyn1)
     \new Staff $(sim global instru2 dyn2)
     \new Staff $(sim global instru3 dyn3)
   >> }
\stoplily
\stopfiguretext

- Dans le cas où une section \type+\grace+ serait le  2\high{ème} paramètre d'une commande \type+\afterGrace+, une syntaxe particulière est requise pour le 1\high{er} paramètre  ("la note réelle").\\
Il suffira juste, ici, de faire précéder la section \type+\grace+ de la valeur rythmique du  1\high{er} paramètre, que l'on marquera par un double caractère \type+::+\\
\startmylily 
\afterGrace s4\f { s16\p s } 
f::4 p:16 :16    &\leftarrow\em{\tfx& la nuance éventuelle avant :: la valeur rythmique après&}&
\stopmylily
La fraction optionnelle de la commande \type+\afterGrace+ s'obtient de la manière suivante :
\startmylily 
\afterGrace 15/16 s4\f { s16\p s } 
f::4:15:16 p:16 :16
\stopmylily
On veillera a bien faire correspondre la fraction de la musique et des nuances.
\startfiguretext[right][exemple]{}
{\vbox{\blank[5.85em]
       \hbox{\externalfigure[afterGrace-dynamics.pdf][wfactor=180, align=flushright]
             \hspace[big]}}}
\underbar{\sc\Words Exemple} :
\godown[-0.2em]
\startlily[space=fixed]
musicI = { r2 r4 \afterGrace d4-> { es16( e f fis }
           g4->) r r2 } % &\em{\tfx&fraction &}&3/4 &\em{\tfx&par def &}&
musicII = { r2 r4 \afterGrace 15/16 d4-> { es16( e f fis }
            g4->) r r2 } % &\em{\tfx&fraction&}& 15/16 
#(rm all 1 (rel 1 musicI musicII))

#(begin
(def! '(dyn1 dyn2))
(add-dynamics 'dyn1 ; &\em{\tfx&fraction &}&3/4
  "(1 2.) f::4 p:16 <:16 :8 / 2 f")
(add-dynamics 'dyn2 ; &\em{\tfx&fraction &}&15/16 
  "(1 2.) f::4:15:16 p:16 <:16 :8 / 2 f")
)

\stoplily
\stopfiguretext

\hairline
Les fonctions qui suivent, \type{assoc-pos-dyn}, \type{extract-pos-dyn-str}, \type{instru-pos-dyn->music} et \type{add-dyn}, sont des tentatives de simplifier encore plus la gestion des nuances, en évitant notamment, 1) la redondance d'informations à fournir pour les instruments ayant les mêmes nuances aux mêmes endroits, et 2) de résoudre le problème de nuances en double quand, dans les conducteurs, 2 instruments partagent la même portée.
\hairline
\godown[3em]
\func{assoc-pos-dyn}
\syntax {(assoc-pos-dyn pos-dyn-str1 instru1 / pos-dyn-str2 instru2 /…)}{}
Les \type{pos-dyn-str}s sont de base des chaînes de caractères, telles qu'elles ont été définies dans la fonction \goto{\type{add-dynamics}}[add-dynamics] ci-dessus.\\
Chaque \type{instru} est soit un {\em instrument} seul soit une liste d'{\em instrument}s.\\
La fonction retourne une {\em associated-list} formées de {\em paires} \type{'(pos-dyn-str . instru)}.\\ 
Les barres obliques~\type{/} sont facultatives.
\godown[1em]
\underbar{\sc exemple} :
\blank[0.4em]
\startmylily
vls = #'(vlI vlII) 
cors = #'(corI corII corIII corIV) 
all = #'(fl htb cl …)
assocDynList = #(assoc-pos-dyn            
  "1 p" 'corI / "5 mf" vls / "25 f / (31 4) <" cors / 
  "33 ff / 35 decresc / 38 mf" all …)
\stopmylily
\blank[0.5em]
L'extraction des nuances pour un instrument donné, pourra ensuite être réaliser en mettant  \type{assocDynList} en dernier paramètre d'une des 2 fonctions suivantes : \goto{\type{extract-pos-dyn-str}}[extract-pos-dyn-str] et \goto{\type{instru-pos-dyn->music}}[instru-pos-dyn->music].
\blank[1em]
Notez enfin qu'une chaîne de caractères \type{"1 f / 3 mf / 5 p"} pourra aussi être entrée sous forme d'une liste : \type{'("1 f" "3 mf" "5 p")}. L'\at{addendum 2 page}[set-dyn] montre une  utilisation de ce formatage automatique.
\godown[1em]
\midaligned{ \tfd ------------}
\godown[2em]

%%%%%%%%
\func{extract-pos-dyn-str}
\syntax {(extract-pos-dyn-str extract-code assoc-pos-dyn-list)}{}
\type{assoc-pos-dyn-list} est la liste d'association créée avec la fonction \in{\type{assoc-pos-dyn}}[assoc-pos-dyn] précédente.
La fonction \type{extract-pos-dyn-str} renvoie une chaîne de caractères, du type {\em pos-dyn-str} défini \in{dans la fonction \type{add-dynamics}}[add-dynamics]. Elle est formée à partir de tous les {\em pos-dyn-str} dont le ou les {\em instrument}s associés répondent \quotation{vrai} au prédicat \type{extract-code}.
\blank[0.7em]
Voici comment fonctionne le prédicat \type{extract-code} :\\\\
- \type{extract-code} est soit un {\em instrument} seul, soit une liste d'{\em instrument}s avec comme 1\high{er} élément, un des 3 opérateurs logiques suivants : \type{'or 'and 'xor}\\
Pour un instrument seul, \type{extract-code} renvoie \quotation{vrai} quand la liste 
d'instruments associée à un {\em pos-dyn-str} donné, contient cet instrument.\\
Pour 2 instruments, cela dépend de l'opérateur\\\\
\hbox{{\hspace[lilyindent]}
\starttable[|c|c|]  
\NC \type{extract-code} \VL liste associée \NC\SR
\HL
\NC \type{'a} \VL contient \type{'a} \NC\FR
\NC \type{'(and a b)} \VL contient \type{'a} {\bold \underbar et} \type{'b} \NC\MR
\NC \type{'(or a b)} \VL contient \type{'a} {\bold \underbar ou} \type{'b} \NC\MR
\NC \type{'(xor a b)} \VL contient \type{'a} mais {\bold \underbar pas} \type{'b} \NC\LR
\stoptable 
}\\

\page %%%%%%%%%%%%%%%%%%%
\underbar{\sc{Exemple}} :
\startmylily
cors = #'(corI corII corIII)
assocDynList = #(assoc-pos-dyn            
    "1 p" 'corI / "5 mf <" '(corI corII) / "6 ff > / 7 !" cors)   
%% &\em{&Extraction simple&}&
#(extract-pos-dyn-str 'corIII assocDynList) 
   => "6 ff > / 7 !"
%% &\em{&Extraction avec opérateur&}&
#(instru-pos-dyn-str '(or corI corII) assocDynList)
   => "1 p / 5 mf < / 6 ff > / 7 !" 
#(instru-pos-dyn-str '(xor corI corII) assocDynList)
   => "1 p"
#(instru-pos-dyn-str '(and corI corII) assocDynList)
   => "5 mf < / 6 ff > / 7 !"
\stopmylily
\blank[0.5em]
- On peut mettre plus de 2 éléments à un opérateur. Le 3\high{\itxx ème} élément est combiné avec le résultat de l'opération des 2 premiers.
\startmylily
'(and a b c) = '(and (and a b) c)
\stopmylily
\godown[1em]
- Une liste d'{\em instrument}s peut être composée de sous-listes. Si une sous-liste ne commence pas par un opérateur, ses éléments sont copiés dans la liste de niveau supérieur.
\godown[1.2em]
\midaligned{ \tfd ------------}
\godown[1.2em]
%%%%%%%%
\func{instru-pos-dyn->music}
\syntax {(instru-pos-dyn->music extract-code assoc-pos-dyn-list)}{}
Même chose que \type{extract-pos-dyn-str}, ci-dessus, mais la chaîne de retour est convertie à l'aide de  \type{add-dynamics} en une {\em musique} de la forme :
\startmylily
{ <>\p s1*4 <>\mf s1*29 <>\ff }
\stopmylily
\blank[1.2em]
\midaligned{ \tfd ------------}
\godown[1.2em]

%%%%%%%%
\func{add-dyn}
\syntax {(add-dyn extract-code)}{}
\index{assocDynList}
\type{(add-dyn extract-code)} est une macro (raccourci) de la fonction \type{instru-pos-dyn->music} ci-dessus, qui évite de spécifier le dernier paramètre \type{assoc-pos-dyn-list}. Elle est définie de la manière suivante :
\startmylily
#(define-macro (add-dyn extract-code)
   `(instru-pos-dyn->music ,extract-code assocDynList))
\stopmylily
Cette macro ne marchera donc qu'à condition d'avoir defini la variable \type{assocDynList}~:
\startmylily assocDynList = #(assoc-pos-dyn …) \stopmylily
\godown[1em]
\hairline
\type{assocDynList} bénéficie d'un \goto{complément d'information}[addendum3] \at{dans l'addendum 3 page}[addendum3].
\hairline
\page %%%%%%%%%%%%%%%%%%%

\subject{Gérer les indications de tempo, d'armature et les repères}  %%%%%%%%%%%%%%%%%%%%%
Les fonctions qui suivent sont utilisées dans l'\in{addendum I concernant \type{\global} \at{page}[addendum1].}[addendum1]
\godown[2.5em]
%%%%%%%%
\func{metronome}
\syntax {(metronome mvt note x [txt [open-par [close-par ]]])}{}
Renvoie un {\em markup} équivalent à celui produit par la fonction \type{\tempo}.\\
- \type{mvt} est un {\em markup} indicatif du mouvement du morceau. Par exemple : "Allegro" \\
- \type{note} est une {\em chaîne de caractères} représentant une valeur de note : "4." par ex pour une noire pointée, "8" pour une croche.\\
- \type{x} représente soit un tempo métronomique si \type{x} est {\em entier}, soit comme pour l'argument précédent, une {\em chaîne} représentant une valeur de note. Voir l'exemple de la fonction \type{tempos} ci-dessous.\\
- Optionnellement, l'argument \type{txt} permet de rajouter, après l'indication métronomique, un texte tel que \quotation{env} ou \quotation{ca.}.\\
- Grâce aux arguments \type{open-par} et \type{close-par}, on peut changer (ou supprimer, en mettant~\type{""}) les parenthèses ouvrantes et fermantes entourant l'indication métronomique.
\blank[1.3em]
\midaligned{ \tfd ------------}
\godown[1.3em]

%%%%%%%%
\func{tempos}
\syntax {(tempos [obj] posA mvtA [spaceA] / posB mvtB [spaceB] / …)}{}
Insère dans \type{obj} et à la position \type+pos+, l'indication métronomique %
\type+\tempo mvt+.\\
\type+mvt+ est un {\em markup} pouvant par exemple être créé par la fonction \type+metronome+ précédente.\\
Si \type{obj} n'est pas spécifié, l'indication est insérée dans \type+\global+\\
Si un nombre \type{space} est spécifié, l'indication est déplacé horizontalement de $+$ ou $-$ \type{space} unités vers la droite ou la gauche.\\
Les barres obliques / sont optionnelles.
\blank[1em]
\underbar{\sc\Words Exemple} :
\startmylily
(tempos 1 "Allegro" /
       50 (metronome "Andante" "4" 69) /
      100 (metronome "Allegro" "4" "8") -2 ; &\tfx\em{&déplacé de 2 unités vers la gauche&}&
      150 (markup #:column ("RONDO" (metronome "Allegro" "4." "4")))
\stopmylily
\blank[1.3em]
\midaligned{ \tfd ------------}
\godown[1.3em]

%%%%%%%%
\func{signatures}
\syntax {(signatures posA sig-strA [/] posB sig-strB ...)}{}
Insère dans \type{\global} des signatures rythmiques, aux mesures indiquées par les arguments {\em pos}.\\
Un argument {\em sig-str} est constitué des arguments d'une commande \type{\time} (basiquement une fraction), placés entre 2 guillemets "\dots".\\

\startmylily
(signatures 1 "3/4"
           10 "3,2 5/8"
           20 "4/4") 
& $\Longrightarrow$ &
(rm-with 'global 1 #{ \time 3/4 #}
                10 #{ \time 3,2 5/8 #}
                20 #{ \time 4/4 #})
\stopmylily
Chaque groupes d'arguments peuvent être séparées par une barre oblique /.
\blank[1.3em]
\midaligned{ \tfd ------------}
\page %%%%%%%%%%%%%%%%%%%

\func{keys}
\syntax {(keys [obj] posA key-mode-strA [/] posB key-mode-strB [/] ...)}{}
Insère dans \type{obj} des armatures aux positions \type{pos}.\\
Si \type{obj} n'est pas spécifié, l'armature est insérée dans \type+\global+\\
Un argument \type{key-mode-str}, de type {\em string} "\dots", est constitué des 2 mêmes arguments que pour la fonction \type{\key} : 1\high{er} argument la tonalité, 2\high{ème} le mode.\\
Le mode peut-être omis. Le mode par défaut est \type{\major}.\\
La barre oblique inversée \type+\+ ~devant le mode est obtenue soit en la doublant (~\type{\\major} à la place de \type{\major} ), \dots soit en l'omettant (~\type{major} à la place de \type{\major} ).\\

\startmylily
(keys 1 "f minor"
     20 "c major"
     40 "f") 
& $\Longrightarrow$ &
(rm-with 'global 1 #{ \key f \minor #}
                20 #{ \key c \major #}
                40 #{ \key f \major #})
\stopmylily
Chaque groupes d'arguments peuvent être séparées par une barre oblique /.
\blank[1.3em]
\midaligned{ \tfd ------------}
\godown[1.3em]

\func{marks}
\syntax {(marks [obj] posA [/] posB [/] ...)}{}
Insère un \type{\mark \default} aux positions \type{pos}, dans \type{'global} ou dans \type{obj} si spécifié.
\blank[1.3em]
\midaligned{ \tfd ------------}
\godown[0.3em]

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                              
\subject{Gérer les "modes" Lilypond}
\index{lilypond-mode}
Ce chapitre n'apporte pas de nouvelles fonctions en tant que telles mais montre comment simplifier l'entrée d'événements musicaux dans les différents modes de Lilypond tels \type{\drummode}, \type{\chordmode} etc…\\
Dans Lilypond, le mode par défaut n'est pas modifiable et a été fixé à \type{\notemode} :
\startmylily { c d e } &\rm est un raccourci de& \notemode { c d e } \stopmylily
{\em arranger.ly} définit en interne une variable globale nommée \type{lilypond-mode}, à qui on peut affecter à tout moment, le \type{symbol} du mode souhaité par défaut : \type{'drummode} pour \type{\drummode}, \type{'chordmode} pour \type{\chordmode}, etc…\\ 
On pourra effectuer cette affection, avec par exemple la fonction scheme \type{set!} : 
\startmylily (set! lilypond-mode 'figuremode) \stopmylily

Parallèlement, les fonctions de base d'{\em arranger.ly} dispose d'une syntaxe "cachée"\footnote{non documentée}, qui permet de remplacer un argument de type \type{music} par un argument de type \type {string}, rendant ainsi la valeur de retour de ces fonctions, dépendantes de la valeur de \type{lilypond-mode}.\\
Si \type{lilypond-mode} est laissé en \type{'notemode} (c'est le mode par défaut dans {\em arranger.ly}) :\\
\startmylily (rm obj 1 "c d e") &\rm est simplement équivalent à& (rm obj 1 #{ c d e #}) \stopmylily
Mais si \type{lilypond-mode} passe par exemple en \type{'lyricmode}, cette même instruction sera maintenant équivalente à :
\startmylily (rm obj 1 #{ \lyricmode { c d e } #}) \stopmylily
L'objet \type{obj} devra donc être inclus dans un contexte {\em Lyrics} et non plus {\em Voice}
\blank[1em]
Voici une même partie de batterie écrite sans puis avec, l'utilisation de \type{lilypond-mode} :\\
\page %%%%%%%%%%%%%%%
\startlily
%% Methode traditionnelle
#(begin
(fill 'mydrums #{ \drummode { hihat8 } #} 1 3)
(add-voice2 'mydrums 1 #{ \drummode { bassdrum8 r r4 } #})
(add-voice2 'mydrums 2 #{ \drummode { r8 bassdrum r4 } #})
)
\stoplily
\startfiguretext[right, top][exemple]{} 
{ \externalfigure[lilypond-mode.pdf][wfactor=200] } %%, align=flushright] }

\startlily
%% Methode avec lilypond-mode 
#(set! lilypond-mode 'drummode)
#(begin
(fill 'mydrums "hihat8" 1 3)
(add-voice2 'mydrums 1 "bassdrum8 r r4")
(add-voice2 'mydrums 2 "r8 bassdrum r4")
)
\stoplily
\stopfiguretext
\godown[-1em]
Il est ici bien clair que la valeur de \type{lilypond-mode} n'affecte que les arguments où un type \type{music} est attendu et qu'un type \type{string} est fourni.
\startlily
#(set! lilypond-mode 'chordmode)
#(begin
(rm objA 1 "c d e")                    &\em{&; \chordmode&}&
(rm objB 1 #{ c d e #})                &\em{&; \notemode&}&
(set! lilypond-mode 'lyricmode)
(rm objC 1 "c d e")                    &\em{&; \lyricmode&}&
(rm objD 1 #{ \chordmode { c d e } #}) &\em{&; \chordmode&}&
)
\stoplily
\blank[-1.5em]
%%%%%%%%

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                              
\subject{Manipuler les listes}
Outre les fonctions de base \type{cons} et \type{append} de {\em\sc GUILE}, les quelques  fonctions suivantes pourront s'avérer utiles.
\blank[-1.5em]
%%%%%%%%
\func{lst} (\type{lst} et également \type{flat-lst}) 
\syntax {(lst obj1 [obj2…])}{}
\index{flat-lst}

\type{obj1}, \type{obj2…} sont des {\em instrument}s ou des listes d'{\em instrument}s.\\
Renvoie une liste, formée basiquement uniquement de tous ces {\em instrument}s.
\godown[0.7em]
\underbar{\sc\Words Exemple} :
\startmylily
tpettes = #'(tpI tpII)
cors = #'(corI corII) 
tbnes = #'(tbnI tbnII)
cuivres = #(lst tpettes cors tbnes 'tuba)
\stopmylily
La dernière instruction est équivalente à :
\startmylily
cuivres = #'(tpI tpII corI corII tbnI tbnII tuba)
\stopmylily

\type{lst} garde cependant intacte les sous-listes de listes.\\
Avec :
\startmylily
tpettes = #'(tpI (tpII tpIII))
\stopmylily
le résultat serait
\startmylily
cuivres = #'(tpI (tpII tpIII) corI corII tbnI tbnII tuba)
\stopmylily
Si ce n'est pas le résultat escompté, on peut utiliser la fonction \type{flat-lst} (même syntaxe), qui, elle, renvoie une liste composée uniquement d'{\em instrument}s, quelque soit la profondeur des listes données en paramètres.
\godown[1.3em]
\midaligned{ \tfd ------------}
\godown[1.3em]

%%%%%%%%%
\func{lst-diff}
\syntax {(lst-diff mainlist . tosubstract)}{}
Enlève de \type{mainlist} les {\em instrument}s spécifiés dans \type{tosubstract}.\\
\type{tosubstract} est une suite d'{\em instrument}s ou de listes d'{\em instrument}s
\godown[1.3em]
\midaligned{ \tfd ------------}
\godown[1.3em]

%%%%%%%%%
\func{zip}
\syntax {(zip x1 [x2…])}{}
\type{x1}, \type{x2…} sont des listes standard (non circulaires, prédicat \type{proper-list?}).\\
La fonction re-définit la fonction \type{zip} de {\em\sc guile}, en permettant l'ajout de tous les éléments des plus grosses listes. La fonction \type{zip} originale de {\em\sc guile} a été renommée \type{guile-zip}.
\startmylily
(guile-zip '(A1 A2) '(B1 B2 B3)) & $\Rightarrow$ & '((A1 B1) (A2 B2))
      (zip '(A1 A2) '(B1 B2 B3)) & $\Rightarrow$ & '((A1 B1) (A2 B2) (B3))
\stopmylily
Si on a définit les listes et musique suivantes : 
\startmylily
tpettes = #'(tpI tpII tpIII)
clars = #'(clI clII clIII) 
saxAltos = #'(altI altII)
music = \relative c' { <c e g> <d f b> }
\stopmylily
Le code suivant :
\startmylily
(dispatch-chords (zip tpettes clars saxAltos) 6 music)
\stopmylily
donnera à la mesure 6 :
\startmylily
'(tpI clI altI)    & $\leftarrow$ & { g' b' }
'(tpII clII altII) & $\leftarrow$ & { e' f' }
'(tpIII clIII)     & $\leftarrow$ & { c' d' }
\stopmylily
\blank[1.3em]
\midaligned{ \tfd ------------}
\godown[-0.3em]
                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                                                                 
\subject{Fonctions diverses}
\blank[-1.5em]   
                                   
%%%%%%%%
\func{sym-append}
\syntax {((sym-append sym [to-begin?]) instru[s]}{}
Crée un symbole en ajoutant à la fin d'un nom d'instrument, le suffix \type{sym}.\\
Si \type{to-begin?} est à \type{#t}, le symbol \type{sym} devient un préfixe (collé au début).\\
Cette fonction s'applique à un {\em instrument} ou à une liste d'{\em instrument}s.\\
En l'associant à la fonction \in{\type{def!} \at{de la page}{}[def!],}[def!] on peut créer automatiquement des musiques contenant des {\em skip}s (de la forme \type+{s1*…}+), de la même longueur que le \type+\global+.\\
Elle peut s'utiliser par exemple, pour mettre les nuances d'un instrument dans une voix séparée. Le code ci-après, crée des voix dédiées en ajoutant {\em Dyn} à la fin de chaque instrument :
\startmylily
all = #'(oboeI oboeII clarinet violinI violinII viola cello)      
#(let ((dyn-append (sym-append 'Dyn)))    ; &\tfx\em{& 'instru => 'instruDyn&}&
   (def! (dyn-append all))  ; &\tfx\em{&déclaration et initialisation de oboeIDyn, oboeIIDyn …&}&
   (add-dynamics 'clarinetDyn "1 p / 4 f …")  ;; &\tfx\em{& ajout des nuances&}&
   (add-dynamics '(oboeIDyn oboeIIDyn) "2 p < / 4 f …")
  …)
\stopmylily
\blank[0.5em]
Dans les parties séparées ou le conducteur, on mettra~:
\blank[0.5em]
\startmylily
\new Staff << \global \oboeI \oboeIDyn >>
\new Staff << \global \oboeII \oboeIIDyn >>
\new Staff << \global \clarinet \clarinetDyn >> …
\stopmylily
\blank[0.5em]
Pour alléger l'écriture des \type{\new Staff}, on peut pousser l'automatisation encore plus loin. Ceci est montrée en exemple par la fonction \goto{\type{instru->music}}[instru->music] de \at{l'addendum 2, page}[instru->music].
% \type{part->music} de \goto{l'addendum II}[addendum2] \at{page}[addendum2]. 
\blank[1.3em]
\midaligned{ \tfd ------------}
\godown[1.3em]

%%%%%%%%
\func{set-del-events}
\syntax {(set-del-events event-sym . args)}{}
Supprime tous les événements de nom\footnote {Un nom d'événement commence par une majuscule, et se termine généralement par \quotation{Event}. Exemple : {\em 'SlurEvent}} \type{event-sym} \\
Plusieurs événements peuvent être spécifiés, à la suite ou sous forme d'une liste.\\
Ainsi, la liste nommée \type{dyn-list}, définie dans {\em "chordsAndVoices.ly"} de la manière suivante :
\blank[0.5em]
\startmylily
#(define dyn-list '(AbsoluteDynamicEvent CrescendoEvent DecrescendoEvent))
\stopmylily
\blank[0.5em]
permet, utilisée avec la fonction \type{set-del-events}, d'effacer toutes les nuances d'une portion de musique et éventuellement de les remplacer par d'autre :
\blank[0.5em]
\startmylily
#(let((del-dyn (set-del-events dyn-list))
   (apply-to 'trompette del-dyn 8 12)
   (add-dynamics 'trompette "8 p / 10 mp < / 11 mf"))
\stopmylily
\godown[1.3em]
\midaligned{ \tfd ------------}
\godown[1.3em]

%%%%%%%%
\func{n-copy}
\syntax {(n-copy n music)}{}
\index{set-ncopy}
ou : (2\high{ème} forme  équivalente, à utiliser avec \goto{\type{apply-to}}[apply-to])
\syntax {((set-ncopy n) music)}{}
Copie \type{n} fois \type{music}.
\godown[1.3em]
\midaligned{ \tfd ------------}
\godown[1.3em]

%%%%%%%%
\index{index->string-letters}
\func{def-letters}
\syntax {(def-letters measures [index->string][start-index][show-infos?])}{}
La fonction associe des lettres aux mesures contenues dans la liste : \type{measures}.\\
Elle convient particulièrement si \type{Score.rehearsalMarkFormatter} est de la forme :\\
\startnarrower[\lilyspace] \type{#format-mark-[…]-letters}. \stopnarrower\\
Les 3 paramètres suivant \type{measures} sont optionnels et se distinguent uniquement par leur type.\\
\type{index->string} est une fonction de rappel renvoyant une {\em chaîne de caractères}, et prenant en paramètre un {\em index} (un entier positif). L'index est incrémenté de 1 à chaque appel, en commençant par la valeur du paramètre \type{start-index} (\type{0} si \type{start-index} non spécifié).\\
Par défaut, \type{index->string} est la fonction interne \type{index->string-letters} qui renvoie la ou les lettre(s) capitale(s) correspondante(s) à leur index dans l'alphabet, mais en sautant la lettre~\quotation{\type{I}}~: "\type{A}"…"\type{H}" puis "\type{J}"…"\type{Z}" puis "\type{AA}"…"\type{AH}" 
puis "\type{AJ}"…"\type{AZ}" etc…\\
\page %%%%%%%%%%%%%%%%%%%
L'instruction : \type {#(def-letters '(9 25 56 75 88 106))} donne les correspondances suivantes :\\
\midaligned{\hbox{\hspace[lilyindent]
\starttable[s0|cs1|c|ls2|]
 \NC \type{A} \NC $\Longrightarrow$ \NC mesure \type{9} \NC\FR
 \NC \type{B} \NC $\Longrightarrow$ \NC mesure \type{25} \NC\MR
 \NC \type{F} \NC $\Longrightarrow$ \NC mesure \type{106} \NC\MR
 \NC \type{G} \NC $\Longrightarrow$ \NC <erreur> \NC\LR
\stoptable
\hspace[threelilyindent]
\starttable[|cs1|c|ls2|]
 \NC \type{(+ A 2)} \NC $\Longrightarrow$ \NC mesure \type{11} \NC\FR
 \NC \type{'(A 4 8)} \NC $\Longrightarrow$ \NC <erreur> \NC\MR
 \NC \type{`(,A 4 8)} \NC $\Longrightarrow$ \NC position \type{'(9 4 8)} \NC\MR
 \NC \type{(list (+ A 2) 4 8)} \NC $\Longrightarrow$ \NC position \type{'(11 4 8)} \NC\LR
\stoptable
\hspace[lilyindent]
}} % end of \hbox
Si une lettre était déjà définie avant l'appel de \type{def-letters}, la fonction fait précéder la lettre par le caractère \quotation{\type{_}}. Ceci est surtout nécessaire pour les lettres \type{X} et \type{Y}, qui ont \type{0} et \type{1} comme valeur associée dans {\em Lilypond}. Ces  2 lettres deviendront donc {\em toujours} \type{_X} et \type{_Y}.\\
Un message prévient l'utilisateur du changement, sauf si on inclut \type{#f} dans les options (paramètre \type{show-infos?}) :
\startmylily #(def-letters '(9 25 …) #f) \stopmylily
\godown[1.3em]
\midaligned{ \tfd ------------}
\godown[-0.3em]

%% set-frag is not ready enough (bugs remains). Perhaps in a future version of arranger.ly
                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                                                 
%\subject{"Baliser" une musique}
%\godown[0.3em]
%\underbar{Rappel}
%\blank[0.56em]
%Le fichier {\em addAt.ly} permet de travailler avec des balises qui permettent de répérer un fragment  particulier d'une musique. Deux fonctions y sont définies : \type{\anchor} (balise) et \type{\musicAt}.
%\startlily
%music = \relative c' {
%  \anchor #'A  c4 c c c
%  \anchor #'B  d d d d
%  \anchor #'C  e e e e
%  }
%\musicAt #'A  %%&\em{& => { c c c c } &}&
%\musicAt #'B  %%&\em{& => { d d d d } &}&
%\musicAt #'C  %%&\em{& => { e e e e } &}&
%\stoplily
%Noter que chaque \type{\anchor} re-initialise le mode \type{\relative} à \type{c'} avec la fonction \type{ \resetRelativeOctave}~: tous les \type{\anchor}s sont donc relatif au do central.\\
%{\em arranger.ly} étend la capacité de balisage\\
%%%%%%%%%
%\func{set-frag}
%\syntax {((set-frag music) sym)}{}

                      %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                                                 
\subject{Compiler une portion de score}
\godown[1.3em]
%%%%%%%%
\func{show-score}
\syntax {(show-score from-pos to-pos)}{}

Insert dans \type+\global+, des \type+\set Score.skipTypesetting = ##t+ ou \type+##f+,  de manière à ne compiler (et ne montrer) que la musique de la partition se trouvant entre les positions \type+from-pos+ et \type+to-pos+ (utile pour les gros \quotation{scores}).
\godown[1.3em]
\midaligned{ \tfd ------------}
\godown[-0.3em]                  

                     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                              
\subject{Exporter ses instruments}
\godown[1.3em]                                        
%%%%%%%%
\func{export-instruments}
\syntax {(export-instruments instruments filename}{overwrite?)}

\type{instruments} est la liste d'{\em instrument}s à exporter.\\
\type{filename} est le nom du fichier du répertoire courant, dans lequel sera effectué l'export.\\
On obtient un fichier~{\em ly} classique avec des déclarations de la forme 
\startmylily
instrumentName = { music … }
\stopmylily
(Les notes seront écrites en mode absolu).\\
Si \type{filename} existe déjà, les définitions des instruments seront ajoutées à la fin du fichier, sauf si \type{overwrite?} est mis à  \type+#t+ : l'ancienne version est alors effacée !
\blank[0.6em]
\hairline
Cette fonction est encore au stade expérimental ! Agir avec prudence.
\hairline
\godown[1em]
Dans l'état actuelle de la fonction, un passage à la ligne se produit après chaque mesure.\\
Cependant certains évenements comme les silences multi-mesures ne sont pas coupés en plusieurs mesures. \type {R1*5} restent \type {R1*5} et non \type+{R1 R1 R1 R1 R1}+.\\
Pour une musique simultanée \type {<<}\dots\type{>>}, le passage à la ligne est effectué pour chaque élement et avec un retrait.\\
Les musiques séquentielles sont elles, mixées autant que possible les unes dans le autres pour minimiser le code obtenu.
\page %%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\starttitle[
  reference=addendum1,
  title={-ADDENDUM I-\\CONSTRUIRE \type+\global+ AVEC «arranger.ly»},
  list={ADDENDUM I : CONSTRUIRE \type+\global+}
  ]

%[addendum1]{ADDENDUM\\CONSTRUIRE \type+\global+ AVEC «arranger.ly»}

\type+\global+ est généralement assez fastidieux à entrer car on doit calculer «à la main» la durée séparant 2 événements (entre 2 \type+\mark\default+ par exemple) . \\        
Voici comment «{\em arranger.ly }» peut faciliter la vie du codeur, sur un morceau de 70 mesures, contenant changements de mesures, changements d'armures, de tempos etc…
\startlily
global = { s1*1000 }                   %%&\em\tfx{& On prévoit une grande longueur&}&
#(init '())                            %%&\em\tfx{& Liste d'instruments d'abord vide =>&}&
     %%&\em\tfx{& les positions tiennent compte des insertions précédentes de timing.  &}&
     %%&\em\tfx{& ( \global est ré-analysé à chaque fois. ) &}&
#(begin                                ;;&\em\tfx{& Construction de \global&}&
(signatures 1 "3/4" 10 "5/8" 20 "4/4") ;;&\em\tfx{& D'abord les signatures&}&
(cut-end 'global 70))                  ;;&\em\tfx{& On coupe ce qui est en trop&}&                         
(keys 1 "d minor" 20 "bes major" 30 "d major") ;;&\em\tfx{& Les armures&}&
(tempos                                ;;&\em\tfx{& Les indications de tempos&}&
   1 (metronome "Allegro" "4" 120) /
  10 (metronome "" "8" "8") 2 /        ;;&\em\tfx{& décalage de 2 unités vers la droite&}&                         
  20 (metronome "Allargando" "4" "4.") 2.5 /
  30 "Piu mosso" -4 /
  60 (markup #:column ("FINAL" (metronome "Allegro vivo" "4" 200))))
(marks 10 20 30 40 50 60)          ;;&\em\tfx{& Les lettres&}& 
(x-rm 'global (bar "||") 20 30 60) ;;&\em\tfx{& Les barres (\bar )&}&
(rm-with 'global 1 markLengthOn    ;;&\em\tfx{& Choses diverses&}&
                ...          
                70 (bar "|."))     ;;&\em\tfx{& La touche finale&}&
)                                  %%&\em\tfx{& Fin \global&}&

%%&\em\tfx{& On peut maintenant initialiser la liste d'instruments&}&
#(init '(test)) %%&\em\tfx{&  Liste non vide = métrique fixée : tout nouveau timing sera ignoré&}&

\layout {
  \context { \Score
    skipBars = ##t
    \override MultiMeasureRest.expand-limit = #1
    rehearsalMarkFormatter = #format-mark-box-letters
  }
}
\new Staff { << \global \test >> }

\stoplily

%\startfiguretext[middle][exemple7]{}
{\externalfigure[addendum-1.pdf][wfactor=fit]}
%\stopfiguretext
\midaligned{\underbar{\sc\Words exemple 10}}
\stoptitle

\starttitle[
  reference=addendum2,
  title={-ADDENDUM II-\\S'ORGANISER},
  list={ADDENDUM II : S'ORGANISER~~~~~~~~~}
  ]

Voici quelques idées d'organisation pour la création d'un arrangement pour une grosse formation. Quelques fonctions sont ici proposées, mais notez bien qu'elles ne font {\em pas} parties de {\em arranger.ly}. Leurs définitions ont été copiées dans le fichier \type{addendum-functions.ly} du répertoire \type{arrangerDoc-sources} du projet \type{arranger.ly}.
\blank[1em]
{\tfa\bf→} {\bf Structure des fichiers.}

\hbox{{\hspace[lilyindent]}
\starttable[s0|ls2|c|c|]
 \NC fichiers \NC utilité \NC \type{\include}\SR
 \HL
 \NC init.ily \NC \type{global = {…}} et (\type{init all})\NC"arranger.ly"\NC\FR
 \NC NOTES.ily \NC remplissage des instruments\NC "init.ily" et en fin de fichier "dynamics.ily" \NC\MR
 \NC dynamics.ily \NC \type{assocDynList = …} \NC - \NC\MR
 \NC SCORE.ly \NC le conducteur \NC "NOTES.ily" \NC\MR
 \NC parts/instru.ly \NC parties séparées \NC "../NOTES.ily" \NC\LR
\stoptable
} % end of \hbox
\blank[0.86em]
{\tfa\bf→} {\bf Instrument dans partie séparée vs instrument dans conducteur.}\\
On peut vouloir que certains réglages d'un instrument varient quand il est édité en partie séparée, ou bien  dans un conducteur. Voici comment avoir un code source conditionnel.\\

Placer, en tête de chacune des parties séparés, l'instruction :
\startmylily #(define part 'instru) ;;&\em\tfx{& le nom de l'instrument (un symbol)&}&\stopmylily
et en tête du conducteur, l'instruction :
\startmylily #(define part 'score) \stopmylily
On ajoutera, dans le fichier {\em init.ily} par exemple, la fonction \type{part?} suivante :
\startmylily 
#(define (part? arg) (and (defined? 'part)
                          (if (list? arg)(memq part arg)
                                         (eq? part arg))))
\stopmylily
On pourra alors utiliser dans le code, l'instruction \type{(if (part? 'instru) val1 val2)}, ou bien \type{(if (part? '(instruI instruII)) val1 val2)}.\\
Dans l'exemple suivant, le texte sera aligné à gauche dans le conducteur et à droite dans la partie d'euphonium :\type{ (rm 'euph 5 (txt "en dehors" UP (if (part? 'score) LEFT RIGHT))) }
%%%%%%%%%%
\blank[1em]
\index{obj->music}
\index{instru->music}
\reference[instru->music]{}
{\tfa\bf→} {\bf Parties séparées - une fonction \type{instru->music}}\\
Préalable : avoir défini \type{assocDynList} (dans le fichier {\em dynamics.ily})\\
\type{instru->music} utilise une fonction d'{\em arranger.ly} : \type{obj->music}, qui renvoie la musique associée à un instrument \footnote{\type{(obj->music 'clar)} renvoie \type{clar}}, et la fonction \type{make-clef-set}, définie dans le répertoire {\em Lilypond}, fichier \type{scm/parser-clef.scm} et qui est l'équivalent scheme de \type{\clef}.
\startmylily
#(define* (instru->music instru #:optional (clef "treble"))
(sim                   ; << ... >> (simultaneous)
  (make-clef-set clef) ; = \clef
  global
  (obj->music instru)  ; music of instru
  (add-dyn instru)))   % dynamics of instru
\stopmylily
Les parties séparées en clef de sol, pourront être éditées simplement avec :
\startmylily \new Staff { $(instru->music 'vlI) } \stopmylily
Les autres parties devront spécifier la clef :
\startmylily
\new Staff { $(instru->music 'viola "alto") } ;; &\tfx\em{&clef d'ut 3&}&
\new Staff { $(instru->music 'vlc "bass") }   ;; &\tfx\em{&clef de fa&}&
\stopmylily
Notez que si vous avez mis en tête de fichier \type{#(define part 'instru)}, comme expliqué dans le paragraphe précédent, on peut remplacer le nom de l'instrument par le mot \type{part} :
\startmylily \new Staff { $(instru->music part [clef]) } \stopmylily
\page %%%%%%%%%%%%%%%%%%%%%%%%%

\index{split-instru}
\index{part-combine-instru}
{\tfa\bf→} {\bf Conducteur : gérer 2 instruments sur une même portée}\\
La fonction ci-dessous permet d'éviter les nuances en double. Elle met en un exemplaire les nuances communes en bas de la portée; seules les nuances n'appartenant qu'à la voix du haut se trouveront au dessus de la portée.
\startmylily
#(define* (split-instru instru1 instru2 #:optional (clef "treble"))
   (split                    ; &\tfx\em{& << … \\ … >>&}&
      (sim                   ; &\tfx\em{& << … >> &}&
         (make-clef-set clef)
         global
         dynamicUp           ; &\tfx\em{& nuances au dessus de la portée &}&
         (add-dyn (list 'xor instru1 instru2))
         (obj->music instru1))
      (sim 
         (add-dyn instru2)
         (obj->music instru2))))
\new Staff { $(split-instru 'clarI 'clarII) }
\stopmylily
\blank[0.8em]
Pour un conducteur avec 3 cors par exemple , on peut utiliser \type{instru->music} et \type{split-instru}~:
\startmylily
\new StaffGroup <<
  \new Staff \with { instumentName = #"cor 1" } 
                 $(instru->music 'corI)
  \new Staff \with { instumentName = 
                            \markup \vcenter {"cor " \column { 2 3 }}}
                 $(split-instru 'corII 'corIII) >>
\stopmylily
\blank
À la place de \type{split-instru}, on pourra préférer une fonction \type{part-combine-instru}.
\startmylily
#(define* (part-combine-instru instru1 instru2 #:optional (clef "treble"))
   (sim
     (make-clef-set clef)
     global
     (part-combine                ; &\tfx\em{&\partCombine&}&
       (sim                       ; &\tfx\em{&voix du haut&}&
         ; partCombineApart       ; &\tfx\em{&mode pour le travail&}&
         partCombineAutomatic     ; &\tfx\em{&mode par défaut&}&
         dynamicUp                ; &\tfx\em{&nuance en haut&}&
         (add-dyn (list 'xor instru1 instru2))
         (obj->music instru1))
       (obj->music instru2))      ; &\tfx\em{&voix du bas&}&
     (add-dyn instru2)))
\stopmylily
Une portée construite avec cette fonction sera facilement paramétable.
Supposons par exemple que cette portée est partagée par les clarinettes 2 et 3, on peut ajouter, dans {\em SCORE.ly} (et non dans {\em NOTES.ily}), le code suivant:
\startmylily
#(begin ;; &\tfx\em{&réglages de partCombine pour la portée cl2-cl3 &}&
   (x-rm 'cl2 partCombineApart 60 '(82 3/8) 129)
   (x-rm 'cl2 partCombineChords 85)
   (x-rm 'cl2 partCombineAutomatic 61 86 138)
   …)
\stopmylily
\hairline
Attention : \type{partCombineApart, partCombineChords, partCombineAutomatic…} sont les nouveaux noms utilisés par les dernières versions de Lilypond.\\
Pour la version Lilypond 2.20, il faudra utiliser à la place les noms :\\
\type{partcombineApart, partcombineChords, partcombineAutomatic…}
\hairline
\page %%%%%%%%%%%%%%%%%%%
%%%%%%%
\starttitle[
  reference=addendum3,
  title={-ADDENDUM III-\\UTILISATION de {\sca assocDynList}},
  list={ADDENDUM III : UTILISATION de {\sca assocDynList}}
  ]
%\reference[complément-assocDynList]{}
%{\tfa\bf→} {\bf Complément pour l'utilisation de \type{assocDynList}}
\blank[0.6em]
{\bf-} Utilisation avec des nuances personalisées :
\blank[0.5em]
\startmylily
pocodim = #(make-dynamic-script (markup #:normal-text #:italic "poco dim"))
piuf = #(make-dynamic-script (markup #:normal-text #:italic "più"
                                     #:dynamic "f"))
assocDynList = #(assoc-pos-dyn
  "1 f / 5 pocodim / 8 mf / (10 4) piuf / 12 fff" all)  % &\tfx\em{&(tous les instuments) &}& 
\stopmylily
\blank

{\bf-} Enlever une nuance et la remplacer par une autre :\\
Pour mettre, dans ce même exemple, \type{ff} mesure 12 à la trompette, à la place de \type{fff}, il faut d'abord annuler la précédente avec une nuance "vide", sinon Lilypond nous signale une erreur~:~2~nuances au même endroit.
\blank[0.5em]
\startmylily
assocDynList = #(assoc-pos-dyn
  "1 f / 5 pocodim / 8 mf / 10 piuf / 12 fff" all      ;&\tfx\em{& tous (dont trompette)&}& 
  "12 / 12 ff" 'tp )			              %&\tfx\em{& trompette mes 12 : fff -> ff&}&  
\stopmylily
\blank

{\bf-} Pour alléger le nombre de nuances d'un conducteur (par exemple quand un grand {\em crescendo} orchestral induit un "\type{cresc - - -}" à chaque instruments), on peut utiliser la fonction \type{part?} décrite dans l'addendum II ci-dessus, afin que la suppression ne soit effective que dans le conducteur et non dans les parties séparées.
\blank[0.5em]
\startmylily
#(if (part? 'score) ;&\tfx\em{& on allège le conducteur mesure 15 et 18&}&
   (set! assocDynList (append assocDynList (assoc-pos-dyn
     "15 / 18" '(&\tfx\em{& [liste des instruments dont on décide de supprimer les nuances]&}& )))))
\stopmylily
\blank

{\bf-} On peut définir les positions par des variables (voir fonction \goto{\type{def-letters}}[def-letters]\at{ page}[def-letters]) et les utiliser dans \type{assocDynList} sans se soucier des caractères {\tfb '} {\tfb `} ou {\tfb ,} à mettre habituellement devant les listes et les symboles.
\blank[0.5em]
\startmylily 
A = #9           %&\tfx\em{& un numéro de mesure&}& 
B = #'(2 8 16)   %&\tfx\em{& des temps à l'intérieur d'une mesure&}& 
assocDynList = #(assoc-pos-dyn
       "A p / (A 2 8) mp / (+ A 3) mf / ((+ A 3) 2 8) f" 'instruI
  ; => "9 p / (9 2 8) mp / 12 mf      / (12 2 8) f"
       "(cons 18 B) < / (cons 21 B) !" 'instruII
  ; => "(18 2 8 16) < / (21 2 8 16) !"
\stopmylily

\blank[1.2em]
\index{set-dyn}
\reference[set-dyn]

{\bf-} On peut automatiser l'ajout de nuances par la création d'une fonction \type{set-dyn}\footnote{Attention, malgré son nom, cette fonction n'est {\em pas} compatible \type{apply-to}} :
\startlily 
#(define ((set-dyn fmt0 . fmt-args) arg0 . args)
   (apply format (lst                ;&\tfx\em{& liste des arguments pour format&}&
     #f fmt0 fmt-args arg0 
     (filter not-procedure? args)))) %&\tfx\em{& syntaxe arg0 / arg1 / arg2… possible &}& 
\stoplily
Les paramètres \type{fmt} sont des chaînes de caractères qui pourront se servir des même séquences d'échappement que la fonction scheme \type{format}. Ainsi, par exemple, chaque apparition de \type{~a} dans \type{fmt0}, sera remplacée successivement par le paramètre \type{arg0, arg1, arg2 …}, préalablement converti en chaîne de caractères.\\ 
En voici quelques utilisations possibles :
\page %%%%%%%%%%%%%%%%%%%%%
%\blank
→ Copier une même nuance à plusieurs endroits
\godown[0.4em]
\startmylily 
(map (set-dyn "(~a 4 8) f") '(13 28 42 55))
\stopmylily
\godown[0.4em]
On notera que cette instruction retourne une liste de chaînes de caractères, donc en principe, pour pouvoir l'inclure comme argument dans \type{assoc-pos-dyn}, il faudrait préalablement regrouper en une seule chaîne de caractères, chaque élément de la liste obtenue, avec une barre oblique~\type{/} en guise de séparateur. Dans la pratique, \type{assoc-pos-dyn} nous évite ce travail en effectuant elle-même ce formatage quand un argument est une liste.

L'instruction :
\startmylily
assocDynList = #(assoc-pos-dyn
  (map (set-dyn "(~a 4 8) f") '(13 28 42 55)) instrus
  …)
\stopmylily
est donc équivalente à :
\startmylily
assocDynList = #(assoc-pos-dyn
  "(13 4 8) f / (28 4 8) f / (42 4 8) f / (55 4 8) f" instrus
  …)
\stopmylily
On peut cependant obtenir le même résultat en utilisant uniquement les séquences d'échappement de la fonction \type{format} :
\startmylily 
((set-dyn "~@{~}" "(~a 4 8) f~^ / ") 13 28 42 55)
\stopmylily
La séquence \type{~@{~}} permet de boucler l'instruction qui suit jusqu'à épuisement des paramètres, et la séquence \type{~^} de ne pas rajouter la barre oblique \type{/} quand le dernier paramètre est atteint.\\
Il est alors facile d'automatiser les choses par une fonction \type{x-dyn} par exemple :
\startmylily
#(define (x-dyn fmt) (set-dyn "~@{~}" (string-append fmt "~^ / ")))
\stopmylily
L'utilisation de cette fonction est basique :
\startmylily
((x-dyn "(~a 4 8) f") 13 28 42 55)
\stopmylily
\blank
→ Copier un groupe de nuances au sein d'une même mesure\\
On utilise ici une autre séquence d'échappement \type{~:*} qui permet de revenir au paramètre précédent.
\blank[0.5em]
\startmylily
#(define fmt<> "(~a 8) < / (~:*~a 4 16) > / (~:*~a 2 16) !")
#(define dyn<> (set-dyn fmt<>))
assocDynList = #(assoc-pos-dyn
  (dyn<> 45) '(instru1 instru2)
  (map dyn<> '(47 49)) 'instru3
  …)
\stopmylily
qui produit :
\startmylily
assocDynList = #(assoc-pos-dyn
  "(45 8) < / (45 4 16) > / (45 2 16) !" '(instru1 instru2)
  "(47 8) < / (47 4 16) > / (47 2 16) ! / 
   (49 8) < / (49 4 16) > / (49 2 16) !" 'instru3
  …)
\stopmylily
Le même \quote{pattern} \type{fmt<>} peut également être utilisé avec la fonction \type{x-dyn} précédente. Le résultat sera identique mais la syntaxe légèrement différente :
\blank[0.5em]
\startmylily
#(define dyn<> (x-dyn fmt<>))
assocDynList = #(assoc-pos-dyn
  (dyn<> 45) '(instru1 instru2)
  (dyn<> 47 49) 'instru3
  …)
\stopmylily
\blank
→ Copier un groupe de nuances s'étendant sur plusieurs mesures\\
\blank[0.4em]
On a rajouté ici une barre oblique \type{/} pour séparer les arguments par groupe de 3 :
\blank[0.5em]
\startmylily
#(define dyn<> (x-dyn "~a < / ~a > / ~a !"))
assocDynList = #(assoc-pos-dyn
  (dyn<> 1 7 10 / '(11 4) '(13 8 16) '(17 8))) 'instru
  …)
\stopmylily
\page %%%%%%%%%%%%%%%%%%%%
Le code produit :
\startmylily
assocDynList = #(assoc-pos-dyn
  "1 < / 7 > / 10 ! / (11 4) < / (13 8 16) > / (17 8) !" 'instru
  …)
\stopmylily
\index{list-offset}
La definition de \type{dyn<>} créant un soufflet, est ici la plus générique possible.\\
Cependant, si dans un morceau, des séquences de nuances sont séparées à chaque fois, d'un nombre de mesures identique (par exemple, un crescendo~\type{<} suivi, 2 mesures après, d'un decrescendo \type{>} se terminant à une 3\high{ème} mesure), l'utilisation de la fonction suivante peut s'avérer judicieuse :
\startmylily
#(define (bar-offset bar-numbers offsets)
   "(bar-offset '(b1 b2...bi) '(o1 o2 ...oj)) renvoie la liste :
     b1 + o1, b1 + o2,...b1 + oj, b2 + o1, b2 + o2,...b2 + oj ... bi + oj"
  (fold-right
    (lambda(b prev1)
      (fold-right
        (lambda(o prev2) (cons (+ b o) prev2))
        prev1
        offsets))
    '()
    bar-numbers))
\stopmylily
Une fonction \type{dyn<>} pourra alors être définie par :
\startmylily
#(define (dyn<> . bar-nums )
   (apply (x-dyn "~a < / (~a 8) > / (~a 4 16) !")
          (bar-offset bar-nums '(0 2 3))))
\stopmylily
À l'intérieur d'un code \type{assocDynList}, la simple ligne : 
\startmylily "(dyn<> 5 11 20)" 'instru \stopmylily
sera équivalent à tout le code suivant :
\startmylily 
"5  < / (7  8) > / (8  4 16) ! /
 11 < / (13 8) > / (14 4 16) ! /
 20 < / (22 8) > / (23 4 16) !" 'instru
\stopmylily
\blank[1.8em]

\index{def-dyn}
{\bf-} Sur un grand projet, la définition de \type{assocDynList} peut s'avérer conséquente et les définitions de nos fonctions peuvent se trouver fort éloignées dans le fichier, de l'endroit où elles sont utilisées dans \type{assocDynList}. Il est néanmoins possible de définir des objets à l'intérieur même des arguments de la fonction \type{assoc-pos-dyn}, par la macro \type{def-dyn} suivante :
\startlily
#(define-macro (def-dyn dyn arg) `(begin (define ,dyn ,arg) /))
\stoplily
On peut l'utiliser de la manière suivante :
\startmylily
assocDynList = #(assoc-pos-dyn
  ...
  (def-dyn dyn1 (x-dyn "~a p < / ~a f"))
  (dyn1 5 6 / 9 10) 'instru1
  ...
  (def-dyn dyn2 (set-dyn "(7 2. 16) ~asf"))
  (dyn2 "^") 'instru1
  (dyn2 "_") 'instru2
  ...
)
\stopmylily
\blank[1.8em]
D'autre macros peuvent être définies mais à l'instar de \type{def-dyn}, elles devront toutes avoir comme valeur de retour, la fonction scheme \type{/} (division de nombres). \type{assoc-pos-dyn} en effet, supprime automatiquement un tel élément de la liste donnée en argument.\\
\blank
Voici quelques autres exemples de macros.\\
\blank
\index{def-dyn\textplus txt}
\index{def-txt\textplus dyn}
Les 2 macros \type{def-dyn+txt} et \type{def-txt+dyn} suivantes, permettent de créer des nuances composées telles \type{p sub} ou \type{molto f}.\\
Elles prennent 2 arguments de type {\em chaîne de caractères}. Le nom de la nuance est concaténée à partir de ces 2 arguments : \type{psub} et \type{moltof}.\\

\startlily
#(define-macro (def-dyn+txt dyn txt)   ;&\em{& (def-dyn+txt "p" "sub") => psub &}&
`(let ((sym (string->symbol (string-append ,dyn ,txt))))
   (ly:parser-define! sym (make-dynamic-script (markup
                            #:dynamic ,dyn
                            #:normal-text #:italic ,txt)))
   /))

#(define-macro (def-txt+dyn txt dyn) ;&\em{& (def-txt+dyn "molto" "f") => moltof&}&
`(let ((sym (string->symbol (string-append ,dyn ,txt))))
   (ly:parser-define! sym (make-dynamic-script (markup
                            #:normal-text #:italic ,txt
                            #:dynamic ,dyn)))
   /))
\stoplily
\blank[1.8em]

\index{def-span-dyn}
La macro \type{def-span-dyn} permet ici de créer des nuances avec des lignes d'extensions.\\
Le 1\high{er} argument de type {\em symbol} permet de définir le nom de la nouvelle nuance.\\
Le 2\high{nd} argument de type {\em chaîne de caractères} est le texte à afficher par la nuance.\\
Si le 1\high{er} argument est omis, le nom de la nuance est formé à partir de la {\em chaîne de caractères}, en n'y gardant que les lettres.

\startlily
&\em{&% pré-fonction &}&
#(define (def-span-dyn-generic sym txt)
     (ly:parser-define! sym (make-music 'CrescendoEvent
       'span-direction START 'span-type 'text 'span-text txt))
     /)
&\em{&% la macro &}&
#(define-macro (def-span-dyn txt . args)
`(if (and (pair? (list ,@args)) (symbol? ,txt))
   (apply def-span-dyn-generic (list ,txt ,@args))
   (let ((sym (string->symbol (string-filter ,txt char-set:letter))))
     (def-span-dyn-generic sym ,txt))))

                           &\em{&%%%%%%%%%%%%%%%%%&}&
global = s1*3
music = { \repeat unfold 16 c8 c1 }

#(init '(instru))
#(rm 'instru 1 (rel 1 music))

assocDynList = #(assoc-pos-dyn
  (def-span-dyn 'crescspace " ")
  (def-span-dyn "cresc. molto")
    "1 pp crescspace / 2 crescmolto / 3 ff" 'instru
)

\new Staff $(sim global instru (add-dyn 'instru))
\stoplily
\midaligned{\externalfigure[macro-spanner-dyn.pdf][wfactor=300]}
%\midaligned{\underbar{\sc\Words exemple 11}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\title[index]{INDEX}
\placeindex[level=title]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\stoptext
